This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
eslint.config.js
index.html
package.json
public/vite.svg
README.md
robynne-o-HOrhCnQsxnQ-unsplash.jpg
src/App.css
src/App.jsx
src/assets/react.svg
src/Auth.css
src/components/BarChartCard.jsx
src/components/Card.jsx
src/components/DashboardCard.jsx
src/components/DataTable.jsx
src/components/DonutProgress.jsx
src/components/EmptyState.jsx
src/components/FileUpload.jsx
src/components/IconPillButton.jsx
src/components/ImportPreviewTable.jsx
src/components/Layout.css
src/components/Layout.jsx
src/components/Navbar.jsx
src/components/NotificationBelll.jsx
src/components/PageHeader.jsx
src/components/Pagination.jsx
src/components/PieChartCard.jsx
src/components/PricingRequestForm.jsx
src/components/PricingRequestModal.jsx
src/components/ProtectedRoute.jsx
src/components/SearchInput.jsx
src/components/Sidebar.css
src/components/Sidebar.jsx
src/components/SparklineMini.jsx
src/components/StatCard.jsx
src/components/Toolbar.jsx
src/context/AuthContext.jsx
src/context/NotificationContext.jsx
src/context/ThemeContext.jsx
src/index.css
src/main.jsx
src/pages/accounts/AccountsInvoices.jsx
src/pages/accounts/AccountsNotes.jsx
src/pages/accounts/AccountsReports.jsx
src/pages/Admin.jsx
src/pages/admin/UserForm.jsx
src/pages/admin/Users.jsx
src/pages/AdminDocuments.jsx
src/pages/AdminPricing.jsx
src/pages/Alerts/MaterialAlerts.jsx
src/pages/Campaigns.jsx
src/pages/Chat.css
src/pages/ChatUI.jsx
src/pages/Dashboard.jsx
src/pages/dashboards/AccountsDashboard.jsx
src/pages/dashboards/AdminDashboard.jsx
src/pages/dashboards/AreaManagerDashboard.jsx
src/pages/dashboards/DashboardLayout.css
src/pages/dashboards/DealerDashboard.jsx
src/pages/dashboards/DealerStaffDashboard.jsx
src/pages/dashboards/FinanceAdminDashboard.jsx
src/pages/dashboards/InventoryDashboard.jsx
src/pages/dashboards/ManagerDashboard.css
src/pages/dashboards/ManagerDashboard.jsx
src/pages/dashboards/RegionalAdminDashboard.jsx
src/pages/dashboards/RegionalManagerDashboard.jsx
src/pages/dashboards/SuperAdminDashboard.jsx
src/pages/dashboards/TechnicalAdminDashboard.jsx
src/pages/dashboards/TerritoryManagerDashboard.jsx
src/pages/DealerChat.jsx
src/pages/Documents.jsx
src/pages/InvoiceDetail.jsx
src/pages/Invoices.jsx
src/pages/Login.jsx
src/pages/ManagerChat.jsx
src/pages/maps/RegionMaps.jsx
src/pages/Materials.jsx
src/pages/Materials/MaterialAnalytics.jsx
src/pages/Materials/MaterialImport.jsx
src/pages/orders/AdminOrders.jsx
src/pages/orders/CreateOrders.jsx
src/pages/orders/MyOrders.jsx
src/pages/OTPVerify.jsx
src/pages/payments/CreatePaymentRequest.jsx
src/pages/payments/DealerAdminPayments.jsx
src/pages/payments/FinancePendingPayments.jsx
src/pages/PricingApprovals.jsx
src/pages/Reports.jsx
src/pages/reports/AccountStatementReport.jsx
src/pages/reports/AdminSummary.jsx
src/pages/reports/ChartsBlock.jsx
src/pages/reports/CreditDebitNotes.jsx
src/pages/reports/DealerPerformance.jsx
src/pages/reports/DealerTable.jsx
src/pages/reports/FiltersBar.jsx
src/pages/reports/InvoiceRegister.jsx
src/pages/reports/KPISection.jsx
src/pages/reports/OutstandingReceivables.jsx
src/pages/reports/PendingApprovals.jsx
src/pages/reports/RegionalSalesSummary.jsx
src/pages/reports/TerritorySummary.jsx
src/pages/superadmin/Roles.jsx
src/pages/superadmin/Users.jsx
src/pages/technicaladmin/TechnicalAdmin.jsx
src/services/api.js
src/services/socket.js
src/theme.js
src/utils/formatters.js
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?


.github/instructions/kluster-code-verify.instructions.md
.kluster
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs['recommended-latest'],
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dealer-portal-react</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="README.md">
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is enabled on this template. See [this documentation](https://react.dev/learn/react-compiler) for more information.

Note: This will impact Vite dev & build performances.

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.
</file>

<file path="src/App.css">
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/Auth.css">
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(180deg, #8ec5fc 0%, #e0c3fc 100%);
  background-image: url('../assets/mountain-bg.jpg'); /* optional background image */
  background-size: cover;
  background-position: center;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.auth-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}

.auth-box {
  width: 380px;
  padding: 2rem 2.5rem;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  text-align: center;
  color: #fff;
}

h2 {
  margin-bottom: 1rem;
  letter-spacing: 1px;
}

.input-group {
  margin-bottom: 1rem;
}

input {
  width: 100%;
  padding: 10px 12px;
  border: none;
  border-radius: 8px;
  outline: none;
  background: rgba(255, 255, 255, 0.3);
  color: #fff;
  font-size: 14px;
}

input::placeholder {
  color: #e5e5e5;
}

.auth-btn {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #56ccf2, #2f80ed);
  color: white;
  cursor: pointer;
  transition: 0.3s ease;
}

.auth-btn:hover {
  transform: scale(1.03);
}

.extra-options {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  margin-bottom: 1rem;
}

a {
  color: #fff;
  text-decoration: underline;
  cursor: pointer;
}

.register-text {
  font-size: 13px;
  margin-top: 1rem;
}

.error-text {
  color: #ff5e5e;
  margin-bottom: 0.8rem;
}
</file>

<file path="src/components/BarChartCard.jsx">
import React from "react";
import { Card, CardContent, Typography } from "@mui/material";
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } from "recharts";

export default function BarChartCard({ title, data, xKey, yKey, color = "#1976d2" }) {
  return (
    <Card sx={{ borderRadius: 3, boxShadow: 2, p: 2 }}>
      <CardContent>
        <Typography variant="subtitle1" gutterBottom>{title}</Typography>
        <ResponsiveContainer width="100%" height={250}>
          <BarChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey={xKey} />
            <YAxis />
            <Tooltip />
            <Bar dataKey={yKey} fill={color} radius={[6, 6, 0, 0]} />
          </BarChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/Card.jsx">
import React from "react";

export default function Card({ title, children, footer, style }) {
  return (
    <div className="card" style={style}>
      {title && (
        <h3 style={{ marginTop: 0, marginBottom: "0.75rem" }}>{title}</h3>
      )}
      {children}
      {footer && <div style={{ marginTop: "0.75rem" }}>{footer}</div>}
    </div>
  );
}
</file>

<file path="src/components/DashboardCard.jsx">
import React from "react";
import { Card, CardContent, Typography, Box } from "@mui/material";

export default function DashboardCard({ title, value, icon, color = "primary.main" }) {
  return (
    <Card sx={{
      borderRadius: 3,
      boxShadow: 2,
      p: 2,
      backgroundColor: "background.paper",
      transition: "transform 0.2s ease",
      "&:hover": { transform: "translateY(-4px)", boxShadow: 4 },
    }}>
      <CardContent>
        <Box display="flex" alignItems="center" justifyContent="space-between">
          <Typography variant="subtitle2" color="text.secondary">
            {title}
          </Typography>
          <Box color={color}>{icon}</Box>
        </Box>
        <Typography variant="h5" sx={{ mt: 1, fontWeight: "bold" }}>
          {value}
        </Typography>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/DataTable.jsx">
import React from "react";

export default function DataTable({ columns, rows, emptyMessage = "No data available" }) {
  if (!rows || rows.length === 0) {
    return <p style={{ color: "#94a3b8" }}>{emptyMessage}</p>;
  }
  return (
    <div style={{ overflowX: "auto" }}>
      <table style={{ width: "100%", borderCollapse: "collapse" }}>
        <thead>
          <tr>
            {columns.map((c) => (
              <th key={c.key} style={{ textAlign: "left", padding: "0.6rem", borderBottom: "1px solid rgba(255,255,255,0.1)", color: "#cbd5e1", fontWeight: 600 }}>
                {c.label}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {rows.map((row, idx) => (
            <tr key={row.id || idx} style={{ background: idx % 2 === 1 ? "rgba(255,255,255,0.02)" : "transparent" }}>
              {columns.map((c) => (
                <td key={c.key} style={{ padding: "0.6rem", borderBottom: "1px solid rgba(255,255,255,0.06)" }}>
                  {typeof c.render === "function" ? c.render(row[c.key], row) : row[c.key]}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
</file>

<file path="src/components/EmptyState.jsx">
import React from "react";

export default function EmptyState({ icon = "üîç", title = "No data", description }) {
  return (
    <div style={{ textAlign: "center", padding: "1.5rem", color: "#94a3b8" }}>
      <div style={{ fontSize: "2rem" }}>{icon}</div>
      <div style={{ fontWeight: 600, marginTop: "0.25rem", color: "#cbd5e1" }}>{title}</div>
      {description && <div style={{ marginTop: "0.25rem" }}>{description}</div>}
    </div>
  );
}
</file>

<file path="src/components/ImportPreviewTable.jsx">
import React from 'react';

// Very small preview table used by MaterialImport page
export default function ImportPreviewTable({ rows = [], errors = {} }) {
  if (!rows || rows.length === 0) return <div style={{ color: '#666' }}>No preview available</div>;

  const headers = Object.keys(rows[0]);

  return (
    <div style={{ overflowX: 'auto' }}>
      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
        <thead>
          <tr>
            {headers.map((h) => (
              <th key={h} style={{ textAlign: 'left', padding: 8, borderBottom: '1px solid #eee' }}>{h}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {rows.map((r, i) => (
            <tr key={i} style={{ background: i % 2 ? 'transparent' : '#fafafa' }}>
              {headers.map((h) => (
                <td key={h} style={{ padding: 8, borderBottom: '1px solid #fff' }}>
                  <div>{String(r[h] ?? '')}</div>
                  {errors[i] && errors[i][h] && (
                    <div style={{ color: '#b91c1c', fontSize: 12 }}>{errors[i][h]}</div>
                  )}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
</file>

<file path="src/components/Layout.css">
/* ========== OVERALL LAYOUT ========== */
.app-layout {
  display: flex;
  height: 100vh;
  background: var(--bg-glow), var(--bg-base);
  color: var(--text-color);
  overflow: hidden;
}

/* ========== SIDEBAR ========== */
.app-layout aside {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  width: 240px;
  transition: width 0.3s ease;
  z-index: 1000;
}

/* ========== MAIN CONTENT AREA ========== */
.main-content {
  flex: 1;
  margin-left: 240px;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* ========== NAVBAR ========== */
.main-content nav {
  position: sticky;
  top: 0;
  z-index: 100;
}

/* ========== MAIN PAGE CONTENT ========== */
.page-content {
  flex: 1;
  overflow-y: auto;
  padding: 2rem;
  background: var(--bg-base);
}

/* ========== CONTENT WRAPPER (DASHBOARDS) ========== */
.content-wrapper {
  background: var(--card-bg);
  border-radius: 20px;
  border: 1px solid var(--card-border);
  padding: 2rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(12px);
  min-height: calc(100vh - 110px); /* adjusts for navbar height */
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
  .app-layout aside {
    width: 70px;
  }

  .main-content {
    margin-left: 70px;
  }
}
</file>

<file path="src/components/NotificationBelll.jsx">
import React, { useState } from "react";
import { IconButton, Badge, Menu, MenuItem, Typography } from "@mui/material";
import NotificationsIcon from "@mui/icons-material/Notifications";
import { useNotifications } from "../context/NotificationContext";

export default function NotificationBell() {
  const { notifications, unread, markAllAsRead } = useNotifications();
  const [anchorEl, setAnchorEl] = useState(null);

  const handleOpen = (e) => setAnchorEl(e.currentTarget);
  const handleClose = () => setAnchorEl(null);

  return (
    <>
      <IconButton color="inherit" onClick={handleOpen}>
        <Badge badgeContent={unread} color="error">
          <NotificationsIcon />
        </Badge>
      </IconButton>

      <Menu
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={handleClose}
        sx={{ mt: 1 }}
      >
        <MenuItem onClick={markAllAsRead}>
          <Typography variant="body2" color="primary">
            Mark all as read
          </Typography>
        </MenuItem>
        {notifications.length > 0 ? (
          notifications.slice(0, 8).map((n, idx) => (
            <MenuItem key={idx} onClick={handleClose} dense>
              <div>
                <Typography
                  variant="subtitle2"
                  fontWeight={!n.isRead ? "bold" : "normal"}
                >
                  {n.title}
                </Typography>
                <Typography
                  variant="body2"
                  color="text.secondary"
                  sx={{ whiteSpace: "normal" }}
                >
                  {n.message}
                </Typography>
              </div>
            </MenuItem>
          ))
        ) : (
          <MenuItem disabled>No notifications</MenuItem>
        )}
      </Menu>
    </>
  );
}
</file>

<file path="src/components/PricingRequestForm.jsx">
import React, { useState, useEffect } from "react";
import api from "../services/api";
import { toast } from "react-toastify";

export default function PricingRequestForm({ onClose }) {
  const [products, setProducts] = useState([]);
  const [productId, setProductId] = useState("");
  const [oldPrice, setOldPrice] = useState(0);
  const [newPrice, setNewPrice] = useState("");
  const [reason, setReason] = useState("");
  const [loading, setLoading] = useState(false);

  // Load all products
  useEffect(() => {
    const loadProducts = async () => {
      try {
        const res = await api.get("/products");
        setProducts(res.data.products || []);
      } catch (err) {
        console.error("Failed to load products‚Ä¶", err);
      }
    };

    loadProducts();
  }, []);

  // When product changes, auto-load old price
  useEffect(() => {
    if (!productId) return;

    const p = products.find((x) => x.id === parseInt(productId));
    if (p) setOldPrice(p.price || 0);
  }, [productId, products]);

  const submitRequest = async (e) => {
    e.preventDefault();

    if (!productId || !newPrice || !reason) {
      toast.error("Please fill all fields");
      return;
    }

    try {
      setLoading(true);
      await api.post("/pricing", {
        productId,
        oldPrice,
        newPrice,
        reason,
      });

      toast.success("‚úÖ Pricing request submitted");
      onClose();
    } catch (err) {
      console.error(err);
      toast.error("Failed to submit request");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ padding: 20 }}>
      <h2 style={{ marginBottom: 15 }}>Request Pricing Change</h2>

      {/* Product Select */}
      <label>Product</label>
      <select
        value={productId}
        onChange={(e) => setProductId(e.target.value)}
        style={{ width: "100%", padding: 8, marginBottom: 10 }}
      >
        <option value="">Select a product</option>
        {products.map((p) => (
          <option key={p.id} value={p.id}>
            {p.name}
          </option>
        ))}
      </select>

      {/* Old Price */}
      <label>Current Price</label>
      <input
        type="text"
        value={oldPrice}
        disabled
        style={{ width: "100%", padding: 8, marginBottom: 10, background: "#f3f4f6" }}
      />

      {/* New Price */}
      <label>Requested New Price</label>
      <input
        type="number"
        value={newPrice}
        onChange={(e) => setNewPrice(e.target.value)}
        style={{ width: "100%", padding: 8, marginBottom: 10 }}
      />

      {/* Reason */}
      <label>Reason</label>
      <textarea
        value={reason}
        onChange={(e) => setReason(e.target.value)}
        rows={4}
        style={{ width: "100%", padding: 8, marginBottom: 15 }}
      />

      {/* Buttons */}
      <div style={{ display: "flex", justifyContent: "flex-end", gap: 10 }}>
        <button
          onClick={onClose}
          style={{ padding: "8px 12px", background: "#e5e7eb", borderRadius: 6 }}
        >
          Cancel
        </button>
        <button
          onClick={submitRequest}
          disabled={loading}
          style={{ padding: "8px 12px", background: "#3b82f6", color: "#fff", borderRadius: 6 }}
        >
          {loading ? "Submitting..." : "Submit Request"}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/PricingRequestModal.jsx">
import React, { useState, useEffect } from "react";
import api from "../services/api";
//import "./Modal.css"; // optional styling

export default function PricingRequestModal({ open, onClose }) {
  const [products, setProducts] = useState([]);
  const [productId, setProductId] = useState("");
  const [newPrice, setNewPrice] = useState("");
  const [reason, setReason] = useState("");
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (open) {
      (async () => {
        try {
          const res = await api.get("/products");
          setProducts(res.data.products || res.data);
        } catch (e) {
          console.error("Failed to fetch products", e);
        }
      })();
    }
  }, [open]);

  const handleSubmit = async () => {
    if (!productId || !newPrice) {
      alert("Please select a product and enter new price");
      return;
    }

    setLoading(true);
    try {
      const selected = products.find((p) => p.id === Number(productId));
      await api.post("/pricing/request", {
        productId,
        oldPrice: selected?.price,
        newPrice,
        reason,
      });
      alert("‚úÖ Pricing request submitted successfully!");
      onClose();
    } catch (e) {
      console.error(e);
      alert("‚ùå Failed to submit request");
    } finally {
      setLoading(false);
    }
  };

  if (!open) return null;

  return (
    <div className="modal-overlay">
      <div className="modal">
        <h2>Request Price Change</h2>

        <label>Product</label>
        <select
          value={productId}
          onChange={(e) => setProductId(e.target.value)}
        >
          <option value="">Select a product</option>
          {products.map((p) => (
            <option key={p.id} value={p.id}>
              {p.name} ‚Äî ‚Çπ{p.price}
            </option>
          ))}
        </select>

        <label>New Price</label>
        <input
          type="number"
          placeholder="Enter new price"
          value={newPrice}
          onChange={(e) => setNewPrice(e.target.value)}
        />

        <label>Reason</label>
        <textarea
          placeholder="Explain reason for price change..."
          value={reason}
          onChange={(e) => setReason(e.target.value)}
        />

        <div className="modal-actions">
          <button onClick={handleSubmit} disabled={loading} className="btn-success">
            {loading ? "Submitting..." : "Submit"}
          </button>
          <button onClick={onClose} className="btn-danger">
            Cancel
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/SearchInput.jsx">
import React from "react";

export default function SearchInput({ placeholder = "Search", value, onChange, style }) {
  return (
    <div
      style={{
        display: "flex",
        alignItems: "center",
        gap: "0.5rem",
        padding: "0.6rem 0.9rem",
        borderRadius: 9999,
        background: "rgba(255,255,255,0.06)",
        border: "1px solid rgba(255,255,255,0.08)",
        boxShadow: "inset 0 0 10px rgba(0,0,0,0.2)",
        color: "#cbd5e1",
        ...style,
      }}
    >
      <span style={{ opacity: 0.8 }}>üîé</span>
      <input
        value={value}
        onChange={onChange}
        placeholder={placeholder}
        style={{
          outline: "none",
          border: "none",
          background: "transparent",
          color: "#e2e8f0",
          width: "100%",
        }}
      />
    </div>
  );
}
</file>

<file path="src/components/Sidebar.css">
.sidebar {
  width: 240px;
  height: 100vh;
  padding: 1.5rem 1rem;
  background: var(--sidebar-bg, var(--card-bg));
  border-right: 1px solid var(--card-border);
  display: flex;
  flex-direction: column;
  position: fixed;
  left: 0;
  top: 0;
}

.sidebar-header {
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--card-border);
  margin-bottom: 1.25rem;
  text-align: center;
}

.sidebar-header h3 {
  color: var(--accent);
  font-weight: 700;
  letter-spacing: 0.5px;
}

/* ‚úÖ Navigation */
.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

/* ‚úÖ Clean nav item */
.sidebar-link {
  display: block;
  padding: 0.7rem 1rem;
  margin: 0.1rem 0;
  border-radius: 0.6rem;
  color: var(--text-color);
  text-decoration: none;
  font-weight: 500;
  transition: background 0.2s ease, color 0.2s ease;
}

/* ‚úÖ Hover */
.sidebar-link:hover {
  background: var(--hover-bg);
  color: var(--accent);
}

/* ‚úÖ Active item */
.sidebar-link.active {
  background: var(--accent-bg);
  color: var(--accent);
  font-weight: 600;
}

/* ‚úÖ Light/Dark Theme Variables */
:root {
  /* Light theme */
  --sidebar-bg: #f8f9fc;
  --card-bg: #ffffff;
  --card-border: #e5e7eb;
  --hover-bg: #f3f4f6;
  --accent: #f97316;
  --accent-bg: rgba(249, 115, 22, 0.15);
  --text-color: #111827;
}

[data-theme="dark"] {
  --sidebar-bg: #0f0f11;
  --card-bg: #1a1a1c;
  --card-border: #2c2c2f;
  --hover-bg: rgba(255, 255, 255, 0.06);
  --accent-bg: rgba(249, 115, 22, 0.18);
  --text-color: #e5e7eb;
}
</file>

<file path="src/components/Toolbar.jsx">
import React from "react";

export default function Toolbar({ children, right }) {
  return (
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: "1rem", marginBottom: "0.75rem" }}>
      <div style={{ display: "flex", gap: "0.5rem", alignItems: "center" }}>{children}</div>
      {right && <div style={{ display: "flex", gap: "0.5rem" }}>{right}</div>}
    </div>
  );
}
</file>

<file path="src/context/NotificationContext.jsx">
import React, { createContext, useState, useEffect, useContext } from "react";
import socket from "../services/socket";
import api from "../services/api";
import { toast } from "react-toastify";
import { AuthContext } from "./AuthContext"; // ‚úÖ ensure AuthContext exists

export const NotificationContext = createContext();

export const NotificationProvider = ({ children }) => {
  const { user } = useContext(AuthContext);
  const [notifications, setNotifications] = useState([]);
  const [unread, setUnread] = useState(0);

  useEffect(() => {
    if (!user) return;

    // 1Ô∏è‚É£ Fetch saved notifications from backend
    const fetchNotifications = async () => {
      try {
        const res = await api.get("/notifications");
        setNotifications(res.data.notifications || []);
        setUnread(res.data.notifications.filter((n) => !n.isRead).length);
      } catch (err) {
        console.error("Failed to fetch notifications", err);
      }
    };
    fetchNotifications();

    // 2Ô∏è‚É£ Authenticate socket
    socket.emit("authenticate", { userId: user.id, role: user.role });

    // 3Ô∏è‚É£ Listen for real-time notifications
    socket.on("notification", (data) => {
      toast.info(`${data.title}: ${data.message}`);
      setNotifications((prev) => [data, ...prev]);
      setUnread((prev) => prev + 1);
    });

    return () => socket.off("notification");
  }, [user]);

  const markAllAsRead = async () => {
    try {
      await api.patch("/notifications/read-all");
      setUnread(0);
      setNotifications((prev) =>
        prev.map((n) => ({ ...n, isRead: true }))
      );
    } catch (err) {
      console.error("Failed to mark notifications read", err);
    }
  };

  return (
    <NotificationContext.Provider value={{ notifications, unread, markAllAsRead }}>
      {children}
    </NotificationContext.Provider>
  );
};

export const useNotifications = () => useContext(NotificationContext);
</file>

<file path="src/context/ThemeContext.jsx">
import React, { createContext, useContext, useEffect, useMemo, useState } from "react";

const ThemeModeContext = createContext({ mode: "dark", toggle: () => {} });

export function ThemeModeProvider({ children }) {
  const [mode, setMode] = useState(() => localStorage.getItem("ui-mode") || "dark");

  useEffect(() => {
    localStorage.setItem("ui-mode", mode);
    document.documentElement.setAttribute("data-theme", mode);
  }, [mode]);

  const value = useMemo(() => ({ mode, toggle: () => setMode((m) => (m === "dark" ? "light" : "dark")) }), [mode]);

  return <ThemeModeContext.Provider value={value}>{children}</ThemeModeContext.Provider>;
}

export function useThemeMode() {
  return useContext(ThemeModeContext);
}
</file>

<file path="src/pages/accounts/AccountsInvoices.jsx">
import React, { useEffect, useState } from "react";
import api from "../../services/api";
import Card from "../../components/Card";
import DataTable from "../../components/DataTable";

export default function AccountsInvoices() {
  const [invoices, setInvoices] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        const res = await api.get("/accounts/invoices");
        setInvoices(res.data.invoices || []);
      } catch (err) {
        console.error("Failed to load invoices:", err);
      }
    })();
  }, []);

  return (
    <div style={{ padding: "2rem" }}>
      <h1>üßæ All Invoices</h1>
      <Card>
        <DataTable
          columns={[
            { key: "invoiceNumber", label: "Invoice #" },
            { key: "invoiceDate", label: "Date" },
            { key: "totalAmount", label: "Total (‚Çπ)" },
            { key: "paidAmount", label: "Paid (‚Çπ)" },
            { key: "status", label: "Status" },
          ]}
          rows={invoices.map((inv) => ({
            id: inv.id,
            invoiceNumber: inv.invoiceNumber,
            invoiceDate: new Date(inv.invoiceDate).toLocaleDateString(),
            totalAmount: inv.totalAmount,
            paidAmount: inv.paidAmount,
            status: inv.status,
          }))}
          emptyMessage="No invoices found"
        />
      </Card>
    </div>
  );
}
</file>

<file path="src/pages/accounts/AccountsNotes.jsx">
import React, { useEffect, useState } from "react";
import api from "../../services/api";
import Card from "../../components/Card";
import DataTable from "../../components/DataTable";

export default function AccountsNotes() {
  const [notes, setNotes] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        const res = await api.get("/accounts/notes");
        setNotes(res.data.notes || []);
      } catch (err) {
        console.error("Failed to load credit/debit notes:", err);
      }
    })();
  }, []);

  return (
    <div style={{ padding: "2rem" }}>
      <h1>üíº Credit & Debit Notes</h1>
      <Card>
        <DataTable
          columns={[
            { key: "noteNumber", label: "Note #" },
            { key: "noteType", label: "Type" },
            { key: "noteDate", label: "Date" },
            { key: "amount", label: "Amount (‚Çπ)" },
            { key: "status", label: "Status" },
          ]}
          rows={notes.map((n) => ({
            id: n.id,
            noteNumber: n.noteNumber,
            noteType: n.noteType,
            noteDate: new Date(n.noteDate).toLocaleDateString(),
            amount: n.amount,
            status: n.status,
          }))}
          emptyMessage="No credit/debit notes available"
        />
      </Card>
    </div>
  );
}
</file>

<file path="src/pages/accounts/AccountsReports.jsx">
import React, { useEffect, useState } from "react";
import api from "../../services/api";
import Card from "../../components/Card";
import {
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,
} from "recharts";

export default function AccountsReports() {
  const [report, setReport] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        const res = await api.get("/accounts/dealer-reports");
        setReport(res.data.dealers || []);
      } catch (err) {
        console.error("Failed to load dealer reports:", err);
      }
    })();
  }, []);

  return (
    <div style={{ padding: "2rem" }}>
      <h1>üìä Dealer Financial Reports</h1>
      <Card>
        <ResponsiveContainer width="100%" height={350}>
          <BarChart data={report}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="dealer" />
            <YAxis />
            <Tooltip />
            <Bar dataKey="sales" fill="#3b82f6" name="Sales" />
            <Bar dataKey="paid" fill="#22c55e" name="Paid" />
          </BarChart>
        </ResponsiveContainer>
      </Card>
    </div>
  );
}
</file>

<file path="src/pages/admin/UserForm.jsx">
import React, { useState, useEffect } from "react";
import api from "../../services/api";

export default function UserForm({ onClose, reload, userData, roles }) {
  const [form, setForm] = useState({
    username: "",
    email: "",
    password: "",
    roleId: "",
    dealerId: "",
    regionId: "",
  });

  const [dealers, setDealers] = useState([]);
  const [regions, setRegions] = useState([]);

  const isEdit = !!userData;

  useEffect(() => {
    async function fetchDropdowns() {
      const d = await api.get("/dealers");
      const r = await api.get("/regions");

      setDealers(d.data);
      setRegions(r.data);
    }
    fetchDropdowns();

    if (isEdit) {
      setForm({
        username: userData.username,
        email: userData.email,
        password: "",
        roleId: userData.roleId,
        dealerId: userData.dealerId || "",
        regionId: userData.regionId || "",
      });
    }
  }, [userData]);

  const handleSubmit = async (e) => {
    e.preventDefault();

    try {
      if (isEdit) {
        await api.put(`/admin/users/${userData.id}`, form);
      } else {
        await api.post("/admin/users", form);
      }

      reload();
      onClose();
    } catch (err) {
      console.error("Save failed:", err);
    }
  };

  return (
    <div
      style={{
        position: "fixed",
        inset: 0,
        background: "rgba(0,0,0,0.5)",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
      }}
    >
      <form
        onSubmit={handleSubmit}
        style={{
          background: "white",
          padding: "2rem",
          borderRadius: "12px",
          width: "420px",
          display: "flex",
          flexDirection: "column",
          gap: "1rem",
        }}
      >
        <h2>{isEdit ? "Edit User" : "Add User"}</h2>

        <input
          placeholder="Username"
          value={form.username}
          onChange={(e) => setForm({ ...form, username: e.target.value })}
        />

        <input
          placeholder="Email"
          value={form.email}
          onChange={(e) => setForm({ ...form, email: e.target.value })}
        />

        {!isEdit && (
          <input
            placeholder="Password"
            type="password"
            value={form.password}
            onChange={(e) => setForm({ ...form, password: e.target.value })}
          />
        )}

        {/* Roles */}
        <select
          value={form.roleId}
          onChange={(e) => setForm({ ...form, roleId: e.target.value })}
        >
          <option value="">Select Role</option>
          {roles.map((r) => (
            <option key={r.id} value={r.id}>
              {r.name}
            </option>
          ))}
        </select>

        {/* Dealers */}
        <select
          value={form.dealerId}
          onChange={(e) => setForm({ ...form, dealerId: e.target.value })}
        >
          <option value="">Assign Dealer (Optional)</option>
          {dealers.map((d) => (
            <option key={d.id} value={d.id}>
              {d.businessName}
            </option>
          ))}
        </select>

        {/* Regions */}
        <select
          value={form.regionId}
          onChange={(e) => setForm({ ...form, regionId: e.target.value })}
        >
          <option value="">Assign Region (Optional)</option>
          {regions.map((r) => (
            <option key={r.id} value={r.id}>
              {r.name}
            </option>
          ))}
        </select>

        <button
          type="submit"
          style={{
            padding: "0.8rem",
            background: "#f97316",
            color: "white",
            border: "none",
            borderRadius: "6px",
          }}
        >
          Save
        </button>

        <button
          onClick={onClose}
          type="button"
          style={{
            marginTop: "0.5rem",
            background: "transparent",
            border: "1px solid #aaa",
            padding: "0.6rem",
            borderRadius: "6px",
          }}
        >
          Cancel
        </button>
      </form>
    </div>
  );
}
</file>

<file path="src/pages/admin/Users.jsx">
import React, { useEffect, useState } from "react";
import api from "../../services/api";
import UserForm from "./UserForm";

export default function Users() {
  const [users, setUsers] = useState([]);
  const [roles, setRoles] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [selectedRole, setSelectedRole] = useState("");
  const [modalOpen, setModalOpen] = useState(false);
  const [editUser, setEditUser] = useState(null);

  // Load users + roles
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const u = await api.get("/admin/users");
      const r = await api.get("/roles");

      setUsers(u.data);
      setRoles(r.data);
    } catch (err) {
      console.error("Failed loading users:", err);
    } finally {
      setLoading(false);
    }
  };

  // DELETE USER
  const handleDelete = async (id) => {
    if (!window.confirm("Are you sure you want to delete this user?")) return;

    try {
      await api.delete(`/admin/users/${id}`);
      loadData();
    } catch (err) {
      console.error("Delete failed:", err);
    }
  };

  const filteredUsers = users.filter((u) => {
    const matchSearch =
      u.username.toLowerCase().includes(search.toLowerCase()) ||
      u.email.toLowerCase().includes(search.toLowerCase());

    const matchRole = selectedRole ? u.role?.toLowerCase() === selectedRole : true;

    return matchSearch && matchRole;
  });

  if (loading) return <p>Loading users...</p>;

  return (
    <div style={{ padding: "2rem" }}>
      <div style={{ display: "flex", justifyContent: "space-between" }}>
        <h1 style={{ marginBottom: "1rem" }}>Users</h1>
        <button
          onClick={() => {
            setEditUser(null);
            setModalOpen(true);
          }}
          style={{
            padding: "0.6rem 1.2rem",
            background: "#f97316",
            color: "#fff",
            border: "none",
            borderRadius: "8px",
            cursor: "pointer",
          }}
        >
          + Add User
        </button>
      </div>

      {/* Search + Filter */}
      <div style={{ display: "flex", gap: "1rem", marginBottom: "1.5rem" }}>
        <input
          placeholder="Search by username or email..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          style={{
            padding: "0.6rem 1rem",
            borderRadius: "8px",
            border: "1px solid var(--card-border)",
            width: "300px",
          }}
        />

        <select
          value={selectedRole}
          onChange={(e) => setSelectedRole(e.target.value)}
          style={{
            padding: "0.6rem",
            borderRadius: "8px",
            border: "1px solid var(--card-border)",
          }}
        >
          <option value="">All Roles</option>
          {roles.map((r) => (
            <option key={r.id} value={r.name.toLowerCase()}>
              {r.name}
            </option>
          ))}
        </select>
      </div>

      {/* Users Table */}
      <table style={{ width: "100%", borderCollapse: "collapse" }}>
        <thead>
          <tr style={{ borderBottom: "1px solid var(--card-border)" }}>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Dealer</th>
            <th>Region</th>
            <th style={{ textAlign: "right" }}>Actions</th>
          </tr>
        </thead>

        <tbody>
          {filteredUsers.map((u) => (
            <tr key={u.id} style={{ borderBottom: "1px solid var(--card-border)" }}>
              <td>{u.username}</td>
              <td>{u.email}</td>
              <td>{u.role || "‚Äî"}</td>
              <td>{u.dealer?.businessName || "‚Äî"}</td>
              <td>{u.region?.name || "‚Äî"}</td>

              <td style={{ textAlign: "right" }}>
                <button
                  onClick={() => {
                    setEditUser(u);
                    setModalOpen(true);
                  }}
                  style={{
                    marginRight: "10px",
                    background: "#3b82f6",
                    color: "#fff",
                    padding: "0.4rem 0.8rem",
                    border: "none",
                    borderRadius: "6px",
                    cursor: "pointer",
                  }}
                >
                  Edit
                </button>

                <button
                  onClick={() => handleDelete(u.id)}
                  style={{
                    background: "#ef4444",
                    color: "#fff",
                    padding: "0.4rem 0.8rem",
                    border: "none",
                    borderRadius: "6px",
                    cursor: "pointer",
                  }}
                >
                  Delete
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>

      {/* MODAL */}
      {modalOpen && (
        <UserForm
          onClose={() => setModalOpen(false)}
          reload={loadData}
          roles={roles}
          userData={editUser}
        />
      )}
    </div>
  );
}
</file>

<file path="src/pages/AdminPricing.jsx">
// ==============================
// FILE: src/pages/admin/AdminPricing.jsx
// ‚úÖ Full Admin Pricing Approval Panel
// ==============================

import React, { useEffect, useState } from "react";
import api from "../../services/api";
import { toast } from "react-toastify";
import Card from "../../components/Card";
import IconPillButton from "../../components/IconPillButton";
import SearchInput from "../../components/SearchInput";
import Toolbar from "../../components/Toolbar";
import "./AdminDashboard.css";

export default function AdminPricing() {
  const [requests, setRequests] = useState([]);
  const [search, setSearch] = useState("");
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState("pending");

  // Load all pricing requests
  const loadRequests = async () => {
    try {
      setLoading(true);
      const res = await api.get("/pricing", { params: { all: true } });
      setRequests(res.data.updates || []);
    } catch (err) {
      console.error(err);
      toast.error("Failed to load requests");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadRequests();
  }, []);

  // Approve
  const approve = async (id) => {
    try {
      await api.put(`/pricing/${id}/approve`);
      toast.success("‚úÖ Request Approved");
      loadRequests();
    } catch (err) {
      toast.error("Failed to approve");
    }
  };

  // Reject
  const reject = async (id) => {
    const remarks = prompt("Enter rejection reason:");
    if (!remarks) return toast.error("Remarks required");

    try {
      await api.put(`/pricing/${id}/reject`, { remarks });
      toast.info("‚ùå Request Rejected");
      loadRequests();
    } catch (err) {
      toast.error("Failed to reject");
    }
  };

  const filtered = requests.filter((r) => {
    if (filter !== "all" && r.status !== filter) return false;
    if (search && !String(r.productId).toLowerCase().includes(search.toLowerCase())) return false;
    return true;
  });

  return (
    <div className="admin-container">
      <header className="admin-header">
        <h1>Pricing Approvals</h1>
      </header>

      {/* Toolbar */}
      <Toolbar
        left={[
          <SearchInput
            key="search"
            placeholder="Search by Product ID..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
          />,
        ]}
        right={[
          <IconPillButton icon="üîÑ" label="Refresh" onClick={loadRequests} />,
        ]}
      />

      {/* Filter */}
      <div style={{ display: "flex", gap: 10, margin: "15px 0" }}>
        {["all", "pending", "approved", "rejected"].map((s) => (
          <button
            key={s}
            onClick={() => setFilter(s)}
            style={{
              padding: "6px 12px",
              background: filter === s ? "#3b82f6" : "#e5e7eb",
              color: filter === s ? "#fff" : "#111",
              borderRadius: 6,
              border: "none",
            }}
          >
            {s.toUpperCase()}
          </button>
        ))}
      </div>

      <Card title="Pricing Requests Queue">
        {loading ? (
          <p>Loading...</p>
        ) : filtered.length ? (
          <table className="custom-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Product</th>
                <th>Old</th>
                <th>New</th>
                <th>Dealer</th>
                <th>Status</th>
                <th>Requested At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {filtered.map((r) => (
                <tr key={r.id}>
                  <td>{r.id}</td>
                  <td>{r.productId}</td>
                  <td>{r.oldPrice ?? "‚Äî"}</td>
                  <td>{r.newPrice}</td>
                  <td>{r.dealerName}</td>
                  <td>{r.status}</td>
                  <td>{new Date(r.createdAt).toLocaleDateString()}</td>
                  <td>
                    {r.status === "pending" && (
                      <>
                        <button
                          style={{ marginRight: 10, background: "#10b981", padding: "5px 8px", borderRadius: 5, color: "#fff" }}
                          onClick={() => approve(r.id)}
                        >
                          Approve
                        </button>

                        <button
                          style={{ background: "#ef4444", padding: "5px 8px", borderRadius: 5, color: "#fff" }}
                          onClick={() => reject(r.id)}
                        >
                          Reject
                        </button>
                      </>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        ) : (
          <p>No requests found.</p>
        )}
      </Card>
    </div>
  );
}
</file>

<file path="src/pages/Alerts/MaterialAlerts.jsx">
import React, { useEffect, useState } from 'react';
import api from '../../services/api';

export default function MaterialAlerts() {
  const [alerts, setAlerts] = useState({ reorderAlerts: [], expiryAlerts: [] });
  const [loading, setLoading] = useState(false);

  const loadAlerts = async () => {
    setLoading(true);
    try {
      const res = await api.get('/materials/alerts', { params: { days: 30 } });
      setAlerts({ reorderAlerts: res.data.reorderAlerts || [], expiryAlerts: res.data.expiryAlerts || [] });
    } catch (err) {
      console.error('Failed to fetch alerts', err);
      alert('Failed to fetch material alerts');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadAlerts();
  }, []);

  const acknowledge = async (type, id) => {
    try {
      await api.post(`/materials/alerts/${id}/acknowledge`, { type });
      loadAlerts();
    } catch (err) {
      console.error('Ack failed', err);
      alert('Failed to acknowledge');
    }
  };

  return (
    <div style={{ padding: 20 }}>
      <h2>Material Alerts</h2>

      <section style={{ marginTop: 12 }}>
        <h4>Reorder Alerts</h4>
        {alerts.reorderAlerts.length === 0 && <div>No reorder alerts</div>}
        <ul>
          {alerts.reorderAlerts.map((a) => (
            <li key={a.id} style={{ marginBottom: 8, display: 'flex', justifyContent: 'space-between' }}>
              <div>
                <strong>{a.materialNumber}</strong> ‚Äî {a.name} ‚Äî stock: {a.stock}
              </div>
              <div>
                <button onClick={() => acknowledge('reorder', a.id)}>Acknowledge</button>
              </div>
            </li>
          ))}
        </ul>
      </section>

      <section style={{ marginTop: 12 }}>
        <h4>Expiry Alerts</h4>
        {alerts.expiryAlerts.length === 0 && <div>No expiry alerts</div>}
        <ul>
          {alerts.expiryAlerts.map((a) => (
            <li key={a.id} style={{ marginBottom: 8, display: 'flex', justifyContent: 'space-between' }}>
              <div>
                <strong>{a.materialNumber}</strong> ‚Äî {a.name} ‚Äî expires: {a.expiryDate}
              </div>
              <div>
                <button onClick={() => acknowledge('expiry', a.id)}>Acknowledge</button>
              </div>
            </li>
          ))}
        </ul>
      </section>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/AreaManagerDashboard.jsx">
import React from "react";
import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import "./DashboardLayout.css";

export default function AreaManagerDashboard() {
  const summary = { dealers: 12, tasks: 7 };

  return (
    <div style={{ padding: "1rem" }}>
      <PageHeader title="Area Manager Dashboard" subtitle="Overview for area-level management" />

      <div className="stat-grid">
        <StatCard title="Dealers" value={summary.dealers} />
        <StatCard title="Open Tasks" value={summary.tasks} />
      </div>

      <div className="dashboard-grid">
        <div className="column">
          <Card title="Area Tasks">
            <ul>
              <li>Follow up with underperforming dealers</li>
              <li>Coordinate logistics</li>
            </ul>
          </Card>
        </div>

        <div className="column">
          <Card title="Notifications">
            <p className="text-muted">Alerts and important updates for your area.</p>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/DealerStaffDashboard.jsx">
import React from "react";
import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import "./DashboardLayout.css";

export default function DealerStaffDashboard() {
  const summary = { myOrders: 5, drafts: 2, unreadDocs: 3 };

  return (
    <div style={{ padding: "1rem" }}>
      <PageHeader title="Dealer Staff Dashboard" subtitle="Quick actions and personal stats" />

      <div className="stat-grid">
        <StatCard title="My Orders" value={summary.myOrders} />
        <StatCard title="Drafts" value={summary.drafts} />
        <StatCard title="Unread Documents" value={summary.unreadDocs} />
      </div>

      <div className="dashboard-grid">
        <div className="column">
          <Card title="Recent Orders">
            <p className="text-muted">Your recent order activity and statuses.</p>
          </Card>
        </div>

        <div className="column">
          <Card title="Quick Actions">
            <ul>
              <li>Create new order</li>
              <li>Upload documents</li>
            </ul>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/FinanceAdminDashboard.jsx">
import React from "react";
import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import "./DashboardLayout.css";

export default function FinanceAdminDashboard() {
  const summary = { invoices: 124, overdue: 8, receipts: 102 };

  return (
    <div style={{ padding: "1rem" }}>
      <PageHeader title="Finance Dashboard" subtitle="Invoices, statements and accounts" />

      <div className="stat-grid">
        <StatCard title="Invoices" value={summary.invoices} />
        <StatCard title="Overdue" value={summary.overdue} />
        <StatCard title="Receipts" value={summary.receipts} />
      </div>

      <div className="dashboard-grid">
        <div className="column">
          <Card title="Recent Invoices">
            <p className="text-muted">Latest invoices and payment status.</p>
          </Card>
        </div>

        <div className="column">
          <Card title="Accounts Tasks">
            <ul>
              <li>Reconcile statements</li>
              <li>Review credit notes</li>
            </ul>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/RegionalAdminDashboard.jsx">
import React from "react";
import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import "./DashboardLayout.css";

export default function RegionalAdminDashboard() {
  const summary = { dealers: 42, regions: 6, activeCampaigns: 3 };

  return (
    <div style={{ padding: "1rem" }}>
      <PageHeader title="Regional Admin Dashboard" subtitle="Overview of regions and dealers" />

      <div className="stat-grid">
        <StatCard title="Dealers" value={summary.dealers} />
        <StatCard title="Regions" value={summary.regions} />
        <StatCard title="Active Campaigns" value={summary.activeCampaigns} />
      </div>

      <div className="dashboard-grid">
        <div className="column">
          <Card title="Top Performing Dealers">
            <p className="text-muted">Shows dealers in the region with best metrics.</p>
          </Card>
        </div>

        <div className="column">
          <Card title="Regional Tasks">
            <ul>
              <li>Approve dealer onboarding</li>
              <li>Schedule regional visit</li>
            </ul>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/RegionalManagerDashboard.jsx">
import React from "react";
import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import "./DashboardLayout.css";

export default function RegionalManagerDashboard() {
  const summary = { dealers: 28, approvals: 5, visits: 2 };

  return (
    <div style={{ padding: "1rem" }}>
      <PageHeader title="Regional Manager Dashboard" subtitle="Operations and approvals for your region" />

      <div className="stat-grid">
        <StatCard title="Dealers" value={summary.dealers} />
        <StatCard title="Pending Approvals" value={summary.approvals} />
        <StatCard title="Upcoming Visits" value={summary.visits} />
      </div>

      <div className="dashboard-grid">
        <div className="column">
          <Card title="Approvals">
            <p className="text-muted">Approve dealer documents and pricing requests.</p>
          </Card>
        </div>

        <div className="column">
          <Card title="Region Activity">
            <p className="text-muted">Summary of dealer activity and alerts.</p>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/TechnicalAdminDashboard.jsx">
import React from "react";
import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import "./DashboardLayout.css";

export default function TechnicalAdminDashboard() {
  const summary = {
    permissions: 128,
    materials: 542,
    pendingChanges: 6,
  };

  return (
    <div style={{ padding: "1rem" }}>
      <PageHeader
        title="Technical Admin Dashboard"
        subtitle="Manage material master and technical permissions"
      />

      <div className="stat-grid">
        <StatCard title="Permissions" value={summary.permissions} />
        <StatCard title="Materials" value={summary.materials} />
        <StatCard title="Pending Changes" value={summary.pendingChanges} />
      </div>

      <div className="dashboard-grid">
        <div className="column">
          <Card title="Material Master">
            <p className="text-muted">Quick actions for material records and mapping.</p>
            <ul>
              <li>Review recently updated materials</li>
              <li>Approve pending material imports</li>
              <li>Manage attribute mappings</li>
            </ul>
          </Card>
        </div>

        <div className="column">
          <Card title="Permission Audit">
            <p className="text-muted">Recent permission changes and audit trail.</p>
            <div className="text-muted small">No critical changes in last 7 days.</div>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/TerritoryManagerDashboard.jsx">
import React from "react";
import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import "./DashboardLayout.css";

export default function TerritoryManagerDashboard() {
  const summary = { dealers: 8, approvals: 2 };

  return (
    <div style={{ padding: "1rem" }}>
      <PageHeader title="Territory Manager Dashboard" subtitle="Territory overview and approvals" />

      <div className="stat-grid">
        <StatCard title="Dealers" value={summary.dealers} />
        <StatCard title="Pending Approvals" value={summary.approvals} />
      </div>

      <div className="dashboard-grid">
        <div className="column">
          <Card title="Territory Activity">
            <p className="text-muted">Recent activity from dealers in your territory.</p>
          </Card>
        </div>

        <div className="column">
          <Card title="Tasks">
            <ul>
              <li>Review pricing exceptions</li>
              <li>Approve new dealer requests</li>
            </ul>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/DealerChat.jsx">
import React, { useEffect, useState } from "react";
import api from "../services/api";
import socket from "../services/socket";
import { toast } from "react-toastify";
import "./Chat.css";

export default function DealerChat() {
  const [messages, setMessages] = useState([]);
  const [manager, setManager] = useState(null);
  const [newMessage, setNewMessage] = useState("");

  // üîπ Fetch manager info for this dealer
  useEffect(() => {
    (async () => {
      try {
        const res = await api.get("/dealers/my-manager"); // you can create this small endpoint
        setManager(res.data.manager);
      } catch {
        toast.error("Failed to load manager info");
      }
    })();
  }, []);

  // üîπ Fetch existing conversation
  useEffect(() => {
    if (!manager) return;
    (async () => {
      const res = await api.get(`/messages/conversation/${manager.id}`);
      setMessages(res.data.messages || []);
    })();
  }, [manager]);

  // üîπ Realtime updates
  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) socket.auth = { token };
    socket.connect();

    socket.on("message:new", (msg) => {
      if (
        msg.senderId === manager?.id ||
        msg.recipientId === manager?.id
      ) {
        setMessages((prev) => [...prev, msg]);
      }
    });

    return () => socket.disconnect();
  }, [manager]);

  const sendMessage = async () => {
    if (!newMessage.trim() || !manager) return;
    try {
      const res = await api.post("/messages", {
        recipientId: manager.id,
        subject: "Chat",
        body: newMessage.trim(),
      });
      setMessages((prev) => [...prev, res.data.message]);
      setNewMessage("");
    } catch {
      toast.error("Failed to send message");
    }
  };

  return (
    <div className="chat-container">
      <main className="chat-main">
        {manager ? (
          <>
            <header className="chat-header">
              <h3>Chat with {manager.username}</h3>
            </header>
            <div className="chat-messages">
              {messages.map((msg) => (
                <div
                  key={msg.id}
                  className={`message-bubble ${
                    msg.senderId === manager.id ? "incoming" : "outgoing"
                  }`}
                >
                  <div className="msg-body">{msg.body}</div>
                  <div className="msg-time">
                    {new Date(msg.createdAt).toLocaleTimeString()}
                  </div>
                </div>
              ))}
            </div>

            <div className="chat-input">
              <input
                type="text"
                placeholder="Type your message..."
                value={newMessage}
                onChange={(e) => setNewMessage(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && sendMessage()}
              />
              <button onClick={sendMessage}>Send</button>
            </div>
          </>
        ) : (
          <p className="empty-chat">Loading manager info...</p>
        )}
      </main>
    </div>
  );
}
</file>

<file path="src/pages/ManagerChat.jsx">
import React, { useEffect, useState } from "react";
import api from "../services/api";
import socket from "../services/socket";
import { toast } from "react-toastify";
import "./Chat.css";

export default function ManagerChat() {
  const [dealers, setDealers] = useState([]);
  const [selectedDealer, setSelectedDealer] = useState(null);
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState("");
  const [loading, setLoading] = useState(false);

  // üü¢ 1Ô∏è‚É£ Load all dealers managed by this manager (with linked user)
  useEffect(() => {
    (async () => {
      try {
        const res = await api.get("/managers/dealers");
        const dealerList = res.data.dealers || [];

        // Map dealers to include their linked user info
        const formatted = dealerList.map((d) => ({
          dealerId: d.id,
          businessName: d.businessName,
          userId: d.users?.[0]?.id || null,
          username: d.users?.[0]?.username || "No user linked",
          lastMessage: null,
          unread: false,
        }));

        setDealers(formatted);
      } catch (err) {
        console.error(err);
        toast.error("Failed to load dealers");
      }
    })();
  }, []);

  // üü£ 2Ô∏è‚É£ Fetch messages for selected dealer
  useEffect(() => {
    if (!selectedDealer) return;
    (async () => {
      try {
        setLoading(true);
        const res = await api.get(`/messages/conversation/${selectedDealer.userId}`);
        setMessages(res.data.messages || []);
      } catch (err) {
        toast.error("Failed to load messages");
      } finally {
        setLoading(false);
      }
    })();
  }, [selectedDealer]);

  // üü† 3Ô∏è‚É£ Setup socket for real-time message updates
  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) socket.auth = { token };
    socket.connect();

    socket.on("message:new", (msg) => {
      // only add messages related to current chat
      if (
        msg.senderId === selectedDealer?.userId ||
        msg.recipientId === selectedDealer?.userId
      ) {
        setMessages((prev) => [...prev, msg]);
      } else {
        // mark other dealers as having unread messages
        setDealers((prev) =>
          prev.map((d) =>
            d.userId === msg.senderId ? { ...d, unread: true } : d
          )
        );
      }
    });

    return () => socket.disconnect();
  }, [selectedDealer]);

  // üü§ 4Ô∏è‚É£ Send message
  const sendMessage = async () => {
    if (!newMessage.trim() || !selectedDealer) return;

    try {
      const res = await api.post("/messages", {
        recipientId: selectedDealer.userId,
        subject: "Chat",
        body: newMessage.trim(),
      });

      setMessages((prev) => [...prev, res.data.message]);
      setNewMessage("");

      // update dealer preview
      setDealers((prev) =>
        prev.map((d) =>
          d.userId === selectedDealer.userId
            ? { ...d, lastMessage: newMessage.trim(), unread: false }
            : d
        )
      );
    } catch (err) {
      toast.error("Failed to send message");
    }
  };

  return (
    <div className="chat-container">
      {/* Sidebar with dealer list */}
      <aside className="chat-sidebar">
        <h2>üíº My Dealers</h2>
        {dealers.length === 0 ? (
          <p className="empty-chat">No dealers assigned</p>
        ) : (
          dealers.map((dealer) => (
            <div
              key={dealer.userId || dealer.dealerId}
              className={`dealer-item ${
                selectedDealer?.userId === dealer.userId ? "active" : ""
              } ${dealer.unread ? "unread" : ""}`}
              onClick={() => {
                if (!dealer.userId)
                  return toast.error("Dealer has no linked user account");
                setSelectedDealer(dealer);
                setDealers((prev) =>
                  prev.map((d) =>
                    d.userId === dealer.userId ? { ...d, unread: false } : d
                  )
                );
              }}
            >
              <div className="dealer-name">{dealer.businessName}</div>
              {dealer.lastMessage && (
                <div className="last-message">{dealer.lastMessage}</div>
              )}
              {dealer.unread && <span className="unread-dot" />}
            </div>
          ))
        )}
      </aside>

      {/* Main chat area */}
      <main className="chat-main">
        {selectedDealer ? (
          <>
            <header className="chat-header">
              <h3>Chat with {selectedDealer.businessName}</h3>
            </header>

            <div className="chat-messages">
              {loading ? (
                <p className="empty-chat">Loading messages...</p>
              ) : messages.length === 0 ? (
                <p className="empty-chat">No messages yet</p>
              ) : (
                messages.map((msg) => (
                  <div
                    key={msg.id}
                    className={`message-bubble ${
                      msg.senderId === selectedDealer.userId
                        ? "incoming"
                        : "outgoing"
                    }`}
                  >
                    <div className="msg-body">{msg.body}</div>
                    <div className="msg-time">
                      {new Date(msg.createdAt).toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="chat-input">
              <input
                type="text"
                placeholder="Type your message..."
                value={newMessage}
                onChange={(e) => setNewMessage(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && sendMessage()}
              />
              <button onClick={sendMessage}>Send</button>
            </div>
          </>
        ) : (
          <div className="empty-chat">Select a dealer to start chatting</div>
        )}
      </main>
    </div>
  );
}
</file>

<file path="src/pages/Materials.jsx">
import React, { useEffect, useState } from "react";
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  TextField,
  MenuItem,
  Divider,
} from "@mui/material";
import api from "../services/api";

export default function Materials() {
  const [groups, setGroups] = useState([]);
  const [materials, setMaterials] = useState([]);

  // Group form
  const [groupName, setGroupName] = useState("");
  const [groupCode, setGroupCode] = useState("");
  const [groupDesc, setGroupDesc] = useState("");

  // Material form
  const [matName, setMatName] = useState("");
  const [matNum, setMatNum] = useState("");
  const [matUom, setMatUom] = useState("");
  const [matDesc, setMatDesc] = useState("");
  const [matGroup, setMatGroup] = useState("");

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    const g = await api.get("/materials/groups");
    const m = await api.get("/materials");
    setGroups(g.data.groups || []);
    setMaterials(m.data.materials || []);
  };

  // Create Group
  const createGroup = async () => {
    if (!groupName || !groupCode) return alert("Fields required");

    try {
      await api.post("/materials/groups", {
        name: groupName,
        code: groupCode,
        description: groupDesc,
      });
      alert("Group created");
      setGroupName("");
      setGroupCode("");
      setGroupDesc("");
      fetchData();
    } catch (err) {
      console.error(err);
      alert("Failed");
    }
  };

  // Create Material
  const createMaterial = async () => {
    if (!matName || !matNum) return alert("Fields required");

    try {
      await api.post("/materials", {
        name: matName,
        materialNumber: matNum,
        uom: matUom,
        description: matDesc,
        materialGroupId: matGroup || null,
      });

      alert("Material created");
      setMatDesc("");
      setMatName("");
      setMatNum("");
      setMatUom("");
      setMatGroup("");

      fetchData();
    } catch (err) {
      console.error(err);
      alert("Failed");
    }
  };

  return (
    <Box p={4}>

      {/* ---------------- GROUP SECTION ---------------- */}
      <Card sx={{ mb: 4 }}>
        <CardContent>
          <Typography variant="h5">Create Material Group</Typography>

          <TextField
            label="Group Name"
            fullWidth
            value={groupName}
            onChange={(e) => setGroupName(e.target.value)}
            sx={{ mt: 2 }}
          />
          <TextField
            label="Group Code"
            fullWidth
            value={groupCode}
            onChange={(e) => setGroupCode(e.target.value)}
            sx={{ mt: 2 }}
          />
          <TextField
            label="Description"
            fullWidth
            value={groupDesc}
            onChange={(e) => setGroupDesc(e.target.value)}
            sx={{ mt: 2 }}
          />

          <Button variant="contained" onClick={createGroup} sx={{ mt: 2 }}>
            Create Group
          </Button>
        </CardContent>
      </Card>

      {/* ---------------- MATERIAL SECTION ---------------- */}
      <Card>
        <CardContent>
          <Typography variant="h5">Create Material</Typography>

          <TextField
            label="Material Name"
            fullWidth
            value={matName}
            onChange={(e) => setMatName(e.target.value)}
            sx={{ mt: 2 }}
          />
          <TextField
            label="Material Number"
            fullWidth
            value={matNum}
            onChange={(e) => setMatNum(e.target.value)}
            sx={{ mt: 2 }}
          />
          <TextField
            label="UOM"
            fullWidth
            value={matUom}
            onChange={(e) => setMatUom(e.target.value)}
            sx={{ mt: 2 }}
          />
          <TextField
            label="Description"
            fullWidth
            value={matDesc}
            onChange={(e) => setMatDesc(e.target.value)}
            sx={{ mt: 2 }}
          />

          <TextField
            select
            label="Material Group"
            fullWidth
            value={matGroup}
            onChange={(e) => setMatGroup(e.target.value)}
            sx={{ mt: 2 }}
          >
            {groups.map((g) => (
              <MenuItem key={g.id} value={g.id}>
                {g.name}
              </MenuItem>
            ))}
          </TextField>

          <Button variant="contained" onClick={createMaterial} sx={{ mt: 2 }}>
            Create Material
          </Button>
        </CardContent>
      </Card>

    </Box>
  );
}
</file>

<file path="src/pages/payments/CreatePaymentRequest.jsx">
import React, { useState, useEffect } from "react";
import {
  Box,
  Card,
  CardContent,
  Typography,
  TextField,
  Button,
  MenuItem
} from "@mui/material";
import api from "../../services/api";
import { useParams, useNavigate } from "react-router-dom";

export default function CreatePaymentRequest() {
  const { invoiceId } = useParams();
  const navigate = useNavigate();

  const [invoice, setInvoice] = useState(null);
  const [paymentMode, setPaymentMode] = useState("");
  const [utrNumber, setUtrNumber] = useState("");
  const [proofFile, setProofFile] = useState(null);

  useEffect(() => {
    api.get(`/invoices/${invoiceId}`).then((res) => {
      setInvoice(res.data.invoice);
    });
  }, [invoiceId]);

  const submitRequest = async () => {
    if (!proofFile || !paymentMode) {
      return alert("Please upload proof & select payment mode.");
    }

    const formData = new FormData();
    formData.append("invoiceId", invoiceId);
    formData.append("amount", invoice.balanceAmount);
    formData.append("paymentMode", paymentMode);
    formData.append("utrNumber", utrNumber);
    formData.append("proofFile", proofFile);

    try {
      await api.post("/payments/request", formData, {
        headers: { "Content-Type": "multipart/form-data" },
      });
      alert("Payment Request Sent to Dealer Admin!");
      navigate("/payments/mine");
    } catch (err) {
      console.error(err);
      alert("Failed to submit payment request");
    }
  };

  if (!invoice) return <div>Loading...</div>;

  return (
    <Box p={3}>
      <Card>
        <CardContent>
          <Typography variant="h5" mb={2}>
            Make Payment Request
          </Typography>

          <Typography>
            <strong>Invoice:</strong> {invoice.invoiceNumber}
          </Typography>
          <Typography>
            <strong>Pending Amount:</strong> ‚Çπ{invoice.balanceAmount}
          </Typography>

          <TextField
            fullWidth
            label="Payment Mode"
            select
            margin="normal"
            value={paymentMode}
            onChange={(e) => setPaymentMode(e.target.value)}
          >
            <MenuItem value="NEFT">NEFT</MenuItem>
            <MenuItem value="RTGS">RTGS</MenuItem>
            <MenuItem value="UPI">UPI</MenuItem>
            <MenuItem value="CHEQUE">Cheque</MenuItem>
          </TextField>

          <TextField
            fullWidth
            label="UTR Number (optional)"
            margin="normal"
            value={utrNumber}
            onChange={(e) => setUtrNumber(e.target.value)}
          />

          <Button variant="contained" component="label" sx={{ mt: 2 }}>
            Upload Payment Proof
            <input
              type="file"
              hidden
              accept="image/*,application/pdf"
              onChange={(e) => setProofFile(e.target.files[0])}
            />
          </Button>

          {proofFile && <Typography mt={1}>{proofFile.name}</Typography>}

          <Button
            variant="contained"
            color="primary"
            sx={{ mt: 4 }}
            onClick={submitRequest}
          >
            Submit Payment Request
          </Button>
        </CardContent>
      </Card>
    </Box>
  );
}
</file>

<file path="src/pages/payments/DealerAdminPayments.jsx">
import React, { useEffect, useState } from "react";
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  Table,
  TableBody,
  TableHead,
  TableRow,
  TableCell
} from "@mui/material";
import api from "../../services/api";

export default function DealerAdminPayments() {
  const [payments, setPayments] = useState([]);

  const loadData = async () => {
    const res = await api.get("/payments/dealer/pending");
    setPayments(res.data.pending);
  };

  useEffect(() => {
    loadData();
  }, []);

  const reviewPayment = async (id, action) => {
    await api.post(`/payments/dealer/${id}/review`, { action });
    loadData();
  };

  return (
    <Box p={3}>
      <Typography variant="h5" mb={3}>
        Pending Payment Requests (Dealer Admin)
      </Typography>

      <Card>
        <CardContent>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Invoice</TableCell>
                <TableCell>Amount</TableCell>
                <TableCell>Payment Mode</TableCell>
                <TableCell>Proof</TableCell>
                <TableCell>Action</TableCell>
              </TableRow>
            </TableHead>

            <TableBody>
              {payments.map((p) => (
                <TableRow key={p.id}>
                  <TableCell>{p.Invoice?.invoiceNumber}</TableCell>
                  <TableCell>‚Çπ{p.amount}</TableCell>
                  <TableCell>{p.paymentMode}</TableCell>
                  <TableCell>
                    {p.proofFile && (
                      <a href={p.proofFile} target="_blank" rel="noreferrer">
                        View
                      </a>
                    )}
                  </TableCell>
                  <TableCell>
                    <Button
                      color="success"
                      onClick={() => reviewPayment(p.id, "approve")}
                    >
                      Approve
                    </Button>
                    <Button
                      color="error"
                      onClick={() => reviewPayment(p.id, "reject")}
                    >
                      Reject
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </Box>
  );
}
</file>

<file path="src/pages/payments/FinancePendingPayments.jsx">
import React, { useEffect, useState } from "react";
import {
  Box,
  Typography,
  Table,
  TableBody,
  TableHead,
  TableRow,
  TableCell,
  Button,
  Card,
  CardContent
} from "@mui/material";
import api from "../../services/api";

export default function FinancePendingPayments() {
  const [payments, setPayments] = useState([]);

  const loadData = async () => {
    const res = await api.get("/payments/pending");
    setPayments(res.data.pending);
  };

  useEffect(() => {
    loadData();
  }, []);

  const reviewPayment = async (id, action) => {
    await api.post(`/payments/${id}/review`, { action });
    loadData();
  };

  return (
    <Box p={3}>
      <Typography variant="h5" mb={3}>
        Finance Pending Payment Approvals
      </Typography>

      <Card>
        <CardContent>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Dealer</TableCell>
                <TableCell>Invoice</TableCell>
                <TableCell>Amount</TableCell>
                <TableCell>Proof</TableCell>
                <TableCell>Action</TableCell>
              </TableRow>
            </TableHead>

            <TableBody>
              {payments.map((p) => (
                <TableRow key={p.id}>
                  <TableCell>{p.Dealer?.name}</TableCell>
                  <TableCell>{p.Invoice?.invoiceNumber}</TableCell>
                  <TableCell>‚Çπ{p.amount}</TableCell>
                  <TableCell>
                    {p.proofFile && (
                      <a href={p.proofFile} target="_blank" rel="noreferrer">
                        View
                      </a>
                    )}
                  </TableCell>
                  <TableCell>
                    <Button
                      sx={{ mr: 1 }}
                      color="success"
                      onClick={() => reviewPayment(p.id, "approve")}
                    >
                      Approve
                    </Button>
                    <Button
                      color="error"
                      onClick={() => reviewPayment(p.id, "reject")}
                    >
                      Reject
                    </Button>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </Box>
  );
}
</file>

<file path="src/pages/PricingApprovals.jsx">
import React, { useEffect, useState } from "react";
import api from "../services/api";
import { toast } from "react-toastify";
import PageHeader from "../components/PageHeader";
import Card from "../components/Card";
import SearchInput from "../components/SearchInput";
import "./dashboards/DashboardLayout.css";

export default function PricingApprovals() {
  const [loading, setLoading] = useState(true);
  const [updates, setUpdates] = useState([]);
  const [page, setPage] = useState(1);
  const [limit] = useState(20);
  const [total, setTotal] = useState(0);
  const [query, setQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");

  const fetchUpdates = async (pageToLoad = 1) => {
    try {
      setLoading(true);
      const q = new URLSearchParams();
      q.set("page", pageToLoad);
      q.set("limit", limit);
      // Admin wants all updates; dealers pass mine=true from dealer UI
      const res = await api.get(`/pricing?${q.toString()}`);
      setUpdates(res.data.updates || []);
      setTotal(res.data.total || 0);
    } catch (err) {
      console.error("Failed to fetch pricing updates:", err);
      toast.error("Failed to load pricing requests");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchUpdates(page);
    // eslint-disable-next-line
  }, [page]);

  const applyAction = async (id, action) => {
    try {
      const confirm = window.confirm(`Are you sure you want to ${action} this pricing request?`);
      if (!confirm) return;

      const remarks = window.prompt("Optional remarks (enter to skip):", "");
      // call backend patch
      await api.patch(`/pricing/${id}`, { status: action, remarks });
      toast.success(`Request ${action}ed`);
      // update local list
      setUpdates((prev) => prev.filter((u) => u.id !== id));
      setTotal((t) => Math.max(0, t - 1));
    } catch (err) {
      console.error("Approve/reject failed:", err);
      toast.error("Action failed");
    }
  };

  // client-side search + filter
  const visible = updates
    .filter((u) => (statusFilter === "all" ? true : u.status === statusFilter))
    .filter((u) => {
      if (!query) return true;
      const q = query.toLowerCase();
      return (
        String(u.id).includes(q) ||
        String(u.productId).includes(q) ||
        String(u.dealerName || "").toLowerCase().includes(q) ||
        String(u.requestedBy || "").toLowerCase().includes(q)
      );
    });

  return (
    <div className="dashboard-container">
      <PageHeader title="Pricing Approvals" subtitle="Review and approve pricing change requests." />

      <div style={{ display: "flex", gap: 12, marginBottom: 12 }}>
        <SearchInput value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Search by id, product, dealer, requester..." />
        <div>
          <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} style={{ padding: "6px 10px", borderRadius: 6 }}>
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div style={{ marginLeft: "auto" }}>
          <button className="btn-primary" onClick={() => fetchUpdates(1)}>Refresh</button>
        </div>
      </div>

      <Card>
        {loading ? (
          <div className="center">Loading...</div>
        ) : visible.length ? (
          <div style={{ overflowX: "auto" }}>
            <table className="custom-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Product</th>
                  <th>Dealer</th>
                  <th>Old</th>
                  <th>New</th>
                  <th>Status</th>
                  <th>Requested By</th>
                  <th>Requested At</th>
                  <th style={{ minWidth: 140 }}>Actions</th>
                </tr>
              </thead>
              <tbody>
                {visible.map((u) => (
                  <tr key={u.id}>
                    <td>{u.id}</td>
                    <td>{u.product?.name || u.productId}</td>
                    <td>{u.dealer?.businessName || u.dealerName || "‚Äî"}</td>
                    <td>{u.oldPrice ?? "‚Äî"}</td>
                    <td>{u.newPrice}</td>
                    <td className={`status-${u.status}`}>{u.status}</td>
                    <td>{u.requestedBy}</td>
                    <td>{new Date(u.createdAt).toLocaleString()}</td>
                    <td>
                      {u.status === "pending" ? (
                        <>
                          <button className="btn-success" onClick={() => applyAction(u.id, "approved")}>Approve</button>
                          <button className="btn-danger" style={{ marginLeft: 8 }} onClick={() => applyAction(u.id, "rejected")}>Reject</button>
                        </>
                      ) : (
                        <span className="text-muted small">No actions</span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {/* Pagination basic */}
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginTop: 12 }}>
              <div className="text-muted small">Total: {total}</div>
              <div style={{ display: "flex", gap: 8 }}>
                <button className="btn" onClick={() => setPage((p) => Math.max(1, p - 1))} disabled={page === 1}>Prev</button>
                <div style={{ padding: "6px 10px" }}>Page {page}</div>
                <button className="btn" onClick={() => setPage((p) => p + 1)} disabled={updates.length < limit}>Next</button>
              </div>
            </div>
          </div>
        ) : (
          <p className="text-muted">No pricing requests found.</p>
        )}
      </Card>
    </div>
  );
}
</file>

<file path="src/pages/reports/AccountStatementReport.jsx">
import React, { useEffect } from "react";
import {
  Box,
  Grid,
  Paper,
  Typography,
  CircularProgress,
  Divider,
} from "@mui/material";

const KPI = { p: 2, borderRadius: 2, boxShadow: "0 6px 18px rgba(2,6,23,0.06)" };
const ACCENT = "#0d6efd";

export default function AccountStatementReport({ data, loading, error, fetchReport, filters }) {
  useEffect(() => { if (!data) fetchReport(); }, []); // eslint-disable-line

  if (loading) return <Box sx={{ mt: 3, textAlign: "center" }}><CircularProgress /></Box>;
  if (error) return <Box sx={{ mt: 3 }}><Typography color="error">{error}</Typography></Box>;
  if (!data) return null;

  const { openingBalance = 0, closingBalance = 0, totalDebit = 0, totalCredit = 0, statements = [] } = data;

  return (
    <Box mt={3}>
      <Grid container spacing={2}>
        <Grid item xs={12} md={3}>
          <Paper sx={KPI}>
            <Typography variant="subtitle2" color={ACCENT}>Opening Balance</Typography>
            <Typography variant="h6" fontWeight={700}>‚Çπ{Number(openingBalance).toLocaleString()}</Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} md={3}>
          <Paper sx={KPI}>
            <Typography variant="subtitle2" color={ACCENT}>Closing Balance</Typography>
            <Typography variant="h6" fontWeight={700}>‚Çπ{Number(closingBalance).toLocaleString()}</Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} md={3}>
          <Paper sx={KPI}>
            <Typography variant="subtitle2" color={ACCENT}>Total Debit</Typography>
            <Typography variant="h6" fontWeight={700}>‚Çπ{Number(totalDebit).toLocaleString()}</Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} md={3}>
          <Paper sx={KPI}>
            <Typography variant="subtitle2" color={ACCENT}>Total Credit</Typography>
            <Typography variant="h6" fontWeight={700}>‚Çπ{Number(totalCredit).toLocaleString()}</Typography>
          </Paper>
        </Grid>

        <Grid item xs={12}>
          <Paper sx={{ p: 2 }}>
            <Typography variant="h6">Statements</Typography>
            <Divider sx={{ my: 1 }} />
            <Box sx={{ overflowX: "auto" }}>
              <table style={{ width: "100%", borderCollapse: "collapse" }}>
                <thead style={{ background: "#f3f4f6" }}>
                  <tr>
                    <th style={{ padding: 10 }}>Date</th>
                    <th style={{ padding: 10 }}>Description</th>
                    <th style={{ padding: 10 }}>Debit</th>
                    <th style={{ padding: 10 }}>Credit</th>
                    <th style={{ padding: 10 }}>Balance</th>
                  </tr>
                </thead>
                <tbody>
                  {statements.map(s => (
                    <tr key={s.id}>
                      <td style={{ padding: 10 }}>{new Date(s.statementDate).toLocaleDateString()}</td>
                      <td style={{ padding: 10 }}>{s.description || s.documentType || "‚Äî"}</td>
                      <td style={{ padding: 10 }}>‚Çπ{Number(s.debitAmount || 0).toLocaleString()}</td>
                      <td style={{ padding: 10 }}>‚Çπ{Number(s.creditAmount || 0).toLocaleString()}</td>
                      <td style={{ padding: 10 }}>‚Çπ{Number(s.balance || 0).toLocaleString()}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </Box>
          </Paper>
        </Grid>
      </Grid>
    </Box>
  );
}
</file>

<file path="src/pages/reports/AdminSummary.jsx">
// src/pages/reports/reportTypes/AdminSummary.jsx
import React, { useEffect } from "react";
import { Box, Paper, Typography } from "@mui/material";
import { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip } from "recharts";
import KPISection from "./KPISection";

export default function AdminSummary({ data, loading, fetchReport }) {
  useEffect(() => {
    if (!data) fetchReport();
    // eslint-disable-next-line
  }, []);

  if (!data) return null;

  const series = [
    { name: "Dealers", value: data.totalDealers || 0 },
    { name: "Blocked", value: data.blockedDealers || 0 },
    { name: "Pending Docs", value: data.pendingDocuments || 0 },
    { name: "Outstanding", value: Number(data.totalOutstanding || 0) },
  ];

  return (
    <Box mt={3}>
      <KPISection
        items={[
          { title: "Total Dealers", value: data.totalDealers ?? 0, color: "linear-gradient(135deg,#2563eb,#1e3a8a)" },
          { title: "Blocked Dealers", value: data.blockedDealers ?? 0, color: "linear-gradient(135deg,#dc2626,#7f1d1d)" },
          { title: "Pending Documents", value: data.pendingDocuments ?? 0, color: "linear-gradient(135deg,#f59e0b,#b45309)" },
          { title: "Total Outstanding", value: `‚Çπ${Number(data.totalOutstanding || 0).toLocaleString()}`, color: "linear-gradient(135deg,#059669,#065f46)" },
        ]}
      />

      <Box mt={3}>
        <Paper sx={{ p: 2 }}>
          <Typography variant="h6" mb={2}>
            Overall KPIs Trend
          </Typography>
          <ResponsiveContainer width="100%" height={260}>
            <BarChart data={series}>
              <XAxis dataKey="name" />
              <YAxis />
              <Tooltip />
              <Bar dataKey="value" radius={[6, 6, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </Paper>
      </Box>
    </Box>
  );
}
</file>

<file path="src/pages/reports/ChartsBlock.jsx">
// src/components/reports/ChartsBlock.jsx
import React from "react";
import { Paper, Typography, Box } from "@mui/material";

export default function ChartsBlock({ title, children }) {
  return (
    <Paper sx={{ p: 2, borderRadius: 2, boxShadow: "0 6px 18px rgba(2,6,23,0.06)" }}>
      <Typography variant="subtitle1" mb={1}>
        {title}
      </Typography>
      <Box sx={{ height: 300 }}>{children}</Box>
    </Paper>
  );
}
</file>

<file path="src/pages/reports/CreditDebitNotes.jsx">
import React, { useEffect } from "react";
import {
  Box,
  Paper,
  Typography,
  Divider,
  CircularProgress,
} from "@mui/material";

export default function CreditDebitNotes({ data, loading, error, fetchReport }) {
  useEffect(() => { if (!data) fetchReport(); }, []); // eslint-disable-line

  if (loading) return <Box sx={{ mt: 3, textAlign: "center" }}><CircularProgress /></Box>;
  if (error) return <Box sx={{ mt: 3 }}><Typography color="error">{error}</Typography></Box>;
  if (!data) return null;

  const { notes = [], totalCredit = 0, totalDebit = 0 } = data;

  return (
    <Box mt={3}>
      <Paper sx={{ p: 2 }}>
        <Typography variant="h6">Credit / Debit Notes</Typography>
        <Divider sx={{ my: 1 }} />

        <Box sx={{ display: "flex", gap: 2, mb: 2 }}>
          <Paper sx={{ p: 2, minWidth: 180 }}>
            <Typography variant="subtitle2">Total Credit</Typography>
            <Typography variant="h6">‚Çπ{Number(totalCredit).toLocaleString()}</Typography>
          </Paper>
          <Paper sx={{ p: 2, minWidth: 180 }}>
            <Typography variant="subtitle2">Total Debit</Typography>
            <Typography variant="h6">‚Çπ{Number(totalDebit).toLocaleString()}</Typography>
          </Paper>
        </Box>

        <Box sx={{ overflowX: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead style={{ background: "#f8fafc" }}>
              <tr>
                <th style={{ padding: 10 }}>Note #</th>
                <th style={{ padding: 10 }}>Date</th>
                <th style={{ padding: 10 }}>Dealer</th>
                <th style={{ padding: 10 }}>Type</th>
                <th style={{ padding: 10 }}>Amount</th>
                <th style={{ padding: 10 }}>Reason</th>
              </tr>
            </thead>
            <tbody>
              {notes.map(n => (
                <tr key={n.id}>
                  <td style={{ padding: 10 }}>{n.noteNumber || n.id}</td>
                  <td style={{ padding: 10 }}>{n.noteDate ? new Date(n.noteDate).toLocaleDateString() : "‚Äî"}</td>
                  <td style={{ padding: 10 }}>{n.dealer?.businessName || "‚Äî"}</td>
                  <td style={{ padding: 10 }}>{n.noteType}</td>
                  <td style={{ padding: 10 }}>‚Çπ{Number(n.amount || 0).toLocaleString()}</td>
                  <td style={{ padding: 10 }}>{n.reasonCode || "-"}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </Box>
      </Paper>
    </Box>
  );
}
</file>

<file path="src/pages/reports/DealerPerformance.jsx">
import React, { useEffect, useMemo } from "react";
import {
  Box,
  Grid,
  Paper,
  Typography,
  CircularProgress,
  Divider,
} from "@mui/material";
import { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, PieChart, Pie, Cell, Legend } from "recharts";

const ACCENT = "#F97316";
const KPI = { p: 2, borderRadius: 2, boxShadow: "0 6px 18px rgba(2,6,23,0.06)" };
const COLORS = ["#F97316", "#10B981", "#6366F1", "#EF4444", "#F59E0B"];

export default function DealerPerformance({ data, loading, error, fetchReport, filters, role }) {
  useEffect(() => {
    if (!data) fetchReport();
  }, []); // eslint-disable-line

  if (loading) return <Box sx={{ mt: 3, textAlign: "center" }}><CircularProgress /></Box>;
  if (error) return <Box sx={{ mt: 3 }}><Typography color="error">{error}</Typography></Box>;
  if (!data) return null;

  // backend returns either array (admin) or object (dealer)
  const dealers = Array.isArray(data) ? data : (data.dealers || []);
  const totalSales = Array.isArray(data)
    ? dealers.reduce((s, d) => s + Number(d.totalSales || 0), 0)
    : data.totalSales || 0;

  const productGroups = (Array.isArray(data) ? (dealers[0]?.productGroups || {}) : (data.productGroups || {}));

  const barData = dealers.map(d => ({ name: d.dealerName || d.businessName, total: Number(d.totalSales || 0) }));
  const pieData = Object.entries(productGroups).map(([k, v]) => ({ name: k, value: Number(v) }));

  return (
    <Box mt={3}>
      <Grid container spacing={2}>
        <Grid item xs={12} md={4}>
          <Paper sx={{ ...KPI }}>
            <Typography variant="subtitle2" color={ACCENT}>Total Dealers</Typography>
            <Typography variant="h5" fontWeight={700}>{dealers.length}</Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} md={4}>
          <Paper sx={{ ...KPI }}>
            <Typography variant="subtitle2" color={ACCENT}>Total Sales</Typography>
            <Typography variant="h5" fontWeight={700}>‚Çπ{Number(totalSales).toLocaleString()}</Typography>
          </Paper>
        </Grid>
        <Grid item xs={12} md={4}>
          <Paper sx={{ ...KPI }}>
            <Typography variant="subtitle2" color={ACCENT}>Pending Orders</Typography>
            <Typography variant="h5" fontWeight={700}>{data.pendingOrders ?? 0}</Typography>
          </Paper>
        </Grid>

        <Grid item xs={12} md={8}>
          <Paper sx={{ p: 2 }}>
            <Typography variant="subtitle1">Dealer-wise Sales</Typography>
            <Divider sx={{ my: 1 }} />
            <Box sx={{ height: 300 }}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={barData}>
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="total" fill={ACCENT} radius={[6,6,0,0]} />
                </BarChart>
              </ResponsiveContainer>
            </Box>
          </Paper>
        </Grid>

        <Grid item xs={12} md={4}>
          <Paper sx={{ p: 2 }}>
            <Typography variant="subtitle1">Product Group Mix</Typography>
            <Divider sx={{ my: 1 }} />
            <Box sx={{ height: 260 }}>
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie data={pieData} dataKey="value" nameKey="name" outerRadius={80} label>
                    {pieData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                  </Pie>
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            </Box>
          </Paper>
        </Grid>
      </Grid>
    </Box>
  );
}
</file>

<file path="src/pages/reports/DealerTable.jsx">
// src/components/reports/DealerTable.jsx
import React from "react";
import { Box, Paper, Typography } from "@mui/material";

export default function DealerTable({ rows = [] }) {
  return (
    <Paper sx={{ p: 2, borderRadius: 2 }}>
      <Typography variant="h6" mb={2}>
        Dealer-wise Sales Summary
      </Typography>
      <Box sx={{ overflowX: "auto" }}>
        <table style={{ width: "100%", borderCollapse: "collapse" }}>
          <thead>
            <tr style={{ background: "#f8fafc", textAlign: "left", borderBottom: "2px solid #e5e7eb" }}>
              <th style={{ padding: 12 }}>Dealer</th>
              <th style={{ padding: 12 }}>Code</th>
              <th style={{ padding: 12 }}>Territory</th>
              <th style={{ padding: 12 }}>Sales</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r, i) => (
              <tr key={i} style={{ borderBottom: "1px solid #e5e7eb" }}>
                <td style={{ padding: 12 }}>{r.dealerName}</td>
                <td style={{ padding: 12 }}>{r.dealerCode}</td>
                <td style={{ padding: 12 }}>{r.territory}</td>
                <td style={{ padding: 12 }}>‚Çπ{Number(r.totalSales || 0).toLocaleString()}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </Box>
    </Paper>
  );
}
</file>

<file path="src/pages/reports/FiltersBar.jsx">
// src/components/reports/FiltersBar.jsx
import React from "react";
import { Box, TextField, MenuItem, Button } from "@mui/material";

export default function FiltersBar({
  reportOptions = [],
  reportType,
  setReportType,
  filters,
  onFiltersChange,
  onGenerate,
  loading,
}) {
  return (
    <Box sx={{ display: "flex", gap: 1, alignItems: "center", flexWrap: "wrap" }}>
      <TextField
        select
        size="small"
        label="Report"
        value={reportType}
        onChange={(e) => setReportType(e.target.value)}
        sx={{ minWidth: 220 }}
      >
        {reportOptions.map((o) => (
          <MenuItem key={o.value} value={o.value}>
            {o.label}
          </MenuItem>
        ))}
      </TextField>

      <TextField
        name="region"
        size="small"
        label="Region"
        value={filters.region || ""}
        onChange={(e) => onFiltersChange({ region: e.target.value })}
      />

      <TextField
        name="territory"
        size="small"
        label="Territory"
        value={filters.territory || ""}
        onChange={(e) => onFiltersChange({ territory: e.target.value })}
      />

      <TextField
        name="dealerId"
        size="small"
        label="Dealer ID"
        value={filters.dealerId || ""}
        onChange={(e) => onFiltersChange({ dealerId: e.target.value })}
      />

      <TextField
        name="startDate"
        type="date"
        size="small"
        label="From"
        InputLabelProps={{ shrink: true }}
        value={filters.startDate || ""}
        onChange={(e) => onFiltersChange({ startDate: e.target.value })}
      />

      <TextField
        name="endDate"
        type="date"
        size="small"
        label="To"
        InputLabelProps={{ shrink: true }}
        value={filters.endDate || ""}
        onChange={(e) => onFiltersChange({ endDate: e.target.value })}
      />

      <Button variant="contained" sx={{ background: "#F97316" }} onClick={onGenerate} disabled={loading}>
        {loading ? "Generating..." : "Generate"}
      </Button>
    </Box>
  );
}
</file>

<file path="src/pages/reports/InvoiceRegister.jsx">
import React, { useEffect } from "react";
import {
  Box,
  Paper,
  Typography,
  CircularProgress,
  Button,
  Divider,
} from "@mui/material";

const ACCENT = "#F97316";

export default function InvoiceRegister({ data, loading, error, fetchReport, filters }) {
  useEffect(() => { if (!data) fetchReport(); }, []); // eslint-disable-line

  if (loading) return <Box sx={{ mt: 3, textAlign: "center" }}><CircularProgress /></Box>;
  if (error) return <Box sx={{ mt: 3 }}><Typography color="error">{error}</Typography></Box>;
  if (!data) return null;

  const invoices = data.invoices || [];

  const downloadInvoice = async (id) => {
    try {
      const res = await fetch(`/api/invoices/${id}/pdf`, { credentials: "include" });
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `invoice_${id}.pdf`; a.click();
    } catch (err) {
      console.error("downloadInvoice:", err);
    }
  };

  return (
    <Box mt={3}>
      <Paper sx={{ p: 2 }}>
        <Typography variant="h6">Invoice Register</Typography>
        <Divider sx={{ my: 1 }} />

        <Box sx={{ overflowX: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead style={{ background: "#f8fafc" }}>
              <tr>
                <th style={{ padding: 10 }}>Invoice #</th>
                <th style={{ padding: 10 }}>Date</th>
                <th style={{ padding: 10 }}>Dealer</th>
                <th style={{ padding: 10 }}>Product Group</th>
                <th style={{ padding: 10 }}>Amount</th>
                <th style={{ padding: 10 }}>Status</th>
                <th style={{ padding: 10 }}>Action</th>
              </tr>
            </thead>
            <tbody>
              {invoices.map(inv => (
                <tr key={inv.id}>
                  <td style={{ padding: 10 }}>{inv.invoiceNumber}</td>
                  <td style={{ padding: 10 }}>{inv.invoiceDate ? new Date(inv.invoiceDate).toLocaleDateString() : "‚Äî"}</td>
                  <td style={{ padding: 10 }}>{inv.dealer?.businessName || "‚Äî"}</td>
                  <td style={{ padding: 10 }}>{inv.productGroup || "‚Äî"}</td>
                  <td style={{ padding: 10 }}>‚Çπ{Number(inv.totalAmount || 0).toLocaleString()}</td>
                  <td style={{ padding: 10 }}>{inv.status}</td>
                  <td style={{ padding: 10 }}>
                    <Button size="small" variant="outlined" onClick={() => downloadInvoice(inv.id)} sx={{ borderColor: ACCENT, color: ACCENT }}>
                      Download
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </Box>
      </Paper>
    </Box>
  );
}
</file>

<file path="src/pages/reports/KPISection.jsx">
// src/components/reports/KPISection.jsx
import React from "react";
import { Grid, Paper, Typography } from "@mui/material";

export default function KPISection({ items = [] }) {
  // items: [{title, value, color}]
  return (
    <Grid container spacing={2}>
      {items.map((it, idx) => (
        <Grid item xs={12} md={3} key={idx}>
          <Paper
            sx={{
              p: 2,
              borderRadius: 2,
              background: it.color || "linear-gradient(135deg,#2563eb,#1e3a8a)",
              color: "#fff",
              boxShadow: "0 8px 20px rgba(0,0,0,0.08)",
            }}
          >
            <Typography variant="subtitle2">{it.title}</Typography>
            <Typography variant="h5" sx={{ fontWeight: 700 }}>
              {it.value}
            </Typography>
          </Paper>
        </Grid>
      ))}
    </Grid>
  );
}
</file>

<file path="src/pages/reports/OutstandingReceivables.jsx">
import React, { useEffect } from "react";
import {
  Box,
  Grid,
  Paper,
  Typography,
  CircularProgress,
  Divider,
} from "@mui/material";
import { ResponsiveContainer, PieChart, Pie, Cell, Tooltip, Legend } from "recharts";

const ACCENT = "#F97316";
const COLORS = ["#F97316", "#F59E0B", "#EF4444", "#06B6D4"];

export default function OutstandingReceivables({ data, loading, error, fetchReport }) {
  useEffect(() => { if (!data) fetchReport(); }, []); // eslint-disable-line

  if (loading) return <Box sx={{ mt: 3, textAlign: "center" }}><CircularProgress /></Box>;
  if (error) return <Box sx={{ mt: 3 }}><Typography color="error">{error}</Typography></Box>;
  if (!data) return null;

  const { totalOutstanding = 0, aging = {}, invoices = [] } = data;
  const pieData = Object.entries(aging).map(([k, v]) => ({ name: k, value: Number(v || 0) }));

  return (
    <Box mt={3}>
      <Grid container spacing={2}>
        <Grid item xs={12} md={4}>
          <Paper sx={{ p: 2 }}>
            <Typography variant="subtitle2">Total Outstanding</Typography>
            <Typography variant="h4" fontWeight={700}>‚Çπ{Number(totalOutstanding).toLocaleString()}</Typography>
          </Paper>
        </Grid>

        <Grid item xs={12} md={8}>
          <Paper sx={{ p: 2 }}>
            <Typography variant="subtitle1">Aging</Typography>
            <Divider sx={{ my: 1 }} />
            <Box sx={{ height: 260 }}>
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie data={pieData} dataKey="value" nameKey="name" outerRadius={80} label>
                    {pieData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                  </Pie>
                  <Tooltip />
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            </Box>
          </Paper>
        </Grid>

        <Grid item xs={12}>
          <Paper sx={{ p: 2 }}>
            <Typography variant="h6">Outstanding Invoices</Typography>
            <Divider sx={{ my: 1 }} />
            <Box sx={{ overflowX: "auto" }}>
              <table style={{ width: "100%", borderCollapse: "collapse" }}>
                <thead style={{ background: "#f8fafc" }}>
                  <tr>
                    <th style={{ padding: 10 }}>Invoice #</th>
                    <th style={{ padding: 10 }}>Dealer</th>
                    <th style={{ padding: 10 }}>Due Date</th>
                    <th style={{ padding: 10 }}>Balance</th>
                    <th style={{ padding: 10 }}>Days Past Due</th>
                  </tr>
                </thead>
                <tbody>
                  {invoices.map(inv => {
                    const daysPast = inv.dueDate ? Math.floor((new Date() - new Date(inv.dueDate)) / (1000*60*60*24)) : 0;
                    return (
                      <tr key={inv.id}>
                        <td style={{ padding: 10 }}>{inv.invoiceNumber}</td>
                        <td style={{ padding: 10 }}>{inv.dealer?.businessName || "‚Äî"}</td>
                        <td style={{ padding: 10 }}>{inv.dueDate ? new Date(inv.dueDate).toLocaleDateString() : "‚Äî"}</td>
                        <td style={{ padding: 10 }}>‚Çπ{Number(inv.balanceAmount || 0).toLocaleString()}</td>
                        <td style={{ padding: 10 }}>{daysPast}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </Box>
          </Paper>
        </Grid>
      </Grid>
    </Box>
  );
}
</file>

<file path="src/pages/reports/PendingApprovals.jsx">
// src/pages/reports/PendingApprovals.jsx
import React from "react";
import {
  Box,
  Grid,
  Paper,
  Typography,
  Chip,
  Accordion,
  AccordionSummary,
  AccordionDetails,
} from "@mui/material";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import HourglassEmptyIcon from "@mui/icons-material/HourglassEmpty";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import ErrorIcon from "@mui/icons-material/Error";

const CARD = {
  p: 3,
  borderRadius: "16px",
  background: "white",
  boxShadow: "0 6px 18px rgba(0,0,0,0.08)",
};

export default function PendingApprovals({ data, loading, error }) {
  if (loading)
    return (
      <Box sx={{ textAlign: "center", mt: 3 }}>
        <Typography>Loading...</Typography>
      </Box>
    );

  if (error)
    return (
      <Box sx={{ textAlign: "center", mt: 3 }}>
        <Typography color="error">{error}</Typography>
      </Box>
    );

  // üëá FIX HERE
  const list = Array.isArray(data?.report) ? data.report : [];

  if (list.length === 0)
    return (
      <Box sx={{ textAlign: "center", mt: 3 }}>
        <Typography>No pending approvals found.</Typography>
      </Box>
    );

  // ----- KPIs -----
  const pendingCount = list.length;
  const typesBreakdown = {};

  list.forEach((d) => {
    if (!typesBreakdown[d.documentType]) typesBreakdown[d.documentType] = 0;
    typesBreakdown[d.documentType]++;
  });

  return (
    <Box mt={3}>
      {/* ===================== KPI CARDS ===================== */}
      <Grid container spacing={3}>
        {/* Pending Approvals */}
        <Grid item xs={12} md={4}>
          <Paper
            sx={{
              ...CARD,
              background: "linear-gradient(135deg, #f97316, #c2410c)",
              color: "white",
            }}
          >
            <Typography variant="subtitle2">Total Pending Approvals</Typography>
            <Typography variant="h4" fontWeight={700}>
              {pendingCount}
            </Typography>
          </Paper>
        </Grid>

        {/* Document Type-wise */}
        <Grid item xs={12} md={8}>
          <Paper sx={{ ...CARD }}>
            <Typography variant="subtitle2" color="text.secondary">
              Pending by Document Type
            </Typography>
            <Box sx={{ display: "flex", gap: 1, mt: 1, flexWrap: "wrap" }}>
              {Object.entries(typesBreakdown).map(([type, count]) => (
                <Chip
                  key={type}
                  label={`${type} ‚Äî ${count}`}
                  color="warning"
                  variant="outlined"
                  sx={{ fontWeight: 600 }}
                />
              ))}
            </Box>
          </Paper>
        </Grid>
      </Grid>

      {/* ===================== DATA ACCORDION TABLE ===================== */}
      <Box mt={3}>
        <Paper sx={{ ...CARD }}>
          <Typography variant="h6" mb={2}>
            Pending Documents
          </Typography>

          {list.map((item, index) => (
            <Accordion key={index} sx={{ mb: 1, borderRadius: "12px" }}>
              <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                <Grid container alignItems="center">
                  <Grid item xs={12} md={4}>
                    <Typography fontWeight={600}>{item.dealerName}</Typography>
                  </Grid>

                  <Grid item xs={12} md={3}>
                    <Typography>{item.documentType}</Typography>
                  </Grid>

                  <Grid item xs={12} md={3}>
                    <Typography color="gray">
                      Submitted: {new Date(item.createdAt).toLocaleDateString()}
                    </Typography>
                  </Grid>

                  <Grid item xs={12} md={2}>
                    <Chip
                      icon={<HourglassEmptyIcon />}
                      label="Pending"
                      color="warning"
                    />
                  </Grid>
                </Grid>
              </AccordionSummary>

              <AccordionDetails>
                {/* TIMELINE UI */}
                <Box>
                  <Typography variant="subtitle2" mb={1}>
                    Approval Timeline
                  </Typography>

                  <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                    <Box sx={{ display: "flex", gap: 1, alignItems: "center" }}>
                      <CheckCircleIcon color="success" fontSize="small" />
                      <Typography fontSize={14}>Submitted by Dealer</Typography>
                    </Box>

                    <Box sx={{ display: "flex", gap: 1, alignItems: "center" }}>
                      <HourglassEmptyIcon color="warning" fontSize="small" />
                      <Typography fontSize={14}>
                        Awaiting Manager Review
                      </Typography>
                    </Box>

                    <Box sx={{ display: "flex", gap: 1, alignItems: "center" }}>
                      <ErrorIcon color="disabled" fontSize="small" />
                      <Typography fontSize={14} color="text.secondary">
                        Pending Higher-Level Approval
                      </Typography>
                    </Box>
                  </Box>

                  {/* Dealer Info */}
                  <Box mt={2}>
                    <Typography variant="subtitle2">Dealer Info</Typography>
                    <Typography fontSize={14}>
                      Dealer ID: {item.dealerId}
                    </Typography>
                    <Typography fontSize={14}>
                      Dealer Name: {item.dealerName}
                    </Typography>
                    <Typography fontSize={14}>
                      Document Type: {item.documentType}
                    </Typography>
                  </Box>
                </Box>
              </AccordionDetails>
            </Accordion>
          ))}
        </Paper>
      </Box>
    </Box>
  );
}
</file>

<file path="src/pages/reports/RegionalSalesSummary.jsx">
// src/pages/reports/reportTypes/RegionalSalesSummary.jsx
import React, { useEffect } from "react";
import { Box, Grid, Paper, Typography } from "@mui/material";
import { ResponsiveContainer, PieChart, Pie, Cell, Legend, BarChart, Bar, XAxis, YAxis, Tooltip } from "recharts";
import KPISection from "./KPISection";
import ChartsBlock from "./ChartsBlock";
import DealerTable from "./DealerTable";

const COLORS = ["#F97316", "#0d9488", "#6366f1", "#dc2626", "#f59e0b", "#22d3ee"];

export default function RegionalSalesSummary({ data, loading, error, fetchReport, filters }) {
  useEffect(() => {
    // fetch automatically if no data
    if (!data) fetchReport();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  if (!data) return null;

  const { kpis = {}, dealerSalesChart = [], territoryContributionChart = [], productMixChart = [], table = [], highlights = {} } = data;

  return (
    <Box mt={3}>
      <KPISection
        items={[
          { title: "Total Sales", value: `‚Çπ${Number(kpis.totalSales || 0).toLocaleString()}`, color: "linear-gradient(135deg,#2563eb,#1e3a8a)" },
          { title: "Total Dealers", value: kpis.totalDealers || 0, color: "linear-gradient(135deg,#f97316,#c2410c)" },
          { title: "Top Territory", value: kpis.topTerritory || "-", color: "linear-gradient(135deg,#059669,#065f46)" },
          { title: "Top Product Group", value: kpis.topProductGroup || "-", color: "linear-gradient(135deg,#6366f1,#312e81)" },
        ]}
      />

      <Grid container spacing={2} mt={2}>
        <Grid item xs={12} md={6}>
          <ChartsBlock title="Territory Contribution">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie data={territoryContributionChart} dataKey="value" nameKey="name" outerRadius={90} label>
                  {territoryContributionChart.map((_, i) => (
                    <Cell key={i} fill={COLORS[i % COLORS.length]} />
                  ))}
                </Pie>
                <Legend />
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          </ChartsBlock>
        </Grid>

        <Grid item xs={12} md={6}>
          <ChartsBlock title="Product Mix">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={productMixChart}>
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="value" radius={[6, 6, 0, 0]}>
                  {productMixChart.map((_, i) => (
                    <Cell key={i} fill={COLORS[i % COLORS.length]} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </ChartsBlock>
        </Grid>
      </Grid>

      <Box mt={3}>
        <Paper sx={{ p: 2 }}>
          <Typography variant="h6" mb={2}>
            Highlights
          </Typography>

          <Grid container spacing={2}>
            <Grid item xs={12} md={6}>
              <Paper sx={{ p: 2, background: "#ecfdf5", border: "1px solid #d1fae5" }}>
                <Typography variant="subtitle2" color="#059669">
                  ‚≠ê Top Performing Dealer
                </Typography>
                <Typography fontWeight={700}>
                  {highlights.topDealer?.dealerName || "-"} ‚Äî ‚Çπ{Number(highlights.topDealer?.totalSales || 0).toLocaleString()}
                </Typography>
              </Paper>
            </Grid>

            <Grid item xs={12} md={6}>
              <Paper sx={{ p: 2, background: "#fef2f2", border: "1px solid #fee2e2" }}>
                <Typography variant="subtitle2" color="#dc2626">
                  ‚ö† Lowest Performing Dealer
                </Typography>
                <Typography fontWeight={700}>
                  {highlights.bottomDealer?.dealerName || "-"} ‚Äî ‚Çπ{Number(highlights.bottomDealer?.totalSales || 0).toLocaleString()}
                </Typography>
              </Paper>
            </Grid>
          </Grid>
        </Paper>
      </Box>

      <Box mt={3}>
        <DealerTable rows={table} />
      </Box>
    </Box>
  );
}
</file>

<file path="src/pages/reports/TerritorySummary.jsx">
// src/pages/reports/TerritorySummary.jsx
import React from "react";
import {
  Box,
  Grid,
  Paper,
  Typography,
  Divider,
} from "@mui/material";
import {
  PieChart,
  Pie,
  Tooltip,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  ResponsiveContainer,
  Cell,
} from "recharts";

const ACCENT = "#F97316";

const KPI_CARD = {
  p: 2,
  borderRadius: "16px",
  color: "white",
  minHeight: 110,
  display: "flex",
  flexDirection: "column",
  justifyContent: "center",
  boxShadow: "0 8px 25px rgba(0,0,0,0.15)",
};

const CHART_CARD = {
  p: 3,
  borderRadius: "16px",
  background: "white",
  boxShadow: "0 4px 18px rgba(0,0,0,0.08)",
};

const colors = ["#F97316", "#0d9488", "#6366f1", "#dc2626", "#16a34a", "#22d3ee"];

export default function TerritorySummary({ data, loading }) {
  if (loading)
    return (
      <Box sx={{ mt: 3, textAlign: "center" }}>
        <Typography>Loading‚Ä¶</Typography>
      </Box>
    );

  if (!data)
    return (
      <Box sx={{ mt: 3 }}>
        <Typography>Select filters and click Generate.</Typography>
      </Box>
    );

 // Safe parsing: prevents undefined.map crashes
const {
  kpis = {},
  dealerSalesChart = [],
  territoryContributionChart = [],
  productMixChart = [],
  highlights = {},
} = data || {};


  // For heatmap: determine max & % values
  const maxSales = Math.max(...territoryContributionChart.map((t) => t.value));

  const getHeatColor = (value) => {
    const ratio = value / maxSales;
    if (ratio > 0.75) return "#B91C1C"; // deep red
    if (ratio > 0.5) return "#DC2626"; // medium red
    if (ratio > 0.25) return "#F87171"; // light red
    return "#FECACA"; // pale red
  };

  return (
    <Box mt={3}>
      {/* KPI SECTION ----------------------------------------- */}
      <Grid container spacing={2}>
        <Grid item xs={12} md={3}>
          <Paper sx={{ ...KPI_CARD, background: "linear-gradient(135deg,#2563eb,#1e3a8a)" }}>
            <Typography variant="subtitle2">Total Sales</Typography>
            <Typography variant="h4" fontWeight={700}>
              ‚Çπ{kpis?.totalSales?.toLocaleString()}
            </Typography>
          </Paper>
        </Grid>

        <Grid item xs={12} md={3}>
          <Paper sx={{ ...KPI_CARD, background: "linear-gradient(135deg,#F97316,#C2410C)" }}>
            <Typography variant="subtitle2">Total Dealers</Typography>
            <Typography variant="h4" fontWeight={700}>
              {kpis?.totalDealers}
            </Typography>
          </Paper>
        </Grid>

        <Grid item xs={12} md={3}>
          <Paper sx={{ ...KPI_CARD, background: "linear-gradient(135deg,#059669,#065F46)" }}>
            <Typography variant="subtitle2">Top Territory</Typography>
            <Typography variant="h4" fontWeight={700}>
              {kpis?.topTerritory}
            </Typography>
          </Paper>
        </Grid>

        <Grid item xs={12} md={3}>
          <Paper sx={{ ...KPI_CARD, background: "linear-gradient(135deg,#6366f1,#312e81)" }}>
            <Typography variant="subtitle2">Top Product Group</Typography>
            <Typography variant="h4" fontWeight={700}>
              {kpis?.topProductGroup}
            </Typography>
          </Paper>
        </Grid>
      </Grid>

      {/* TERRITORY HEATMAP (Dynamic) ------------------------- */}
      <Box mt={4}>
        <Typography variant="h6" mb={1}>
          Territory Performance Heatmap
        </Typography>
        <Grid container spacing={2}>
          {territoryContributionChart.map((t, i) => (
            <Grid item xs={6} sm={4} md={3} lg={2} key={i}>
              <Paper
                sx={{
                  p: 2,
                  borderRadius: "16px",
                  textAlign: "center",
                  background: getHeatColor(t.value),
                  boxShadow: "0 4px 12px rgba(0,0,0,0.10)",
                }}
              >
                <Typography sx={{ fontWeight: 700 }}>{t.name}</Typography>
                <Typography sx={{ fontSize: 18, fontWeight: 700 }}>
                  ‚Çπ{t.value.toLocaleString()}
                </Typography>
              </Paper>
            </Grid>
          ))}
        </Grid>
      </Box>

      {/* CHARTS ------------------------------------------------ */}
      <Grid container spacing={2} mt={3}>
        {/* Territory Contribution Donut */}
        <Grid item xs={12} md={6}>
          <Paper sx={CHART_CARD}>
            <Typography variant="h6" mb={1}>
              Territory Contribution %
            </Typography>
            <Box sx={{ height: 300 }}>
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie data={territoryContributionChart} dataKey="value" nameKey="name" label>
                    {territoryContributionChart.map((_, i) => (
                      <Cell key={i} fill={colors[i % colors.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </Box>
          </Paper>
        </Grid>

        {/* Product Mix Bar */}
        <Grid item xs={12} md={6}>
          <Paper sx={CHART_CARD}>
            <Typography variant="h6" mb={1}>
              Product Group Mix
            </Typography>
            <Box sx={{ height: 300 }}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={productMixChart}>
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="value" radius={[6, 6, 0, 0]}>
                    {productMixChart.map((_, i) => (
                      <Cell key={i} fill={colors[i % colors.length]} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </Box>
          </Paper>
        </Grid>
      </Grid>

      {/* HIGHLIGHTS BLOCK ------------------------------------- */}
      <Box mt={4}>
        <Paper sx={{ p: 3, borderRadius: "16px", background: "white", boxShadow: "0 4px 14px rgba(0,0,0,0.08)" }}>
          <Typography variant="h6" mb={2}>
            Highlights
          </Typography>

          <Grid container spacing={2}>
            <Grid item xs={12} md={6}>
              <Paper sx={{ p: 2, borderRadius: "12px", background: "#ecfdf5", border: "1px solid #d1fae5" }}>
                <Typography variant="subtitle2" color="#059669">
                  ‚≠ê Top Performing Dealer
                </Typography>
                <Typography fontWeight={700}>
                  {highlights?.topDealer?.dealerName} ‚Äî ‚Çπ
                  {highlights?.topDealer?.totalSales?.toLocaleString()}
                </Typography>
              </Paper>
            </Grid>

            <Grid item xs={12} md={6}>
              <Paper sx={{ p: 2, borderRadius: "12px", background: "#fef2f2", border: "1px solid #fee2e2" }}>
                <Typography variant="subtitle2" color="#dc2626">
                  ‚ö† Lowest Performing Dealer
                </Typography>
                <Typography fontWeight={700}>
                  {highlights?.bottomDealer?.dealerName} ‚Äî ‚Çπ
                  {highlights?.bottomDealer?.totalSales?.toLocaleString()}
                </Typography>
              </Paper>
            </Grid>
          </Grid>
        </Paper>
      </Box>

      {/* LEADERBOARD TABLE ----------------------------------- */}
      <Box mt={4}>
        <Paper sx={{ p: 3, borderRadius: "16px", background: "white", boxShadow: "0 4px 14px rgba(0,0,0,0.08)" }}>
          <Typography variant="h6" mb={2}>
            Dealer Performance Table
          </Typography>

          <Box sx={{ overflowX: "auto" }}>
            <table style={{ width: "100%", borderCollapse: "collapse" }}>
              <thead>
                <tr style={{ background: "#f8fafc", borderBottom: "2px solid #e5e7eb" }}>
                  <th style={{ padding: "12px" }}>Dealer</th>
                  <th style={{ padding: "12px" }}>Code</th>
                  <th style={{ padding: "12px" }}>Territory</th>
                  <th style={{ padding: "12px" }}>Sales</th>
                </tr>
              </thead>
              <tbody>
                {dealerSalesChart?.map((row, idx) => (
                  <tr key={idx} style={{ borderBottom: "1px solid #e5e7eb" }}>
                    <td style={{ padding: "12px" }}>{row.dealerName}</td>
                    <td style={{ padding: "12px" }}>{row.dealerCode}</td>
                    <td style={{ padding: "12px" }}>{row.territory}</td>
                    <td style={{ padding: "12px" }}>‚Çπ{row.totalSales?.toLocaleString()}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </Box>
        </Paper>
      </Box>
    </Box>
  );
}
</file>

<file path="src/pages/superadmin/Roles.jsx">
import React, { useEffect, useState } from "react";
import api from "../../services/api";
import { toast } from "react-toastify";

export default function SuperAdminRolesPage() {
  const [roles, setRoles] = useState([]);
  const [permissions, setPermissions] = useState([]);

  const [roleModalOpen, setRoleModalOpen] = useState(false);
  const [permissionModalOpen, setPermissionModalOpen] = useState(false);
  const [assignModalOpen, setAssignModalOpen] = useState(false);

  const [newRole, setNewRole] = useState({ name: "", category: "", description: "" });
  const [newPermission, setNewPermission] = useState({ key: "", description: "" });

  const [selectedRole, setSelectedRole] = useState(null);
  const [selectedPermissions, setSelectedPermissions] = useState([]);

  // Fetch data
  const loadData = async () => {
    const r = await api.get("/roles");
    const p = await api.get("/permissions");
    setRoles(r.data);
    setPermissions(p.data);
  };

  useEffect(() => {
    loadData();
  }, []);

  // Create Role
  const createRole = async (e) => {
    e.preventDefault();
    try {
      await api.post("/roles", newRole);
      toast.success("Role created!");
      setRoleModalOpen(false);
      setNewRole({ name: "", category: "", description: "" });
      loadData();
    } catch (err) {
      toast.error("Failed to create role");
    }
  };

  // Create Permission
  const createPermission = async (e) => {
    e.preventDefault();
    try {
      await api.post("/permissions", newPermission);
      toast.success("Permission created!");
      setPermissionModalOpen(false);
      setNewPermission({ key: "", description: "" });
      loadData();
    } catch (err) {
      toast.error("Failed to create permission");
    }
  };

  // Assign permissions to role
  const assignPermissions = async () => {
    try {
      for (const pid of selectedPermissions) {
        await api.post("/roles/assign-permission", {
          roleId: selectedRole.id,
          permissionId: pid,
        });
      }
      toast.success("Permissions updated");
      setAssignModalOpen(false);
      loadData();
    } catch (err) {
      toast.error("Failed to assign permissions");
    }
  };

  const togglePermission = (pid) => {
    setSelectedPermissions((prev) =>
      prev.includes(pid)
        ? prev.filter((id) => id !== pid)
        : [...prev, pid]
    );
  };

  return (
    <div className="p-6">

      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-semibold">Roles & Permissions</h1>

        <div className="flex gap-3">
          <button
            onClick={() => setRoleModalOpen(true)}
            className="px-4 py-2 bg-blue-600 text-white rounded"
          >
            + Add Role
          </button>

          <button
            onClick={() => setPermissionModalOpen(true)}
            className="px-4 py-2 bg-green-600 text-white rounded"
          >
            + Add Permission
          </button>
        </div>
      </div>

      {/* Roles Table */}
      <div className="bg-white rounded shadow p-4">
        <h2 className="text-lg font-semibold mb-3">All Roles</h2>

        <table className="w-full border">
          <thead>
            <tr className="bg-gray-100 text-left">
              <th className="p-2 border">Name</th>
              <th className="p-2 border">Category</th>
              <th className="p-2 border">Permissions</th>
              <th className="p-2 border w-32">Actions</th>
            </tr>
          </thead>
          <tbody>
            {roles.map((role) => (
              <tr key={role.id}>
                <td className="p-2 border">{role.name}</td>
                <td className="p-2 border">{role.category || "-"}</td>
                <td className="p-2 border">
                  {role.permissions?.length === 0 && <span className="text-gray-500">None</span>}
                  {role.permissions?.map((p) => (
                    <span
                      key={p.id}
                      className="px-2 py-1 bg-gray-200 rounded text-xs mr-2"
                    >
                      {p.key}
                    </span>
                  ))}
                </td>
                <td className="p-2 border">
                  <button
                    onClick={() => {
                      setSelectedRole(role);
                      setSelectedPermissions(role.permissions.map((p) => p.id));
                      setAssignModalOpen(true);
                    }}
                    className="px-3 py-1 bg-orange-500 text-white rounded"
                  >
                    Assign
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Create Role Modal */}
      {roleModalOpen && (
        <Modal onClose={() => setRoleModalOpen(false)} title="Create Role">
          <form onSubmit={createRole} className="grid gap-3">
            <input
              placeholder="Role Name"
              className="border p-2 rounded"
              value={newRole.name}
              onChange={(e) => setNewRole({ ...newRole, name: e.target.value })}
              required
            />
            <input
              placeholder="Category"
              className="border p-2 rounded"
              value={newRole.category}
              onChange={(e) => setNewRole({ ...newRole, category: e.target.value })}
            />
            <textarea
              placeholder="Description"
              className="border p-2 rounded"
              value={newRole.description}
              onChange={(e) => setNewRole({ ...newRole, description: e.target.value })}
            />

            <button className="bg-blue-600 text-white py-2 rounded">Create</button>
          </form>
        </Modal>
      )}

      {/* Create Permission Modal */}
      {permissionModalOpen && (
        <Modal onClose={() => setPermissionModalOpen(false)} title="Create Permission">
          <form onSubmit={createPermission} className="grid gap-3">
            <input
              placeholder="Permission Key"
              className="border p-2 rounded"
              value={newPermission.key}
              onChange={(e) =>
                setNewPermission({ ...newPermission, key: e.target.value })
              }
              required
            />
            <textarea
              placeholder="Description"
              className="border p-2 rounded"
              value={newPermission.description}
              onChange={(e) =>
                setNewPermission({ ...newPermission, description: e.target.value })
              }
            />
            <button className="bg-green-600 text-white py-2 rounded">Create</button>
          </form>
        </Modal>
      )}

      {/* Assign Permissions Modal */}
      {assignModalOpen && (
        <Modal onClose={() => setAssignModalOpen(false)} title={`Assign Permissions to ${selectedRole?.name}`}>
          <div className="grid gap-2 max-h-80 overflow-y-auto p-2">
            {permissions.map((p) => (
              <label key={p.id} className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={selectedPermissions.includes(p.id)}
                  onChange={() => togglePermission(p.id)}
                />
                {p.key}
              </label>
            ))}
          </div>

          <button
            onClick={assignPermissions}
            className="w-full mt-4 bg-orange-500 text-white py-2 rounded"
          >
            Save Permissions
          </button>
        </Modal>
      )}
    </div>
  );
}

// Simple modal component
function Modal({ title, onClose, children }) {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold">{title}</h2>
          <button onClick={onClose} className="text-gray-500">‚úï</button>
        </div>
        {children}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/superadmin/Users.jsx">
// src/pages/superadmin/Users.jsx
import React, { useEffect, useMemo, useState, useRef } from "react";
import api from "../../services/api";
import {
  FaEdit,
  FaTrash,
  FaPlus,
  FaSearch,
  FaSort,
  FaSortUp,
  FaSortDown,
} from "react-icons/fa";

/**
 * Users.jsx
 *
 * - Works with backend responses like: { users: [...], total?, totalPages? }
 * - Features:
 *   ‚Ä¢ Search (debounced)
 *   ‚Ä¢ Filters (role / dealer / region)
 *   ‚Ä¢ Sorting
 *   ‚Ä¢ Pagination (works if backend returns total/totalPages, otherwise basic)
 *   ‚Ä¢ Add / Edit user modal (assign role, dealer, region)
 *   ‚Ä¢ Selecting a region in the modal filters dealers to that region
 *   ‚Ä¢ When editing/creating a user, the backend endpoint is called and (server-side)
 *     dealer.regionId will be updated as needed (this file expects that server logic)
 *   ‚Ä¢ Bulk actions: delete / activate / deactivate
 *
 * Copy-paste ready.
 */

export default function Users() {
  // data
  const [users, setUsers] = useState([]);
  const [roles, setRoles] = useState([]);
  const [dealers, setDealers] = useState([]);
  const [regions, setRegions] = useState([]);

  // ui state
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(10);
  const [totalPages, setTotalPages] = useState(1);
  const [total, setTotal] = useState(0);

  // search / filters / sort
  const [searchTerm, setSearchTerm] = useState("");
  const [filterRole, setFilterRole] = useState("");
  const [filterDealer, setFilterDealer] = useState("");
  const [filterRegion, setFilterRegion] = useState("");
  const [sortBy, setSortBy] = useState("createdAt");
  const [sortOrder, setSortOrder] = useState("desc");

  // modal / form
  const [modalOpen, setModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [form, setForm] = useState({
    username: "",
    email: "",
    password: "",
    roleId: "",
    dealerId: "",
    regionId: "",
    isActive: true,
  });

  // bulk selection
  const [selected, setSelected] = useState(new Set());

  // debounce for search
  const debounceRef = useRef(null);
  useEffect(() => {
    // whenever filter/sort/pageSize/searchTerm changes, reset to page 1 and fetch
    if (debounceRef.current) clearTimeout(debounceRef.current);
    debounceRef.current = setTimeout(() => {
      setPage(1);
      fetchData(1);
    }, 350);

    return () => clearTimeout(debounceRef.current);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchTerm, filterRole, filterDealer, filterRegion, sortBy, sortOrder, pageSize]);

  // fetch data
  const fetchData = async (requestedPage = page) => {
    try {
      setLoading(true);

      const params = {
        page: requestedPage,
        pageSize,
        search: searchTerm || undefined,
        role: filterRole || undefined,
        dealer: filterDealer || undefined,
        region: filterRegion || undefined,
        sort: sortBy,
        order: sortOrder,
      };

      const [usersRes, rolesRes, dealersRes, regionsRes] = await Promise.all([
        api.get("/admin/users", { params }),
        api.get("/roles"),
        api.get("/dealers"),
        api.get("/regions"),
      ]);

      // Users (normalize)
      // Backend might return { users: [...] } or { data: [...] } or array
      const usersData = usersRes?.data?.users ?? usersRes?.data?.data ?? usersRes?.data ?? [];
      setUsers(Array.isArray(usersData) ? usersData : []);

      // Pagination metadata (if any)
      const totalFromRes = usersRes?.data?.total ?? usersRes?.data?.totalCount ?? null;
      const totalPagesFromRes = usersRes?.data?.totalPages ?? null;
      setTotal(totalFromRes ?? usersData.length);
      if (totalPagesFromRes) setTotalPages(totalPagesFromRes);
      else setTotalPages(Math.max(1, Math.ceil((totalFromRes ?? usersData.length) / pageSize)));

      // Roles / Dealers / Regions normalization (safe access)
      setRoles(rolesRes?.data?.roles ?? rolesRes?.data ?? []);
      setDealers(dealersRes?.data?.dealers ?? dealersRes?.data ?? []);
      setRegions(regionsRes?.data?.regions ?? regionsRes?.data ?? []);
    } catch (err) {
      console.error("Failed to load users & meta:", err);
      alert("Failed to load data. See console for details.");
    } finally {
      setLoading(false);
    }
  };

  // initial load + page changes
  useEffect(() => {
    fetchData(page);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [page]);

  // helpers
  const resetForm = () => {
    setForm({
      username: "",
      email: "",
      password: "",
      roleId: "",
      dealerId: "",
      regionId: "",
      isActive: true,
    });
    setEditingUser(null);
  };

  const openEdit = (user) => {
    setEditingUser(user);
    setForm({
      username: user.username ?? "",
      email: user.email ?? "",
      password: "",
      roleId: user.roleId ?? user.role ?? "",
      dealerId: user.dealerId ?? user.dealerId ?? user.dealer ?? "",
      regionId: user.regionId ?? user.regionId ?? "",
      isActive: typeof user.isActive === "boolean" ? user.isActive : true,
    });
    setModalOpen(true);
  };

  const openAdd = () => {
    resetForm();
    setModalOpen(true);
  };

  const handleInput = (e) => {
    const { name, value, type, checked } = e.target;
    setForm((prev) => {
      const next = { ...prev, [name]: type === "checkbox" ? checked : value };

      // If region changed in modal, clear dealer selection (so dealer chosen matches region)
      if (name === "regionId") next.dealerId = "";
      return next;
    });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      setSaving(true);

      const payload = {
        username: form.username,
        email: form.email,
        password: form.password || undefined, // don't send empty password if editing
        roleId: form.roleId || undefined,
        dealerId: form.dealerId || null,
        regionId: form.regionId || null,
        isActive: form.isActive,
      };

      if (editingUser) {
        await api.put(`/admin/users/${editingUser.id}`, payload);
      } else {
        await api.post(`/admin/users`, payload);
      }

      setModalOpen(false);
      resetForm();
      fetchData(1);
    } catch (err) {
      console.error("Save user error:", err);
      // try to show server message if present
      const serverMsg = err?.response?.data?.error ?? err?.response?.data?.message;
      alert(serverMsg || "Failed to save user - check console.");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (id) => {
    if (!window.confirm("Delete this user? This action is irreversible.")) return;
    try {
      await api.delete(`/admin/users/${id}`);
      fetchData(1);
    } catch (err) {
      console.error("Delete user:", err);
      alert("Failed to delete user");
    }
  };

  const toggleActive = async (user) => {
    try {
      await api.put(`/admin/users/${user.id}`, { ...user, isActive: !user.isActive });
      fetchData(page);
    } catch (err) {
      console.error("Toggle active:", err);
      alert("Failed to change active status");
    }
  };

  // sorting
  const toggleSort = (column) => {
    if (sortBy === column) {
      setSortOrder((o) => (o === "asc" ? "desc" : "asc"));
    } else {
      setSortBy(column);
      setSortOrder("asc");
    }
    setPage(1);
    fetchData(1);
  };

  const renderSortIcon = (column) => {
    if (sortBy !== column) return <FaSort className="inline-block ml-2 opacity-50" />;
    return sortOrder === "asc" ? <FaSortUp className="inline-block ml-2" /> : <FaSortDown className="inline-block ml-2" />;
  };

  // bulk selection
  const toggleSelect = (id) => {
    setSelected((s) => {
      const copy = new Set(s);
      if (copy.has(id)) copy.delete(id);
      else copy.add(id);
      return copy;
    });
  };

  const toggleSelectAll = () => {
    if (selected.size === users.length) {
      setSelected(new Set());
    } else {
      setSelected(new Set(users.map((u) => u.id)));
    }
  };

  const bulkDelete = async () => {
    if (selected.size === 0) {
      alert("Select at least one user.");
      return;
    }
    if (!window.confirm(`Delete ${selected.size} users?`)) return;
    try {
      setLoading(true);
      // replace with a real bulk endpoint if available for performance
      await Promise.all(Array.from(selected).map((id) => api.delete(`/admin/users/${id}`)));
      setSelected(new Set());
      fetchData(1);
    } catch (err) {
      console.error("Bulk delete failed:", err);
      alert("Some deletes failed. See console.");
    } finally {
      setLoading(false);
    }
  };

  const bulkSetActive = async (active) => {
    if (selected.size === 0) {
      alert("Select at least one user.");
      return;
    }
    if (!window.confirm(`${active ? "Activate" : "Deactivate"} ${selected.size} users?`)) return;
    try {
      setLoading(true);
      await Promise.all(Array.from(selected).map((id) => api.put(`/admin/users/${id}`, { isActive: active })));
      setSelected(new Set());
      fetchData(page);
    } catch (err) {
      console.error("Bulk update active failed:", err);
      alert("Bulk update failed");
    } finally {
      setLoading(false);
    }
  };

  // derived UI values
  const selectedCount = selected.size;
  const isAllSelected = users.length > 0 && selected.size === users.length;

  // memoized options
  const roleOptions = useMemo(() => roles, [roles]);
  const dealerOptions = useMemo(() => dealers, [dealers]);
  const regionOptions = useMemo(() => regions, [regions]);

  // When modal region selected, filter dealers shown in modal
  const filteredDealersForModal = useMemo(() => {
    if (!form.regionId) return dealerOptions;
    return dealerOptions.filter((d) => {
      // dealer.table may store regionId as "regionId" or "RegionId" ‚Äî handle both
      return (d.regionId ?? d.RegionId ?? d.regionId ?? null) === form.regionId;
    });
  }, [dealerOptions, form.regionId]);

  // pagination helpers
  const gotoPage = (p) => {
    const newPage = Math.max(1, Math.min(p, totalPages));
    setPage(newPage);
    fetchData(newPage);
  };

  // small UI components
  const Badge = ({ children, color = "gray" }) => {
    const bg = {
      green: "bg-green-100 text-green-800",
      red: "bg-red-100 text-red-800",
      yellow: "bg-yellow-100 text-yellow-800",
      blue: "bg-blue-100 text-blue-800",
      gray: "bg-gray-100 text-gray-800",
    }[color];
    return <span className={`px-2 py-1 rounded-full text-xs font-medium ${bg}`}>{children}</span>;
  };

  return (
    <div className="p-6">
      {/* Header */}
      <div className="flex items-center justify-between mb-4 gap-4">
        <div>
          <h1 className="text-2xl font-bold">User Management</h1>
          <p className="text-sm text-gray-500">Manage users, roles, dealers, and regions.</p>
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={openAdd}
            className="inline-flex items-center gap-2 bg-orange-500 text-white px-4 py-2 rounded shadow hover:opacity-95"
          >
            <FaPlus /> Add User
          </button>

          <div className="flex items-center gap-2">
            <button onClick={() => bulkSetActive(true)} className="px-3 py-2 border rounded hover:bg-green-50" title="Activate selected">
              Activate
            </button>
            <button onClick={() => bulkSetActive(false)} className="px-3 py-2 border rounded hover:bg-yellow-50" title="Deactivate selected">
              Deactivate
            </button>
            <button onClick={bulkDelete} className="px-3 py-2 border rounded hover:bg-red-50 text-red-600" title="Delete selected">
              Delete
            </button>
          </div>
        </div>
      </div>

      {/* Filters/Search */}
      <div className="flex flex-col md:flex-row gap-3 items-start md:items-end mb-4">
        <div className="relative flex items-center w-full md:w-96">
          <FaSearch className="absolute left-3 text-gray-400" />
          <input
            className="pl-10 pr-3 py-2 border rounded w-full"
            placeholder="Search by username or email..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>

        <select
          value={filterRole}
          onChange={(e) => {
            setFilterRole(e.target.value);
            setPage(1);
            fetchData(1);
          }}
          className="border px-2 py-2 rounded"
        >
          <option value="">All Roles</option>
          {roleOptions.map((r) => (
            <option key={r.id} value={r.id}>
              {r.name}
            </option>
          ))}
        </select>

        <select
          value={filterDealer}
          onChange={(e) => {
            setFilterDealer(e.target.value);
            setPage(1);
            fetchData(1);
          }}
          className="border px-2 py-2 rounded"
        >
          <option value="">All Dealers</option>
          {dealerOptions.map((d) => (
            <option key={d.id} value={d.id}>
              {d.businessName}
            </option>
          ))}
        </select>

        <select
          value={filterRegion}
          onChange={(e) => {
            setFilterRegion(e.target.value);
            setPage(1);
            fetchData(1);
          }}
          className="border px-2 py-2 rounded"
        >
          <option value="">All Regions</option>
          {regionOptions.map((r) => (
            <option key={r.id} value={r.id}>
              {r.name}
            </option>
          ))}
        </select>

        <select
          value={pageSize}
          onChange={(e) => {
            setPageSize(Number(e.target.value));
            setPage(1);
            fetchData(1);
          }}
          className="border px-2 py-2 rounded"
        >
          <option value={5}>5 / page</option>
          <option value={10}>10 / page</option>
          <option value={25}>25 / page</option>
          <option value={50}>50 / page</option>
        </select>
      </div>

      {/* Table */}
      <div className="overflow-x-auto border rounded">
        <table className="min-w-full divide-y">
          <thead className="bg-gray-50">
            <tr>
              <th className="p-3">
                <input type="checkbox" checked={isAllSelected} onChange={toggleSelectAll} />
              </th>
              <th className="p-3 text-left cursor-pointer" onClick={() => toggleSort("username")}>
                Username {renderSortIcon("username")}
              </th>
              <th className="p-3 text-left cursor-pointer" onClick={() => toggleSort("email")}>
                Email {renderSortIcon("email")}
              </th>
              <th className="p-3 text-left">Role</th>
              <th className="p-3 text-left">Dealer</th>
              <th className="p-3 text-left">Region</th>
              <th className="p-3 text-left cursor-pointer" onClick={() => toggleSort("isActive")}>
                Status {renderSortIcon("isActive")}
              </th>
              <th className="p-3 text-left">Actions</th>
            </tr>
          </thead>

          <tbody className="bg-white divide-y">
            {loading ? (
              <tr>
                <td colSpan={8} className="p-6 text-center text-gray-500">
                  Loading...
                </td>
              </tr>
            ) : users.length === 0 ? (
              <tr>
                <td colSpan={8} className="p-6 text-center text-gray-500">
                  No users found.
                </td>
              </tr>
            ) : (
              users.map((u) => (
                <tr key={u.id} className="hover:bg-gray-50">
                  <td className="p-3">
                    <input type="checkbox" checked={selected.has(u.id)} onChange={() => toggleSelect(u.id)} />
                  </td>

                  <td className="p-3">
                    <div className="font-medium">{u.username}</div>
                    <div className="text-xs text-gray-500">{u.email}</div>
                  </td>

                  <td className="p-3 text-sm">{u.email}</td>

                  <td className="p-3">
                    <div className="inline-block">
                      <Badge color="blue">{u.role ?? u.roleName ?? "‚Äî"}</Badge>
                    </div>
                  </td>

                  <td className="p-3">
                    {u.dealer ? (
                      <div>
                        <div className="font-medium">{u.dealer.businessName}</div>
                        <div className="text-xs text-gray-500">{u.dealer.dealerCode || ""}</div>
                      </div>
                    ) : u.dealerId ? (
                      <div className="text-sm text-gray-700">Dealer ID: {u.dealerId}</div>
                    ) : (
                      <span className="text-sm text-gray-400">‚Äî</span>
                    )}
                  </td>

                  <td className="p-3">
                    {u.region ? <Badge color="green">{u.region.name}</Badge> : u.regionId ? <Badge color="gray">assigned</Badge> : <span className="text-sm text-gray-400">‚Äî</span>}
                  </td>

                  <td className="p-3">
                    {u.isBlocked ? (
                      <Badge color="red">Blocked</Badge>
                    ) : u.isActive ? (
                      <Badge color="green">Active</Badge>
                    ) : (
                      <Badge color="yellow">Inactive</Badge>
                    )}
                  </td>

                  <td className="p-3 flex gap-2">
                    <button onClick={() => openEdit(u)} className="text-blue-600 hover:underline">
                      <FaEdit />
                    </button>
                    <button onClick={() => handleDelete(u.id)} className="text-red-600 hover:underline">
                      <FaTrash />
                    </button>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Pagination & summary */}
      <div className="flex items-center justify-between gap-4 mt-4">
        <div className="text-sm text-gray-600">
          Showing page {page} of {totalPages} ‚Äî {total ?? users.length} total
        </div>

        <div className="flex items-center gap-2">
          <button onClick={() => gotoPage(1)} disabled={page === 1} className="px-3 py-1 border rounded disabled:opacity-50">
            ¬´ First
          </button>
          <button onClick={() => gotoPage(page - 1)} disabled={page === 1} className="px-3 py-1 border rounded disabled:opacity-50">
            ‚Äπ Prev
          </button>

          <span className="px-3 py-1 border rounded bg-gray-50">{page}</span>

          <button onClick={() => gotoPage(page + 1)} disabled={page === totalPages} className="px-3 py-1 border rounded disabled:opacity-50">
            Next ‚Ä∫
          </button>
          <button onClick={() => gotoPage(totalPages)} disabled={page === totalPages} className="px-3 py-1 border rounded disabled:opacity-50">
            Last ¬ª
          </button>
        </div>
      </div>

      {/* Modal */}
      {modalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-semibold">{editingUser ? "Edit User" : "Add User"}</h2>
              <button onClick={() => { setModalOpen(false); resetForm(); }} className="text-gray-500">Close</button>
            </div>

            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-medium mb-1">Username</label>
                <input name="username" value={form.username} onChange={handleInput} required className="w-full border px-3 py-2 rounded" />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Email</label>
                <input name="email" type="email" value={form.email} onChange={handleInput} required className="w-full border px-3 py-2 rounded" />
              </div>

              {!editingUser && (
                <div>
                  <label className="block text-sm font-medium mb-1">Password</label>
                  <input name="password" type="password" value={form.password} onChange={handleInput} required className="w-full border px-3 py-2 rounded" />
                </div>
              )}

              <div>
                <label className="block text-sm font-medium mb-1">Role</label>
                <select name="roleId" value={form.roleId} onChange={handleInput} required className="w-full border px-3 py-2 rounded">
                  <option value="">Select role</option>
                  {roleOptions.map((r) => <option key={r.id} value={r.id}>{r.name}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Region</label>
                <select name="regionId" value={form.regionId || ""} onChange={handleInput} className="w-full border px-3 py-2 rounded">
                  <option value="">Select region</option>
                  {regionOptions.map((r) => <option key={r.id} value={r.id}>{r.name}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Dealer</label>
                <select name="dealerId" value={form.dealerId || ""} onChange={handleInput} className="w-full border px-3 py-2 rounded">
                  <option value="">Select dealer</option>
                  {filteredDealersForModal.map((d) => <option key={d.id} value={d.id}>{d.businessName}</option>)}
                </select>
              </div>

              <div className="flex items-center gap-2">
                <input type="checkbox" name="isActive" checked={form.isActive} onChange={handleInput} />
                <label className="text-sm">Active</label>
              </div>

              <div className="md:col-span-2 flex justify-end gap-2 mt-3">
                <button type="button" onClick={() => { setModalOpen(false); resetForm(); }} className="px-4 py-2 border rounded">Cancel</button>
                <button type="submit" disabled={saving} className="px-4 py-2 bg-orange-500 text-white rounded">{saving ? "Saving..." : (editingUser ? "Update user" : "Create user")}</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    react({
      babel: {
        plugins: [['babel-plugin-react-compiler']],
      },
    }),
  ],
})
</file>

<file path="src/components/DonutProgress.jsx">
import React from "react";
import { PieChart, Pie, Cell, ResponsiveContainer } from "recharts";

export default function DonutProgress({ value = 0, total = 100, colors = ["#f97316", "#1f2937"], center, label }) {
  const safeTotal = total <= 0 ? 1 : total;
  const percent = Math.max(0, Math.min(100, Math.round((value / safeTotal) * 100)));
  const data = [
    { name: "value", value: Math.max(0, value) },
    { name: "rest", value: Math.max(0, safeTotal - value) },
  ];
  return (
    <div style={{ display: "flex", alignItems: "center", gap: "1rem" }}>
      <div style={{ width: 120, height: 120 }}>
        <ResponsiveContainer width="100%" height="100%">
          <PieChart>
            <Pie
              data={data}
              innerRadius={48}
              outerRadius={58}
              paddingAngle={2}
              dataKey="value"
              startAngle={90}
              endAngle={-270}
            >
              {data.map((entry, index) => (
                <Cell key={`cell-${index}`} fill={colors[index] || colors[0]} />
              ))}
            </Pie>
          </PieChart>
        </ResponsiveContainer>
      </div>
      <div>
        {label && <div style={{ color: "#94a3b8" }}>{label}</div>}
        <div style={{ fontSize: "1.6rem", fontWeight: 700, color: "#e2e8f0" }}>{percent}%</div>
        {center}
      </div>
    </div>
  );
}
</file>

<file path="src/components/IconPillButton.jsx">
import React from "react";

export default function IconPillButton({ icon, label, onClick, tone = "primary" }) {
  const tones = {
    primary: "linear-gradient(90deg, #f97316, #ea580c)",
    success: "linear-gradient(90deg, #22c55e, #16a34a)",
    warning: "linear-gradient(90deg, #f59e0b, #d97706)",
    danger: "linear-gradient(90deg, #ef4444, #b91c1c)",
  };
  return (
    <button
      onClick={onClick}
      style={{
        border: "none",
        borderRadius: 9999,
        padding: "0.5rem 0.9rem",
        color: "#fff",
        display: "flex",
        alignItems: "center",
        gap: "0.5rem",
        background: tones[tone] || tones.primary,
        boxShadow: "0 0 12px rgba(0,0,0,0.25)",
        cursor: "pointer",
      }}
    >
      {icon && <span>{icon}</span>}
      <span style={{ fontWeight: 600 }}>{label}</span>
    </button>
  );
}
</file>

<file path="src/components/PageHeader.jsx">
import React from "react";

export default function PageHeader({ title, subtitle, actions }) {
  return (
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-end", gap: "1rem", marginBottom: "1.25rem" }}>
      <div>
        <h2 style={{ fontSize: "2rem", margin: 0, color: "#f97316" }}>{title}</h2>
        {subtitle && (
          <p style={{ marginTop: "0.25rem", color: "#94a3b8" }}>{subtitle}</p>
        )}
      </div>
      {actions && <div style={{ display: "flex", gap: "0.5rem" }}>{actions}</div>}
    </div>
  );
}
</file>

<file path="src/components/SparklineMini.jsx">
import React from "react";
import { AreaChart, Area, ResponsiveContainer } from "recharts";

export default function SparklineMini({ data, color = "#f97316" }) {
  return (
    <div style={{ width: "100%", height: 60 }}>
      <ResponsiveContainer width="100%" height="100%">
        <AreaChart data={data} margin={{ top: 6, right: 0, bottom: 0, left: 0 }}>
          <defs>
            <linearGradient id="spark" x1="0" y1="0" x2="0" y2="1">
              <stop offset="5%" stopColor={color} stopOpacity={0.7} />
              <stop offset="95%" stopColor={color} stopOpacity={0.05} />
            </linearGradient>
          </defs>
          <Area type="monotone" dataKey="v" stroke={color} fill="url(#spark)" strokeWidth={2} />
        </AreaChart>
      </ResponsiveContainer>
    </div>
  );
}
</file>

<file path="src/components/StatCard.jsx">
import React from "react";

export default function StatCard({ title, value, icon, accent = "#f97316" }) {
  return (
    <div
      className="card hover-glow"
      style={{ display: "flex", flexDirection: "column", gap: "0.25rem" }}
    >
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
        <div style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
          {icon && <span style={{ fontSize: "1.35rem" }}>{icon}</span>}
          <h4 style={{ margin: 0 }}>{title}</h4>
        </div>
        <div style={{ width: 8, height: 8, borderRadius: 9999, background: accent }} />
      </div>
      <div style={{ fontSize: "1.8rem", fontWeight: 700, color: accent }}>{value}</div>
    </div>
  );
}
</file>

<file path="src/context/AuthContext.jsx">
import React, { createContext, useState, useContext, useEffect } from "react";
import api from "../services/api";

export const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(JSON.parse(localStorage.getItem("user")) || null);
  const [token, setToken] = useState(localStorage.getItem("token") || null);
  const [loading, setLoading] = useState(false);

  const login = async (username, password) => {
    const res = await api.post("/auth/login", { username, password });
    return res.data;
  };

  const verifyOTP = async (userId, otp) => {
    const res = await api.post("/auth/verify-otp", { userId, otp });
    const { token, user } = res.data;

    localStorage.setItem("token", token);
    localStorage.setItem("user", JSON.stringify(user));

    setToken(token);
    setUser(user);

    return user;
  };

  const logout = () => {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    setUser(null);
    setToken(null);
  };

  return (
    <AuthContext.Provider value={{ user, token, login, verifyOTP, loading, logout }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => useContext(AuthContext);
</file>

<file path="src/pages/AdminDocuments.jsx">
// src/pages/AdminDocuments.jsx
import React, { useEffect, useState } from "react";
import api from "../services/api";
import DataTable from "../components/DataTable";
import EmptyState from "../components/EmptyState";

export default function AdminDocuments() {
  const [documents, setDocuments] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState("all"); // all | pending | approved | rejected

  const fetchDocuments = async () => {
    try {
      const res = await api.get("/documents");
      setDocuments(res.data.documents || []);
    } catch (err) {
      console.error("Error loading documents:", err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchDocuments();
  }, []);

  const handleReview = async (id, action) => {
    const remarks = prompt(`Remarks for ${action}?`) || "";
    try {
      await api.patch(`/documents/${id}/status`, { action, remarks });
      fetchDocuments();
    } catch (err) {
      console.error("Review failed:", err);
    }
  };

  const filtered = documents.filter((d) =>
    filter === "all" ? true : d.status === filter
  );

  if (loading) return <p style={{ padding: "2rem" }}>Loading...</p>;

  return (
    <div style={{ padding: "2rem" }}>
      <h1 style={{ marginBottom: "1rem", color: "#cbd5e1" }}>üìÑ Document Approvals</h1>

      {/* FILTER BUTTONS */}
      <div style={{ marginBottom: "1rem", display: "flex", gap: "0.5rem" }}>
        {["all", "pending", "approved", "rejected"].map((f) => (
          <button
            key={f}
            onClick={() => setFilter(f)}
            style={{
              padding: "6px 14px",
              borderRadius: 6,
              border: "1px solid rgba(255,255,255,0.1)",
              background: filter === f ? "#f97316" : "transparent",
              color: filter === f ? "#fff" : "#cbd5e1",
              cursor: "pointer",
              transition: "0.2s",
            }}
          >
            {f.toUpperCase()}
          </button>
        ))}
      </div>

      {/* TABLE OR EMPTY */}
      {filtered.length === 0 ? (
        <EmptyState
          icon="üìÇ"
          title="No documents"
          description="No documents found for the selected filter."
        />
      ) : (
        <DataTable
          columns={[
            { key: "id", label: "ID" },
            { key: "dealerName", label: "Dealer" },
            { key: "type", label: "Document Type" },
            { key: "uploadedAt", label: "Uploaded" },
            {
              key: "status",
              label: "Status",
              render: (v) => (
                <span
                  style={{
                    padding: "4px 10px",
                    borderRadius: 20,
                    fontSize: 12,
                    color: "#fff",
                    background:
                      v === "approved"
                        ? "#22c55e"
                        : v === "rejected"
                        ? "#ef4444"
                        : "#f59e0b",
                  }}
                >
                  {v.toUpperCase()}
                </span>
              ),
            },
            {
              key: "actions",
              label: "Actions",
              render: (_, row) =>
                row.status === "pending" ? (
                  <div style={{ display: "flex", gap: "0.5rem" }}>
                    <button
                      style={{
                        padding: "4px 10px",
                        borderRadius: 6,
                        border: "none",
                        background: "#22c55e",
                        color: "#fff",
                        cursor: "pointer",
                      }}
                      onClick={() => handleReview(row.id, "approve")}
                    >
                      Approve
                    </button>

                    <button
                      style={{
                        padding: "4px 10px",
                        borderRadius: 6,
                        border: "none",
                        background: "#ef4444",
                        color: "#fff",
                        cursor: "pointer",
                      }}
                      onClick={() => handleReview(row.id, "reject")}
                    >
                      Reject
                    </button>
                  </div>
                ) : (
                  "‚Äî"
                ),
            },
          ]}
          rows={filtered.map((d) => ({
            id: d.id,
            dealerName: d.dealerName || d.dealerId,
            type: d.documentType,
            uploadedAt: new Date(d.createdAt).toLocaleDateString(),
            status: d.status,
          }))}
          emptyMessage="No documents"
        />
      )}
    </div>
  );
}
</file>

<file path="src/pages/Chat.css">
.chat-container {
  display: flex;
  height: 80vh;
  border-radius: 10px;
  overflow: hidden;
  background: var(--card-bg, #fff);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.chat-sidebar {
  width: 250px;
  background: #f3f4f6;
  border-right: 1px solid #e5e7eb;
  padding: 1rem;
  overflow-y: auto;
}

.chat-sidebar h2 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 1rem;
}

.dealer-item {
  padding: 8px 10px;
  margin-bottom: 5px;
  border-radius: 8px;
  cursor: pointer;
  background: #fff;
}

.dealer-item:hover {
  background: #e0f2fe;
}

.dealer-item.active {
  background: #3b82f6;
  color: white;
}

.chat-main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 10px 15px;
  background: #3b82f6;
  color: white;
  font-weight: 600;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  background: #f9fafb;
}

.message-bubble {
  max-width: 60%;
  margin: 8px 0;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 14px;
}

.message-bubble.incoming {
  background: #e5e7eb;
  align-self: flex-start;
}

.message-bubble.outgoing {
  background: #3b82f6;
  color: white;
  align-self: flex-end;
}

/* Avatars and WhatsApp-like layout */
.contact-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  font-size: 14px;
}

.message-row {
  display: flex;
  align-items: flex-end;
  gap: 10px;
  margin: 8px 0;
}

.message-avatar-col {
  width: 44px;
  display: flex;
  justify-content: center;
}

.message-content {
  max-width: 72%;
  padding: 10px 14px;
  border-radius: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

.message-content.incoming {
  background: #ffffff;
  color: #111827;
  align-self: flex-start;
}

.message-content.outgoing {
  background: #25D366; /* whatsapp green */
  color: #fff;
  align-self: flex-end;
}

.msg-text { font-size: 14px; }
.msg-meta { font-size: 11px; opacity: 0.6; margin-top: 6px; text-align: right; }

.incoming-row { justify-content: flex-start; }
.outgoing-row { justify-content: flex-end; }

.chat-input {
  display: flex;
  padding: 10px;
  border-top: 1px solid #e5e7eb;
}

.chat-input input {
  flex: 1;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
}

.chat-input button {
  margin-left: 10px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  cursor: pointer;
}
</file>

<file path="src/pages/dashboards/SuperAdminDashboard.jsx">
import React, { useEffect, useState } from "react";
import api from "../../services/api";
import Chart from "react-apexcharts";

export default function SuperAdminDashboard() {
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
    kpis: {},
    charts: {
      userGrowth: [],
      docsPerMonth: [],
      
      pricingTrend: [],
      dealerDistribution: [],
    },
    recentActivity: []
  });

  useEffect(() => {
    async function load() {
      try {
        const res = await api.get("/admin/reports");
        setStats(res.data);
      } catch (e) {
        console.error("Failed to load dashboard:", e);
      } finally {
        setLoading(false);
      }
    }
    load();
  }, []);

  if (loading) return <p>Loading dashboard...</p>;

  const k = stats.kpis;
  const c = stats.charts;

  return (
    <div style={{ padding: "2rem" }}>
      <h1 style={{ fontSize: "2rem", fontWeight: 700, marginBottom: "1rem" }}>
        Super Admin Dashboard
      </h1>

      {/* KPI GRID */}
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(auto-fit, minmax(240px, 1fr))",
          gap: "1.5rem",
          marginBottom: "2rem",
        }}
      >
        <KPI title="Total Users" value={k.totalUsers} color="#3b82f6" />
        <KPI title="Total Roles" value={k.totalRoles} color="#8b5cf6" />
        <KPI title="Total Dealers" value={k.totalDealers} color="#10b981" />
        <KPI title="Documents" value={k.totalDocuments} color="#f59e0b" />
        <KPI title="Pricing Updates" value={k.totalPricingUpdates} color="#ef4444" />

        <KPI title="Pending Docs" value={k.pendingDocuments} color="#eab308" />
        <KPI title="Approved Docs" value={k.approvedDocuments} color="#22c55e" />
        <KPI title="Rejected Docs" value={k.rejectedDocuments} color="#dc2626" />

        <KPI title="Pending Pricing" value={k.pendingPricing} color="#eab308" />
        <KPI title="Approved Pricing" value={k.approvedPricing} color="#22c55e" />
        <KPI title="Rejected Pricing" value={k.rejectedPricing} color="#dc2626" />
      </div>

      {/* CHARTS GRID */}
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "1fr 1fr",
          gap: "2rem",
          marginBottom: "2rem",
        }}
      >
        {/* User Growth */}
        <ChartCard title="User Growth (Last 12 Months)">
          <Chart
            type="line"
            height={300}
            series={[
              {
                name: "Users",
                data: c.userGrowth.map((x) => x.count),
              },
            ]}
            options={{
              chart: { toolbar: { show: false } },
              colors: ["#3b82f6"],
              xaxis: { categories: c.userGrowth.map((x) => x.month) },
            }}
          />
        </ChartCard>

        {/* Dealer Region Distribution */}
   <ChartCard title="Dealer Distribution by Region">
  <Chart
    type="pie"
    height={300}
    series={(c.dealerDistribution || []).map((d) => Number(d.count))}
    options={{
      labels: (c.dealerDistribution || []).map(
        (d) => d.region || "Unknown"
      ),
      colors: ["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#6366f1"],
      legend: { position: "bottom" },
    }}
  />
</ChartCard>





        {/* Documents Per Month */}
        <ChartCard title="Documents Per Month">
          <Chart
            type="bar"
            height={300}
            series={[
              {
                name: "Documents",
                data: c.docsPerMonth.map((x) => x.count),
              },
            ]}
            options={{
              xaxis: { categories: c.docsPerMonth.map((x) => x.month) },
              colors: ["#f59e0b"],
            }}
          />
        </ChartCard>

        {/* Pricing Trend */}
        <ChartCard title="Pricing Update Trend">
          <Chart
            type="area"
            height={300}
            series={[
              {
                name: "Pricing Updates",
                data: c.pricingTrend.map((x) => x.count),
              },
            ]}
            options={{
              xaxis: { categories: c.pricingTrend.map((x) => x.month) },
              colors: ["#ef4444"],
            }}
          />
        </ChartCard>
      </div>

      {/* Recent Activity */}
      <div
        style={{
          background: "var(--card-bg)",
          padding: "1.5rem",
          borderRadius: "12px",
          border: "1px solid var(--card-border)",
        }}
      >
        <h2 style={{ marginBottom: "1rem", fontWeight: 600 }}>Recent Activity</h2>

        <table style={{ width: "100%", borderCollapse: "collapse" }}>
          <thead>
            <tr style={{ borderBottom: "1px solid var(--card-border)" }}>
              <th>User</th>
              <th>Action</th>
              <th>Entity</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {stats.recentActivity.map((a) => (
              <tr key={a.id} style={{ borderBottom: "1px solid var(--card-border)" }}>
                <td>{a.userId}</td>
                <td>{a.action}</td>
                <td>{a.entity}</td>
                <td>{new Date(a.createdAt).toLocaleString()}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function KPI({ title, value, color }) {
  return (
    <div
      style={{
        padding: "1.5rem",
        borderRadius: "14px",
        background: "var(--card-bg)",
        border: "1px solid var(--card-border)",
        boxShadow: "0px 4px 10px rgba(0,0,0,0.08)",
      }}
    >
      <h3 style={{ opacity: 0.7 }}>{title}</h3>
      <p style={{ fontSize: "2rem", fontWeight: 700, color }}>{value}</p>
    </div>
  );
}

function ChartCard({ title, children }) {
  return (
    <div
      style={{
        background: "var(--card-bg)",
        padding: "1.5rem",
        borderRadius: "14px",
        border: "1px solid var(--card-border)",
      }}
    >
      <h3 style={{ marginBottom: "1rem" }}>{title}</h3>
      {children}
    </div>
  );
}
</file>

<file path="src/pages/maps/RegionMaps.jsx">
// src/pages/maps/RegionMap.jsx
// Rewritten, robust Region & Territory map page
// Reference/uploaded repo snapshot (if needed): sandbox:/mnt/data/repomix-output.xml

import React, { useEffect, useState, useRef, useMemo } from 'react';
import { MapContainer, TileLayer, GeoJSON, Marker, Popup, useMap } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import 'leaflet.heat';
import axios from 'axios';

// small helper: safe array
const safeArray = (v) => (Array.isArray(v) ? v : []);

// small helper to ensure a FeatureCollection
const normalizeFeatureCollection = (payload) => {
  if (!payload) return { type: 'FeatureCollection', features: [] };
  if (Array.isArray(payload)) {
    // Received raw features array
    return { type: 'FeatureCollection', features: payload.filter(f => f && f.type === 'Feature' && f.geometry) };
  }
  if (payload.type === 'FeatureCollection' && Array.isArray(payload.features)) {
    return {
      type: 'FeatureCollection',
      features: payload.features.filter(f => f && f.type === 'Feature' && f.geometry && f.geometry.type)
    };
  }
  // unknown shape
  return { type: 'FeatureCollection', features: [] };
};

// Heat layer component (wrapper for useMap inside MapContainer)
function HeatLayer({ points, radius = 25, blur = 20 }) {
  const map = useMap();
  useEffect(() => {
    if (!map) return;
    if (map._heat) {
      try { map.removeLayer(map._heat); } catch (_) {}
      map._heat = null;
    }

    const heatPoints = (points || [])
      .filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng) && Number.isFinite(p.weight))
      .map(p => [p.lat, p.lng, Math.max(0.001, Number(p.weight) / 10000)]);

    if (!heatPoints.length) return;

    const heat = L.heatLayer(heatPoints, { radius, blur, maxZoom: 17 });
    map._heat = heat;
    heat.addTo(map);

    return () => {
      if (map._heat) {
        try { map.removeLayer(map._heat); } catch (_) {}
        map._heat = null;
      }
    };
  }, [map, points, radius, blur]);

  return null;
}

export default function RegionMap() {
  const [dealers, setDealers] = useState([]);
  const [heatPoints, setHeatPoints] = useState([]);
  const [regions, setRegions] = useState({ type: 'FeatureCollection', features: [] });
  const [territories, setTerritories] = useState({ type: 'FeatureCollection', features: [] });

  const [granularity, setGranularity] = useState('dealer');
  const [startDate, setStartDate] = useState(() => new Date().toISOString().slice(0, 10)); // today
  const [endDate, setEndDate] = useState(() => new Date().toISOString().slice(0, 10)); // today
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // map center fallback
  const mapCenter = [20.5937, 78.9629]; // India center
  const mapRef = useRef();

  // compute a bounds from dealers and region centroids to auto-fit map
  const computedBounds = useMemo(() => {
    const latlngs = [];

    dealers.forEach(d => {
      if (Number.isFinite(d.lat) && Number.isFinite(d.lng)) latlngs.push([d.lat, d.lng]);
    });

    regions.features.forEach(f => {
      const cLat = f.properties?.centroidLat;
      const cLng = f.properties?.centroidLng;
      if (Number.isFinite(cLat) && Number.isFinite(cLng)) latlngs.push([cLat, cLng]);
    });

    territories.features.forEach(f => {
      const cLat = f.properties?.centroidLat;
      const cLng = f.properties?.centroidLng;
      if (Number.isFinite(cLat) && Number.isFinite(cLng)) latlngs.push([cLat, cLng]);
    });

    if (!latlngs.length) return null;
    return L.latLngBounds(latlngs);
  }, [dealers, regions, territories]);

  // auto-fit map when data changes
  useEffect(() => {
    if (!mapRef.current || !computedBounds) return;
    const map = mapRef.current;
    try {
      map.fitBounds(computedBounds, { padding: [40, 40], maxZoom: 9 });
    } catch (e) {
      // ignore fit errors
    }
  }, [computedBounds]);

  // fetch all data (cancelable)
  useEffect(() => {
    let mounted = true;
    const ac = new AbortController();

    const fetchAll = async () => {
      setLoading(true);
      setError(null);

      try {
        const [dRes, rRes, tRes, hRes] = await Promise.all([
          axios.get(`http://localhost:3000/api/maps/dealers?start=${startDate}&end=${endDate}`, { signal: ac.signal }),
          axios.get(`http://localhost:3000/api/maps/regions`, { signal: ac.signal }),
          axios.get(`http://localhost:3000/api/maps/territories`, { signal: ac.signal }),
          axios.get(`http://localhost:3000/api/maps/heatmap?granularity=${granularity}&start=${startDate}&end=${endDate}`, { signal: ac.signal })
        ]);

        // DEALERS: ensure array
        const dealersArr = Array.isArray(dRes.data) ? dRes.data : (Array.isArray(dRes.data.dealers) ? dRes.data.dealers : []);
        const cleanedDealers = dealersArr
          .filter(d => d && Number.isFinite(Number(d.lat)) && Number.isFinite(Number(d.lng)))
          .map(d => ({
            id: d.id,
            name: d.name || d.businessName || d.dealerCode || 'Dealer',
            dealerCode: d.dealerCode || '',
            lat: Number(d.lat),
            lng: Number(d.lng),
            totalSales: Number(d.totalSales || 0),
            territoryId: d.territoryId || null,
            regionId: d.regionId || null
          }));

        // REGIONS & TERRITORIES: normalize to FeatureCollection
        const regionsFC = normalizeFeatureCollection(rRes.data);
        const territoriesFC = normalizeFeatureCollection(tRes.data);

        // HEAT: ensure array of {lat,lng,weight}
        const heatArr = Array.isArray(hRes.data) ? hRes.data : (Array.isArray(hRes.data.points) ? hRes.data.points : []);
        const cleanedHeat = heatArr
          .filter(p => p && Number.isFinite(Number(p.lat)) && Number.isFinite(Number(p.lng)))
          .map(p => ({ lat: Number(p.lat), lng: Number(p.lng), weight: Number(p.weight || 0) }));

        if (!mounted) return;

        setDealers(cleanedDealers);
        setRegions(regionsFC);
        setTerritories(territoriesFC);
        setHeatPoints(cleanedHeat);
      } catch (err) {
        if (axios.isCancel(err)) return;
        console.error('RegionMap fetch error', err);
        if (mounted) setError('Failed to load map data');
      } finally {
        if (mounted) setLoading(false);
      }
    };

    fetchAll();

    return () => {
      mounted = false;
      ac.abort();
    };
  }, [granularity, startDate, endDate]);

  const reloadHeat = async () => {
    try {
      const res = await axios.get(`http://localhost:3000/api/maps/heatmap?granularity=${granularity}&start=${startDate}&end=${endDate}`);
      const arr = Array.isArray(res.data) ? res.data : (Array.isArray(res.data.points) ? res.data.points : []);
      setHeatPoints(arr.filter(p => p && Number.isFinite(p.lat) && Number.isFinite(p.lng)).map(p => ({ lat: Number(p.lat), lng: Number(p.lng), weight: Number(p.weight || 0) })));
    } catch (err) {
      console.error('reloadHeat error', err);
    }
  };

  return (
    <div style={{ height: '100%', display: 'flex', flexDirection: 'column', gap: 8 }}>
      <div style={{ display: 'flex', gap: 8, alignItems: 'center', padding: 8 }}>
        <label style={{ fontWeight: 600 }}>Heat Granularity:</label>
        <select value={granularity} onChange={e => setGranularity(e.target.value)}>
          <option value="dealer">Dealer</option>
          <option value="territory">Territory</option>
          <option value="region">Region</option>
        </select>

        <label style={{ marginLeft: 12 }}>Start</label>
        <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />

        <label>End</label>
        <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />

        <button onClick={reloadHeat} style={{ marginLeft: 8 }}>Reload Heat</button>

        <div style={{ marginLeft: 'auto', fontSize: 13, color: '#666' }}>
          {loading ? 'Loading map...' : error ? error : `Dealers: ${dealers.length} ‚Ä¢ Regions: ${regions.features.length} ‚Ä¢ Territories: ${territories.features.length}`}
        </div>
      </div>

      <div style={{ height: '720px', borderRadius: 8, overflow: 'hidden' }}>
        <MapContainer
          whenCreated={map => { mapRef.current = map; }}
          center={mapCenter}
          zoom={5}
          style={{ height: '100%', width: '100%' }}
        >
          <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />

          {/* Regions (choropleth-ready) */}
          {regions && regions.features && regions.features.length > 0 && (
            <GeoJSON
              data={regions}
              style={(feature) => {
                // simple style; you can color by property later
                return { fillColor: '#f2f2f2', color: '#666', weight: 1, fillOpacity: 0.35 };
              }}
              onEachFeature={(feature, layer) => {
                const props = feature.properties || {};
                const name = props.name || props.title || 'Region';
                layer.bindPopup(`<strong>${name}</strong>`);
              }}
            />
          )}

          {/* Territories */}
          {territories && territories.features && territories.features.length > 0 && (
            <GeoJSON
              data={territories}
              style={() => ({ fillColor: 'transparent', color: '#1f78b4', weight: 1 })}
              onEachFeature={(feature, layer) => {
                const props = feature.properties || {};
                layer.bindPopup(`<strong>${props.name || 'Territory'}</strong>`);
              }}
            />
          )}

          {/* Dealer markers */}
          {dealers.map(d => (
            <Marker key={d.id} position={[d.lat, d.lng]}>
              <Popup>
                <div style={{ minWidth: 160 }}>
                  <strong>{d.name}</strong><br />
                  Code: {d.dealerCode || '‚Äî'}<br />
                  Sales: ‚Çπ{Number(d.totalSales || 0).toLocaleString()}
                </div>
              </Popup>
            </Marker>
          ))}

          {/* Heat */}
          <HeatLayer points={heatPoints} />
        </MapContainer>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Materials/MaterialAnalytics.jsx">
import React, { useEffect, useState } from 'react';
import api from '../../services/api';

export default function MaterialAnalytics() {
  const [range, setRange] = useState({ start: '', end: '' });
  const [limit, setLimit] = useState(10);
  const [fastMoving, setFastMoving] = useState([]);
  const [slowMoving, setSlowMoving] = useState([]);
  const [loading, setLoading] = useState(false);

  const loadAnalytics = async () => {
    setLoading(true);
    try {
      const params = {};
      if (range.start) params.start = range.start;
      if (range.end) params.end = range.end;
      if (limit) params.limit = limit;

      const res = await api.get('/materials/analytics', { params });

      // backend returns { fastMoving: [], slowMoving: [] }
      const data = res.data || {};
      setFastMoving(data.fastMoving || []);
      setSlowMoving(data.slowMoving || []);
    } catch (err) {
      console.error('Failed to load analytics', err);
      alert('Failed to load analytics');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadAnalytics();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const renderList = (items) =>
    items.map((m) => (
      <li key={m.materialId}>
        {m.material?.materialNumber || m.materialId} ‚Äî {m.material?.name || 'Unknown'} ‚Äî {m.totalQty}
      </li>
    ));

  return (
    <div style={{ padding: 20 }}>
      <h2>Materials Analytics</h2>

      <div style={{ display: 'flex', gap: 12, marginBottom: 12 }}>
        <div>
          <label>Start</label>
          <input
            type="date"
            value={range.start}
            onChange={(e) => setRange((r) => ({ ...r, start: e.target.value }))}
          />
        </div>
        <div>
          <label>End</label>
          <input
            type="date"
            value={range.end}
            onChange={(e) => setRange((r) => ({ ...r, end: e.target.value }))}
          />
        </div>
        <div>
          <label>Limit</label>
          <input type="number" value={limit} onChange={(e) => setLimit(Number(e.target.value))} />
        </div>
        <div>
          <button onClick={loadAnalytics} disabled={loading}>
            Refresh
          </button>
        </div>
      </div>

      <div style={{ display: 'flex', gap: 20 }}>
        <div style={{ flex: 1 }}>
          <h4>Fast Moving</h4>
          <ul>{renderList(fastMoving)}</ul>
        </div>

        <div style={{ flex: 1 }}>
          <h4>Slow Moving</h4>
          <ul>{renderList(slowMoving)}</ul>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/technicaladmin/TechnicalAdmin.jsx">
import React, { useEffect, useState, useContext } from "react";
import api from "../../services/api";
import { toast } from "react-toastify";

import PageHeader from "../../components/PageHeader";
import Card from "../../components/Card";
import Toolbar from "../../components/Toolbar";
import SearchInput from "../../components/SearchInput";
import IconPillButton from "../../components/IconPillButton";
import StatCard from "../../components/StatCard";

import { AuthContext } from "../../context/AuthContext";

import { ShieldCheck, ShieldAlert, Database, Save } from "lucide-react";

import "../dashboards/DashboardLayout.css"; // same layout styles

export default function TechnicalAdminDashboard() {
  const { user } = useContext(AuthContext);

  const [roles, setRoles] = useState([]);
  const [permissions, setPermissions] = useState([]);
  const [matrix, setMatrix] = useState({});
  const [dirty, setDirty] = useState(new Set());

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [search, setSearch] = useState("");

  useEffect(() => {
    load();
  }, []);

  const load = async () => {
    try {
      setLoading(true);
      const [r, p] = await Promise.all([
        api.get("/roles"),
        api.get("/permissions"),
      ]);

      setRoles(r.data);
      setPermissions(p.data);

      const m = {};
      r.data.forEach((role) => {
        m[role.id] = new Set(role.permissions?.map((p) => p.id) || []);
      });

      setMatrix(m);
      setDirty(new Set());
    } catch (e) {
      toast.error("Failed to load permissions");
    } finally {
      setLoading(false);
    }
  };

  const toggle = (roleId, permId) => {
    setMatrix((prev) => {
      const updated = { ...prev };
      const set = new Set(updated[roleId]);

      set.has(permId) ? set.delete(permId) : set.add(permId);
      updated[roleId] = set;

      setDirty((dr) => new Set(dr).add(roleId));
      return updated;
    });
  };

  const saveRole = async (roleId) => {
    try {
      setSaving(true);
      const permissionIds = [...matrix[roleId]];
      await api.put(`/roles/${roleId}/permissions`, { permissionIds });

      toast.success("Permissions updated");

      setDirty((dr) => {
        const s = new Set(dr);
        s.delete(roleId);
        return s;
      });
    } catch {
      toast.error("Failed to save permissions");
    } finally {
      setSaving(false);
    }
  };

  if (loading)
    return (
      <div className="center text-center" style={{ height: "70vh" }}>
        Loading Technical Admin‚Ä¶
      </div>
    );

  return (
  <div className="dashboard-page">
    <div className="dashboard-container">

      <PageHeader
        title="Technical Admin Dashboard"
        subtitle="System-wide role and permission management"
      />

      <Toolbar
        left={[
          <SearchInput
            key="search"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search permissions‚Ä¶"
          />,
        ]}
        right={[
          <IconPillButton
            key="reload"
            icon={<Database size={18} />}
            label="Reload Data"
            onClick={load}
          />,
        ]}
      />

      <div className="stat-grid">
        <StatCard title="Total Roles" value={roles.length} icon={<ShieldCheck />} />
        <StatCard title="Total Permissions" value={permissions.length} icon={<ShieldAlert />} />
        <StatCard title="Roles Modified" value={dirty.size} icon={<Save />} />
      </div>

      <div className="dashboard-grid">
        <div className="column">
          <Card title="Role Permission Matrix" className="matrix-card">
  <div className="matrix-container">
    <div className="matrix-inner-scroll">

      <table className="matrix-table">
        <thead>
          <tr>
            <th className="sticky-col">Permission</th>

            {roles.map((r) => (
              <th key={r.id} className="center-cell">
                <div className="role-header">
                  {r.name}
                  {dirty.has(r.id) && (
                    <span className="unsaved-tag">Unsaved</span>
                  )}
                </div>

                <button
                  onClick={() => saveRole(r.id)}
                  disabled={!dirty.has(r.id) || saving}
                  className={`save-btn ${dirty.has(r.id) ? "active" : ""}`}
                >
                  {saving ? "Saving‚Ä¶" : "Save"}
                </button>
              </th>
            ))}
          </tr>
        </thead>

        <tbody>
          {permissions
            .filter((p) =>
              search.trim() === ""
                ? true
                : p.key.toLowerCase().includes(search.toLowerCase()) ||
                  p.description.toLowerCase().includes(search.toLowerCase())
            )
            .map((p, idx) => (
              <tr
                key={p.id}
                className={idx % 2 === 0 ? "row-even" : "row-odd"}
              >
                <td className="sticky-col perm-col">
                  <strong>{p.key}</strong>
                  <div className="perm-desc">{p.description}</div>
                </td>

                {roles.map((r) => (
                  <td key={r.id} className="center-cell">
                    <label className="checkbox-wrapper">
                      <input
                        type="checkbox"
                        checked={matrix[r.id]?.has(p.id)}
                        onChange={() => toggle(r.id, p.id)}
                      />
                      <span className="custom-checkbox"></span>
                    </label>
                  </td>
                ))}
              </tr>
            ))}
        </tbody>
      </table>

    </div>
  </div>
</Card>

        </div>

        <div className="column">
          <Card title="System Notes">
            <p className="text-muted small">
              ‚úì Editing permissions takes effect immediately.<br />
              ‚úì Avoid removing core permissions from Super Admin.<br />
              ‚úì Technical Admin has full control.
            </p>
          </Card>

          <Card title="Recent Updates">
            <p className="text-muted small">No recent updates.</p>
          </Card>
        </div>
      </div>

    </div>
  </div>
);

}
</file>

<file path="src/services/socket.js">
// src/services/socket.js
import { io } from "socket.io-client";

const BASE_URL = import.meta.env.VITE_API_URL.replace("/api", "");

// üî• Initialize socket
const socket = io(BASE_URL, {
  transports: ["websocket"],
  auth: {
    token: localStorage.getItem("token"),
  },
  reconnection: true,
});

// üî• When socket connects, authenticate with backend  
socket.on("connect", () => {
  try {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) return;

    socket.emit("authenticate", {
      userId: user.id,
      role: user.role, // role string like "dealer_admin"
    });

    console.log("üîê Socket authenticated:", user.id, user.role);
  } catch (err) {
    console.error("Socket auth error:", err);
  }
});

// üëâ Join a specific chat (1-to-1)
export const joinChatRoom = (user1, user2) => {
  socket.emit("join_chat", { user1, user2 });
};

// üëâ Leave chat room
export const leaveChatRoom = (user1, user2) => {
  socket.emit("leave_chat", { user1, user2 });
};

// üëâ Send message
export const sendChatMessage = (msg) => {
  socket.emit("send_message", msg);
};

// üëâ Listen to messages (used inside ChatUI)
export const onReceiveMessage = (callback) => {
  socket.on("receive_message", callback);
};

// üëâ Listen to notifications
export const onNewMessageNotification = (callback) => {
  socket.on("new_message_notification", callback);
};

export default socket;
</file>

<file path="src/components/PieChartCard.jsx">
import React from "react";
import { Card, CardContent, Typography } from "@mui/material";
import {
  PieChart,
  Pie,
  Cell,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from "recharts";

export default function PieChartCard({ title, data = [] }) {
  const COLORS = ["#f97316", "#22c55e", "#a78bfa", "#ef4444", "#06b6d4"];

  // ‚úÖ Ensure data is always an array in the correct format
  const chartData = Array.isArray(data)
    ? data
    : Object.entries(data || {}).map(([name, value]) => ({
        name,
        value,
      }));

  // ‚úÖ Handle empty data gracefully
  if (!chartData.length) {
    return (
      <Card
        sx={{
          borderRadius: 3,
          boxShadow: 2,
          p: 2,
          backgroundColor: "rgba(255,255,255,0.04)",
          color: "#94a3b8",
          textAlign: "center",
        }}
      >
        <CardContent>
          <Typography variant="subtitle1">{title}</Typography>
          <Typography sx={{ mt: 2 }}>No data available</Typography>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card
      sx={{
        borderRadius: 3,
        boxShadow: 2,
        p: 2,
        backgroundColor: "rgba(255,255,255,0.04)",
        color: "#e2e8f0",
      }}
    >
      <CardContent>
        <Typography variant="subtitle1" sx={{ mb: 2 }}>
          {title}
        </Typography>

        <ResponsiveContainer width="100%" height={250}>
          <PieChart>
            <Pie
              data={chartData}
              dataKey="value"
              nameKey="name"
              cx="50%"
              cy="50%"
              outerRadius={80}
              label
            >
              {chartData.map((_, index) => (
                <Cell
                  key={`cell-${index}`}
                  fill={COLORS[index % COLORS.length]}
                />
              ))}
            </Pie>
            <Tooltip
              contentStyle={{
                backgroundColor: "rgba(12,12,14,0.9)",
                border: "1px solid rgba(255,255,255,0.08)",
                color: "#e2e8f0",
              }}
            />
            <Legend />
          </PieChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/ProtectedRoute.jsx">
import { Navigate } from "react-router-dom";
import { useAuth } from "../context/AuthContext";

export default function ProtectedRoute({ children, allowed }) {
  const { user, token, loading } = useAuth();

  if (loading) return <div>Loading...</div>;

  // User not logged in ‚Üí redirect to login
  if (!token || !user) return <Navigate to="/login" replace />;

  // Role-protected routes (e.g., allowed = ["super_admin", "technical_admin"])
  if (allowed && !allowed.includes(user.role)) {
    return <Navigate to="/unauthorized" replace />;
  }

  return children;
}
</file>

<file path="src/pages/Admin.jsx">
import React, { useEffect, useState } from "react";
import api from "../services/api";

export default function AdminDealers() {
  const [dealers, setDealers] = useState([]);
  const [loading, setLoading] = useState(true);

  const fetchDealers = async () => {
    try {
      const res = await api.get("/dealers");
      setDealers(res.data.dealers || res.data);
    } catch (err) {
      console.error("Error fetching dealers:", err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchDealers(); }, []);

  const handleBlockToggle = async (dealer) => {
    const reason = prompt(`Enter reason to ${dealer.isBlocked ? "unblock" : "block"} this dealer:`);
    if (!reason) return;
    try {
      await api.put(`/dealers/${dealer.id}/block`, { isBlocked: !dealer.isBlocked, reason });
      fetchDealers();
    } catch (err) {
      console.error("Error updating dealer status:", err);
      alert("Failed to update dealer block status");
    }
  };

  const handleVerify = async (dealer) => {
    const licenseNumber = prompt("Enter License Number:");
    if (!licenseNumber) return;
    const licenseDocument = prompt("Enter License Document URL (optional):") || null;
    try {
      await api.put(`/dealers/${dealer.id}/verify`, { licenseNumber, licenseDocument });
      fetchDealers();
    } catch (err) {
      console.error("Error verifying dealer:", err);
      alert("Failed to verify dealer");
    }
  };

  if (loading) return <p>Loading dealers...</p>;

  return (
    <div style={styles.container}>
      <h2 style={styles.title}>Dealer Management</h2>
      <table style={styles.table}>
        <thead>
          <tr>
            <th>Dealer Code</th>
            <th>Business Name</th>
            <th>Contact Person</th>
            <th>City</th>
            <th>Region</th>
            <th>Status</th>
            <th>Verified</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {dealers.map((d) => (
            <tr key={d.id}>
              <td>{d.dealerCode}</td>
              <td>{d.businessName}</td>
              <td>{d.contactPerson || "‚Äî"}</td>
              <td>{d.city || "‚Äî"}</td>
              <td>{d.region || "‚Äî"}</td>
              <td style={{ color: d.isBlocked ? "red" : "green" }}>
                {d.isBlocked ? "Blocked" : "Active"}
              </td>
              <td>{d.isVerified ? "‚úÖ" : "‚ùå"}</td>
              <td>
                <button
                  style={{
                    ...styles.button,
                    background: d.isBlocked ? "#2ecc71" : "#e74c3c",
                  }}
                  onClick={() => handleBlockToggle(d)}
                >
                  {d.isBlocked ? "Unblock" : "Block"}
                </button>
                {!d.isVerified && (
                  <button
                    style={{ ...styles.button, background: "#3498db" }}
                    onClick={() => handleVerify(d)}
                  >
                    Verify
                  </button>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

const styles = {
  container: {
    padding: "2rem",
    backgroundColor: "#f5f6fa",
    fontFamily: "'Poppins', sans-serif",
  },
  title: {
    marginBottom: "1rem",
    color: "#2c3e50",
  },
  table: {
    width: "100%",
    borderCollapse: "collapse",
    background: "#fff",
    borderRadius: "8px",
    overflow: "hidden",
    boxShadow: "0 4px 10px rgba(0,0,0,0.1)",
  },
  button: {
    border: "none",
    borderRadius: "5px",
    color: "#fff",
    padding: "6px 12px",
    cursor: "pointer",
    marginRight: "8px",
  },
};
</file>

<file path="src/pages/ChatUI.jsx">
import React, { useEffect, useState, useRef } from "react";
import { useNavigate } from "react-router-dom";
import { FaArrowLeft } from "react-icons/fa";
import api, { chatAPI } from "../services/api";
import "./Chat.css";
import socket, {
  joinChatRoom,
  leaveChatRoom,
  sendChatMessage,
  onReceiveMessage,
  onNewMessageNotification,
} from "../services/socket";

export default function ChatUI({ compact = false }) {
  const user = JSON.parse(localStorage.getItem("user")); // logged-in user
  const navigate = useNavigate();

  const [contacts, setContacts] = useState([]);
  const [selected, setSelected] = useState(null);
  const [messages, setMessages] = useState([]);
  const [text, setText] = useState("");

  const chatBoxRef = useRef(null);

  // Auto-scroll
  const scrollToBottom = () => {
    setTimeout(() => {
      if (chatBoxRef.current) {
        chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
      }
    }, 100);
  };

  // Fetch allowed contacts
  useEffect(() => {
    api
      .get("/chat/allowed-users")
      .then((res) => {
        const raw = res.data.users || [];

        // üî• FIXED: map roleDetails.name ‚Üí role
        const mapped = raw.map((u) => ({
          ...u,
          role: u.roleDetails?.name || "unknown",
        }));

        setContacts(mapped);
      })
      .catch((err) => console.error("Failed to fetch contacts:", err));

    // Chat opened ‚Üí reset unread
    socket.emit("chat:read");
  }, []);

  // Small helper to render avatar (initials) with deterministic color
  const avatarFor = (name, id) => {
    const initials = (name || "?")
      .split(" ")
      .map((s) => s[0])
      .slice(0, 2)
      .join("")
      .toUpperCase();

    // deterministic color from id
    const colors = ["#34D399", "#60A5FA", "#F472B6", "#F59E0B", "#A78BFA", "#FB7185"];
    const idx = Math.abs(String(id).split("").reduce((acc, ch) => acc + ch.charCodeAt(0), 0)) % colors.length;

    return (
      <div className="contact-avatar" style={{ background: colors[idx] }}>
        {initials}
      </div>
    );
  };

  // Open a chat
  const openConversation = async (partner) => {
    if (selected) leaveChatRoom(user.id, selected.id);

    setSelected(partner);
    joinChatRoom(user.id, partner.id);

    try {
      const res = await api.get(`/chat/conversation/${partner.id}`);
      setMessages(res.data.messages || []);
      scrollToBottom();

      // Reset unread for this conversation
      chatAPI.markRead(partner.id).catch(() => {});
      socket.emit("chat:read", { partnerId: partner.id });
    } catch (err) {
      console.error("Failed to load conversation", err);
    }
  };

  // Real-time incoming messages
  useEffect(() => {
    onReceiveMessage((msg) => {
      if (!selected) return;

      const room = makeRoomId(msg.senderId, msg.recipientId);
      const myRoom = makeRoomId(user.id, selected.id);

      if (room === myRoom) {
        setMessages((prev) => [...prev, msg]);
        scrollToBottom();

        socket.emit("chat:read", { partnerId: selected.id });
        chatAPI.markRead(selected.id).catch(() => {});
      }
    });

    onNewMessageNotification((notif) => {
      console.log("üîî New message notification:", notif);
    });
  }, [selected, user.id]);

  // Send a message
  const sendMessage = () => {
    if (!text.trim() || !selected) return;

    const payload = {
      senderId: user.id,
      recipientId: selected.id,
      body: text.trim(),
    };

    sendChatMessage(payload);

    // Optimistic UI
    setMessages((prev) => [
      ...prev,
      {
        id: "tmp-" + Date.now(),
        senderId: user.id,
        recipientId: selected.id,
        body: text.trim(),
        createdAt: new Date().toISOString(),
      },
    ]);

    setText("");
    scrollToBottom();
  };

  const containerStyle = compact
    ? { display: "flex", flexDirection: "column", background: "#f8f9fa", width: "100%" }
    : { display: "flex", height: "100vh", background: "#f8f9fa" };

  return (
    <div style={containerStyle}>
        <div> {!compact && (
            <button
              onClick={() => navigate("/dashboard")}
              title="Back to dashboard"
              style={{
                border: "none",
                background: "transparent",
                cursor: "pointer",
                fontSize: 18,
                padding: 6,
                display: "inline-flex",
                alignItems: "center",
                justifyContent: "center",
              }}
            >
              <FaArrowLeft />
            </button>
          )}
</div>      {/* CONTACTS */}
      <div
        style={
          compact
            ? {
                width: "100%",
                borderBottom: "1px solid #e0e0e0",
                padding: "10px",
                maxHeight: "260px",
                overflowY: "auto",
              }
            : {
                width: "300px",
                borderRight: "1px solid #e0e0e0",
                padding: "15px",
                overflowY: "auto",
              }
        }
      >
        <h3 style={{ marginBottom: "15px" }}>Contacts</h3>

        {contacts.length === 0 && (
          <div style={{ color: "#777" }}>No contacts available</div>
        )}

        {contacts.map((c) => (
          <div
            key={c.id}
            className={`dealer-item ${selected?.id === c.id ? "active" : ""}`}
            onClick={() => openConversation(c)}
            style={{ display: "flex", alignItems: "center", gap: 12 }}
          >
            {avatarFor(c.username, c.id)}
            <div style={{ flex: 1 }}>
              <div style={{ fontWeight: 600, fontSize: 15 }}>{c.username}</div>
              <div style={{ fontSize: 12, color: "#666" }}>{c.roleDetails?.name || c.role || "unknown"}</div>
            </div>
          </div>
        ))}
      </div>

      {/* CHAT AREA */}
      <div style={compact ? { display: "block" } : { flex: 1, display: "flex", flexDirection: "column" }}>
        <div
          style={{
            padding: "15px",
            borderBottom: "1px solid #e0e0e0",
            fontWeight: "600",
            fontSize: "16px",
            display: "flex",
            alignItems: "center",
            gap: "12px",
          }}
        >
          
          <div>{selected ? selected.username : "Select a contact to start chatting"}</div>
        </div>

        {/* MESSAGES */}
        <div
          ref={chatBoxRef}
          style={
            compact
              ? {
                  height: "260px",
                  overflowY: "auto",
                  padding: "10px",
                  display: "flex",
                  flexDirection: "column",
                  gap: "8px",
                  background: "#f4f5f7",
                }
              : {
                  flex: 1,
                  overflowY: "auto",
                  padding: "20px",
                  display: "flex",
                  flexDirection: "column",
                  gap: "12px",
                  background: "#f4f5f7",
                }
          }
        >
          {messages.map((m, idx) => {
            const isMe = m.senderId === user.id;
            const senderName = m.sender?.username || (m.senderId === user.id ? user.username : selected?.username);

            return (
              <div key={m.id || idx} className={`message-row ${isMe ? "outgoing-row" : "incoming-row"}`}>
                {!isMe && <div className="message-avatar-col">{avatarFor(senderName, m.senderId)}</div>}

                <div className={`message-content ${isMe ? "outgoing" : "incoming"}`}>
                  <div className="msg-text">{m.body}</div>
                  <div className="msg-meta">{new Date(m.createdAt).toLocaleString()}</div>
                </div>

                {isMe && <div className="message-avatar-col">{avatarFor(user.username, user.id)}</div>}
              </div>
            );
          })}
        </div>

        {/* INPUT */}
        <div
          style={{
            padding: compact ? "8px" : "15px",
            borderTop: "1px solid #e0e0e0",
            display: "flex",
            gap: "10px",
          }}
        >
          <input
            value={text}
            onChange={(e) => setText(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && sendMessage()}
            placeholder={
              selected ? "Type a message..." : "Select a contact to message"
            }
            style={{
              flex: 1,
              padding: "12px",
              borderRadius: "20px",
              border: "1px solid #ccc",
              outline: "none",
            }}
            disabled={!selected}
          />

          <button
            onClick={sendMessage}
            disabled={!selected}
            style={{
              padding: "10px 18px",
              background: "#4f8cff",
              border: "none",
              borderRadius: "20px",
              color: "#fff",
              cursor: "pointer",
            }}
          >
            Send
          </button>
        </div>
      </div>
    </div>
  );
}

// Utility
function makeRoomId(a, b) {
  return `chat:${[a, b].sort().join("-")}`;
}
</file>

<file path="src/pages/dashboards/DashboardLayout.css">
/* ========== THEME-AWARE COMPACT DASHBOARD LAYOUT ========== */
.dashboard-container {
  padding: 1rem 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  transition: background 0.3s ease, color 0.3s ease;
}

.dashboard-header {
  margin-bottom: 0.5rem;
}

.dashboard-header h1 {
  font-size: 1.1rem;
  margin-bottom: 0.3rem;
  font-weight: 600;
}

.dashboard-header p {
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* GRID STRUCTURE */
.dashboard-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1rem;
  width: 100%;
}

.dashboard-grid .column {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* CARD & COMPONENT STYLING */
.card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: 14px;
  padding: 0.9rem 1rem;
  box-shadow: var(--card-shadow);
  transition: 0.25s ease;
}

.card:hover {
  border-color: var(--accent);
  transform: translateY(-1px);
}

.card h2,
.card h3 {
  font-size: 0.9rem;
  margin-bottom: 0.4rem;
  font-weight: 600;
}

.text-muted {
  color: var(--text-muted);
  font-size: 0.8rem;
}

/* STAT CARDS */
.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 0.8rem;
}

.stat-card {
  text-align: center;
  border: 1px solid var(--card-border);
  background: var(--card-bg);
  border-radius: 10px;
  padding: 0.7rem;
}

.stat-card h3 {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.stat-card p {
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--accent);
}

/* TABLES */
.custom-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
}

.custom-table th,
.custom-table td {
  padding: 0.35rem 0.5rem;
  border-bottom: 1px solid var(--card-border);
}

.custom-table th {
  text-transform: uppercase;
  color: var(--text-muted);
  font-size: 0.7rem;
}

/* BUTTON ROWS */
.quick-actions {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.7rem;
}

/* CHART */
.recharts-wrapper {
  font-size: 0.75rem;
}

/* COMPACT CARD HEIGHTS */
.chart-card {
  height: 230px;
}

/* THEME-INHERITED COLORS */
[data-theme="dark"] {
  --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

[data-theme="light"] {
  --card-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);
}
.chart-card {
  height: 340px;   /* or 360px */
  min-height: 320px;
  position: relative;
}
/* MATRIX CONTAINER */
.matrix-wrapper {
  margin-top: 1rem;
  background: var(--card-bg);
  border-radius: 14px;
  border: 1px solid var(--card-border);
  padding: 1rem;
}

/* SCROLLABLE AREA */
.matrix-scroll {
  width: 100%;
  max-width: 100%;
  overflow-x: auto;       /* scroll inside card */
  padding-bottom: 1rem;
}


/* TABLE MUST NOT EXPAND PAGE */
.matrix-table {
  width: max-content;    /* ‚Üê allows scrolling instead of expanding page */
  min-width: 500px;      /* reduced for compactness */
  border-collapse: separate;
  border-spacing: 0;
}


/* STICKY LEFT PERMISSION COLUMN */
.sticky-col {
  position: sticky;
  left: 0;
  z-index: 3;
  background: var(--card-bg);
  box-shadow: 2px 0 4px rgba(0,0,0,0.05);
}

/* HEADER CELLS */
.matrix-table thead th {
  background: var(--hover-bg);
  padding: 0.8rem 1rem;
  font-weight: 600;
  border-bottom: 1px solid var(--card-border);
  white-space: nowrap;
}

/* PERMISSION COLUMN WIDTH */
.perm-col {
  width: 180px;
  max-width: 180px;
  white-space: normal;
  overflow-wrap: break-word;
}


/* CHECKBOX COLUMNS: FIX WIDTH */
.center-cell {
  width: 70px;
  max-width: 70px;
  min-width: 70px;
  text-align: center;
  white-space: nowrap;
}


/* SAVE BUTTON */
.save-btn {
  margin-top: 6px;
  padding: 5px 10px;
  font-size: 12px;
  border-radius: 6px;
  border: 1px solid var(--card-border);
  background: #fff;
  opacity: 0.5;
  cursor: not-allowed;
  transition: 0.2s ease;
}

.save-btn.active {
  opacity: 1;
  cursor: pointer;
  background: #fef3c7;
  border-color: #f59e0b;
}

.role-header {
  font-weight: 600;
  font-size: 14px;
}

.unsaved-tag {
  display: inline-block;
  margin-top: 4px;
  font-size: 10px;
  color: #b45309;
}

/* ROW COLORS */
.row-even {
  background: #fafafa;
}
.row-odd {
  background: #ffffff;
}

/* TABLE BODY */
.matrix-table td {
  padding: 0.8rem 1rem;
  border-bottom: 1px solid var(--card-border);
}

.matrix-table tbody tr:hover {
  background: var(--hover-bg);
}

/* PERMISSION DESCRIPTION */
.perm-desc {
  color: gray;
  font-size: 12px;
  margin-top: 2px;
}

/* CUSTOM CHECKBOX */
.checkbox-wrapper {
  width: 20px;
  height: 20px;
  position: relative;
  display: inline-block;
}

.checkbox-wrapper input {
  position: absolute;
  opacity: 0;
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.custom-checkbox {
  width: 18px;
  height: 18px;
  border: 2px solid #d1d5db;
  border-radius: 4px;
  display: inline-block;
  transition: 0.15s;
}

.checkbox-wrapper input:checked + .custom-checkbox {
  background: #f97316;
  border-color: #f97316;
}

/* CARD SHOULD NEVER EXPAND LAYOUT */
.card {
  max-width: 100%;
  overflow: hidden;
}
/* Matrix card itself is narrower */
/* Compact Matrix Card */
.matrix-card {
  max-width: 650px;      /* ‚Üê Your requested width */
  width: 100%;
  margin: 0 auto;        /* center it */
  overflow: hidden;
  padding: 0;            /* tighter look */
}
/* Outer container ‚Äî controls final width (never expands layout) */
.matrix-container {
  width: 100%;
  max-width: 650px;        /* fixed dashboard-safe width */
  margin: 0 auto;          /* center it */
  overflow: hidden;        /* prevents layout push */
  border-radius: 12px;
  border: 1px solid var(--card-border);
  background: var(--card-bg);
  padding: 0;
}

/* Inner scroll ‚Äî table scrolls INSIDE here */
.matrix-inner-scroll {
  width: 100%;
  overflow-x: auto;        /* horizontal scroll ONLY inside */
  overflow-y: hidden;
  padding: 1rem;
  box-sizing: border-box;
}

/* Table ‚Äî can be any width, but cannot escape container */
.matrix-table {
  width: max-content;
  border-collapse: collapse;
  border-spacing: 0;
}


/* Scroll area must NOT grow the card */
.matrix-scroll {
  max-width: 100%;
  overflow-x: auto;
  padding-bottom: 1rem;
}

/* Table can be wider, but it stays inside the card */
.matrix-table {
  width: max-content;
  min-width: 700px;           /* safe minimum table width */
}
</file>

<file path="src/pages/dashboards/ManagerDashboard.css">
/* ManagerDashboard.css - theme aware, uses CSS variables from index.css */

.manager-dashboard {
  min-height: 100%;
  padding: 1.25rem;
  font-family: "Inter", sans-serif;
  color: var(--text-color);
}

/* top-level grid: left main and right sidebar */
.dashboard-grid {
  display: grid;
  grid-template-columns: 70% 30%;
  gap: 1.25rem;
  margin-top: 1rem;
}

/* left column */
.left-col {
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

/* KPI row (compact cards) */
.kpi-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.75rem;
}

/* main chart card */
.main-chart-card {
  padding: 1rem;
}

/* right column (sidebar) */
.right-col {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* side compact KPIs */
.side-kpis {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.6rem;
}

.mini-kpi {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  padding: 0.7rem;
  border-radius: 12px;
  text-align: left;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

.mini-kpi-title {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 0.25rem;
}

.mini-kpi-value {
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--text-color);
}

/* side cards */
.side-card {
  padding: 0.6rem;
}

/* campaign preview */
.campaign-preview {
  padding: 0.6rem 0;
  border-bottom: 1px solid var(--card-border);
  cursor: pointer;
}

/* message list */
.message-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.message-list li {
  padding: 0.5rem 0;
  border-bottom: 1px dashed var(--card-border);
}

/* small responsive tweaks */
@media (max-width: 1100px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  .kpi-row {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 600px) {
  .kpi-row {
    grid-template-columns: 1fr;
  }
}
</file>

<file path="src/pages/Invoices.jsx">
import React, { useEffect, useState } from "react";
import api from "../services/api";
import { Download, Search, FileText } from "lucide-react";

export default function Invoices() {
  const [invoices, setInvoices] = useState([]);
  const [search, setSearch] = useState("");

  useEffect(() => {
    (async () => {
      const res = await api.get("/invoices");
      setInvoices(res.data.invoices || res.data);
    })();
  }, []);

  const downloadPdf = async (id, invoiceNumber) => {
    try {
      const res = await api.get(`/invoices/${id}/pdf`, { responseType: "blob" });
      const url = window.URL.createObjectURL(new Blob([res.data]));
      const a = document.createElement("a");
      a.href = url;
      a.download = `invoice-${invoiceNumber}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    } catch (err) {
      console.error(err);
      alert("Failed to download PDF");
    }
  };

  const filtered = invoices.filter((i) => {
    const q = search.toLowerCase();
    return (
      i.invoiceNumber?.toString()?.includes(q) ||
      i.status?.toLowerCase()?.includes(q) ||
      i.totalAmount?.toString()?.includes(q)
    );
  });

  return (
    <div style={{ padding: "2rem" }}>
      {/* HEADER */}
      <div style={{ marginBottom: "1.5rem" }}>
        <h2 style={{ fontSize: "1.7rem", marginBottom: "0.5rem" }}>Invoices</h2>
        <p style={{ opacity: 0.7 }}>
          View, filter, and download your invoices.
        </p>
      </div>

      {/* SEARCH BAR */}
      <div
        style={{
          marginBottom: "1.5rem",
          display: "flex",
          alignItems: "center",
          gap: "0.5rem",
          background: "var(--card-bg)",
          border: "1px solid var(--card-border)",
          padding: "0.7rem 1rem",
          borderRadius: "12px",
        }}
      >
        <Search size={18} />
        <input
          type="text"
          placeholder="Search invoices..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          style={{
            flex: 1,
            background: "transparent",
            border: "none",
            outline: "none",
            color: "var(--text-color)",
            fontSize: "1rem",
          }}
        />
      </div>

      {/* INVOICE TABLE */}
      <div
        style={{
          borderRadius: "14px",
          border: "1px solid var(--card-border)",
          background: "var(--card-bg)",
          overflow: "hidden",
          boxShadow: "0 4px 16px rgba(0,0,0,0.1)",
        }}
      >
        <table
          style={{
            width: "100%",
            borderCollapse: "collapse",
          }}
        >
          <thead
            style={{
              background: "rgba(255,255,255,0.05)",
              textAlign: "left",
            }}
          >
            <tr>
              {["Invoice #", "Date", "Amount", "Status", "Action"].map((head) => (
                <th
                  key={head}
                  style={{
                    padding: "1rem",
                    fontSize: "0.9rem",
                    fontWeight: 600,
                    borderBottom: "1px solid var(--card-border)",
                  }}
                >
                  {head}
                </th>
              ))}
            </tr>
          </thead>

          <tbody>
            {filtered.length === 0 && (
              <tr>
                <td
                  colSpan={5}
                  style={{
                    textAlign: "center",
                    padding: "2rem",
                    opacity: 0.6,
                  }}
                >
                  <FileText size={18} style={{ marginRight: 6 }} />
                  No invoices found
                </td>
              </tr>
            )}

            {filtered.map((i) => (
              <tr
                key={i.id}
                style={{
                  borderBottom: "1px solid var(--card-border)",
                  transition: "background 0.2s",
                }}
                onMouseEnter={(e) => (e.currentTarget.style.background = "rgba(255,255,255,0.04)")}
                onMouseLeave={(e) => (e.currentTarget.style.background = "transparent")}
              >
                <td style={{ padding: "1rem" }}>{i.invoiceNumber}</td>

                <td style={{ padding: "1rem" }}>
                  {new Date(i.invoiceDate).toLocaleDateString()}
                </td>

                <td style={{ padding: "1rem", fontWeight: 600 }}>
                  ‚Çπ{i.totalAmount}
                </td>

                <td style={{ padding: "1rem" }}>
                  <span
                    style={{
                      padding: "4px 10px",
                      borderRadius: "20px",
                      fontSize: "0.8rem",
                      fontWeight: 600,
                      color:
                        i.status === "Paid"
                          ? "#16a34a"
                          : i.status === "Pending"
                          ? "#f59e0b"
                          : "#ef4444",
                      background:
                        i.status === "Paid"
                          ? "rgba(22,163,74,0.15)"
                          : i.status === "Pending"
                          ? "rgba(245,158,11,0.15)"
                          : "rgba(239,68,68,0.15)",
                    }}
                  >
                    {i.status}
                  </span>
                </td>

                <td style={{ padding: "1rem" }}>
                  <button
                    onClick={() => downloadPdf(i.id, i.invoiceNumber)}
                    style={{
                      display: "flex",
                      alignItems: "center",
                      gap: "6px",
                      background:
                        "linear-gradient(90deg, var(--accent), var(--accent-dark))",
                      padding: "0.45rem 0.9rem",
                      color: "#fff",
                      borderRadius: "8px",
                      border: "none",
                      cursor: "pointer",
                      fontSize: "0.85rem",
                      fontWeight: 600,
                      boxShadow: "0 2px 6px rgba(0,0,0,0.2)",
                    }}
                  >
                    <Download size={16} />
                    PDF
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Materials/MaterialImport.jsx">
import React, { useState } from 'react';
import api from '../../services/api';
import ImportPreviewTable from '../../components/ImportPreviewTable';

export default function MaterialImport() {
  const [file, setFile] = useState(null);
  const [previewRows, setPreviewRows] = useState([]);
  const [previewErrors, setPreviewErrors] = useState({});
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);

const downloadTemplate = async () => {
  try {
    const res = await api.get('/materials/template', {
      responseType: 'blob' // important for files
    });
    const url = window.URL.createObjectURL(new Blob([res.data]));
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', 'material_template.xlsx');
    document.body.appendChild(link);
    link.click();
    link.remove();
  } catch (err) {
    console.error(err);
    alert('Failed to download template');
  }
};


  const onFileChange = (e) => {
    setFile(e.target.files[0] || null);
    setPreviewRows([]);
    setPreviewErrors({});
    setResult(null);
  };

  const previewOnServer = async () => {
    if (!file) return alert('Select a file first');
    setLoading(true);
    try {
      const form = new FormData();
      form.append('file', file);
      const res = await api.post('/materials/upload-preview', form, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      setPreviewRows(res.data.preview || []);
      setPreviewErrors(res.data.errors || {});
    } catch (err) {
      console.error(err);
      alert('Failed to validate file on server');
    } finally {
      setLoading(false);
    }
  };

  const importToServer = async () => {
    if (!file) return alert('Select a file first');
    if (!confirm('Proceed with importing the selected file?')) return;

    setLoading(true);
    try {
      const form = new FormData();
      form.append('file', file);
      const res = await api.post('/materials/import', form, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      setResult(res.data);
      setPreviewRows(res.data.preview || []);
      setPreviewErrors(res.data.errors || {});
      alert('Import completed');
    } catch (err) {
      console.error(err);
      alert('Import failed');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ padding: 20 }}>
      <h2>Import Materials</h2>

      <div style={{ marginBottom: 12 }}>
        <button onClick={downloadTemplate} style={{ marginRight: 8 }}>Download template</button>
        <input type="file" accept=".xlsx,.xls,.csv" onChange={onFileChange} />
      </div>

      <div style={{ marginBottom: 12 }}>
        <button onClick={previewOnServer} disabled={!file || loading} style={{ marginRight: 8 }}>Preview</button>
        <button onClick={importToServer} disabled={!file || loading}>Import</button>
      </div>

      <div style={{ marginTop: 16 }}>
        <h4>Preview</h4>
        <ImportPreviewTable rows={previewRows} errors={previewErrors} />
      </div>

      {result && (
        <div style={{ marginTop: 16 }}>
          <h4>Result</h4>
          <pre style={{ whiteSpace: 'pre-wrap', background: '#f3f4f6', padding: 12 }}>{JSON.stringify(result, null, 2)}</pre>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/pages/orders/AdminOrders.jsx">
import React, { useEffect, useState } from "react";
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  Chip,
  Table,
  TableBody,
  TableRow,
  TableCell,
  TableHead,
} from "@mui/material";
import { orderAPI } from "../../services/api";

export default function AdminOrders() {
  const [orders, setOrders] = useState([]);

  const fetchOrders = async () => {
    try {
      const res = await orderAPI.getAllOrders();
      setOrders(res?.orders || []);
    } catch (err) {
      console.error(err);
    }
  };

  useEffect(() => {
    fetchOrders();
  }, []);

  const approve = async (id) => {
    try {
      await orderAPI.approveOrder(id);
      fetchOrders();
    } catch (err) {
      console.error(err);
      alert("Failed to approve");
    }
  };

  const reject = async (id) => {
    const reason = prompt("Reason for rejection:");
    if (!reason) return;

    try {
      await orderAPI.rejectOrder(id, reason);
      fetchOrders();
    } catch (err) {
      console.error(err);
      alert("Failed to reject");
    }
  };

  const statusColor = {
    Pending: "warning",
    Approved: "success",
    Rejected: "error",
  };

  return (
    <Box p={4}>
      <Typography variant="h5" mb={3}>
        Dealer Orders (Approval Panel)
      </Typography>

      <Card>
        <CardContent>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Order No</TableCell>
                <TableCell>Material</TableCell>
                <TableCell>Quantity</TableCell>
                <TableCell>Status</TableCell>
                <TableCell>Actions</TableCell>
              </TableRow>
            </TableHead>

            <TableBody>
              {orders.map((order) =>
                (order.items || []).map((item) => (
                  <TableRow key={item.id}>
                    <TableCell>{order.orderNumber}</TableCell>
                    <TableCell>{item.material?.name || "Unknown Material"}</TableCell>
                    <TableCell>{item.qty}</TableCell>

                    <TableCell>
                      <Chip
                        label={order.status}
                        color={statusColor[order.status] || "default"}
                      />
                    </TableCell>

                    <TableCell>
                      {order.status === "Pending" && (
                        <>
                          <Button
                            variant="contained"
                            color="success"
                            size="small"
                            onClick={() => approve(order.id)}
                            sx={{ mr: 1 }}
                          >
                            Approve
                          </Button>

                          <Button
                            variant="contained"
                            color="error"
                            size="small"
                            onClick={() => reject(order.id)}
                          >
                            Reject
                          </Button>
                        </>
                      )}
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </Box>
  );
}
</file>

<file path="src/pages/orders/CreateOrders.jsx">
import React, { useEffect, useState } from "react";
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  MenuItem,
  TextField,
} from "@mui/material";
import { materialAPI, orderAPI } from "../../services/api";

export default function CreateOrder() {
  const [materials, setMaterials] = useState([]);
  const [selectedMaterial, setSelectedMaterial] = useState("");
  const [quantity, setQuantity] = useState("");
  const [unitPrice, setUnitPrice] = useState("");
  
  const user = JSON.parse(localStorage.getItem("user") || "{}");

  useEffect(() => {
    materialAPI
      .getMaterials()
      .then((res) => {
        const list = res?.materials || [];
        setMaterials(list);
      })
      .catch(console.error);
  }, []);

  const handleSubmit = async () => {
    if (!selectedMaterial || !quantity)
      return alert("All fields required");

    if (!user?.dealerId) {
      return alert("Dealer ID missing. Login again.");
    }

    const material = materials.find((m) => m.id === selectedMaterial);
    const price = Number(material?.price || unitPrice || 1);

    try {
      const payload = {
        dealerId: user.dealerId,    // üî• REQUIRED BY BACKEND
        items: [
          {
            materialId: selectedMaterial,
            qty: Number(quantity),
            unitPrice: price        // üî• NEVER SEND 0
          }
        ],
        notes: ""
      };

      await orderAPI.createOrder(payload);

      alert("Order created successfully!");

      setSelectedMaterial("");
      setQuantity("");
      setUnitPrice("");

    } catch (err) {
      console.error("Order create error:", err);
      alert("Failed to create order");
    }
  };

  return (
    <Box p={4}>
      <Card>
        <CardContent>
          <Typography variant="h5" mb={2}>
            Create New Order
          </Typography>

          {/* MATERIAL SELECT */}
          <TextField
            fullWidth
            select
            label="Select Material"
            value={selectedMaterial}
            onChange={(e) => {
              setSelectedMaterial(e.target.value);

              const selected = materials.find(
                (m) => m.id === e.target.value
              );

              // auto-fill unit price
              if (selected?.price) {
                setUnitPrice(selected.price);
              }
            }}
            margin="normal"
          >
            {materials.map((m) => (
              <MenuItem key={m.id} value={m.id}>
                {m.name} ‚Äî ‚Çπ{m.price}
              </MenuItem>
            ))}
          </TextField>

          {/* QUANTITY */}
          <TextField
            fullWidth
            label="Quantity"
            value={quantity}
            onChange={(e) => setQuantity(e.target.value)}
            margin="normal"
            type="number"
          />

          {/* UNIT PRICE (auto-filled but editable) */}
          <TextField
            fullWidth
            label="Unit Price"
            value={unitPrice}
            onChange={(e) => setUnitPrice(e.target.value)}
            margin="normal"
            type="number"
          />

          <Button
            variant="contained"
            color="primary"
            fullWidth
            sx={{ mt: 2 }}
            onClick={handleSubmit}
          >
            Submit Order
          </Button>
        </CardContent>
      </Card>
    </Box>
  );
}
</file>

<file path="src/index.css">
/* ‚úÖ Global Theme Variables */
:root {
  /* Dark Mode (default) */
  --bg-base: linear-gradient(135deg, #0b0d10, #141216);
  --bg-glow: radial-gradient(circle at 20% 0%, rgba(249, 115, 22, 0.06), transparent 35%);

  --text-color: #e2e8f0;
  --text-muted: #94a3b8;

  --accent: #f97316;

  --sidebar-bg: rgba(30, 41, 59, 0.85);
  --sidebar-text: #cbd5e1;

  --navbar-bg: rgba(12, 12, 14, 0.75);

  --card-bg: rgba(255, 255, 255, 0.06);
  --card-border: rgba(255, 255, 255, 0.1);
}

/* ‚úÖ Light Mode Overrides */
[data-theme="light"] {
  --bg-base: linear-gradient(135deg, #f5f7fa, #e4e7eb);
  --bg-glow: radial-gradient(circle at 80% 0%, rgba(249, 115, 22, 0.12), transparent 40%);

  --text-color: #1f2937;
  --text-muted: #4b5563;

  --accent: #f97316;

  --sidebar-bg: rgba(255, 255, 255, 0.85);
  --sidebar-text: #1f2937;

  --navbar-bg: rgba(255, 255, 255, 0.65);

  --card-bg: rgba(255, 255, 255, 0.7);
  --card-border: rgba(0, 0, 0, 0.15);
}

/* ‚úÖ Body */
body {
  margin: 0;
  font-family: "Inter", "Segoe UI", sans-serif;
  background: var(--bg-glow), var(--bg-base);
  color: var(--text-color);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚úÖ Navbar */
nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.9rem 1.5rem;
  background: var(--navbar-bg);
  backdrop-filter: blur(14px);
  border-bottom: 1px solid var(--card-border);
  color: var(--text-color);
  box-shadow: 0 4px 24px rgba(0,0,0,0.25);
}

/* ‚úÖ Sidebar */
aside {
  width: 240px;
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
  backdrop-filter: blur(10px);
  padding: 2rem 1rem;
  border-right: 1px solid var(--card-border);
  height: 100vh;
  box-shadow: inset -2px 0 10px rgba(0,0,0,0.1);
}

aside a {
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  margin-bottom: 0.5rem;
  border-radius: 10px;
  color: inherit;
  text-decoration: none;
  transition: 0.3s;
  font-weight: 500;
}

aside a:hover {
  background: rgba(249, 115, 22, 0.15);
  color: var(--accent);
  transform: translateX(3px);
}

aside a.active {
  background: linear-gradient(90deg, #f97316, #ea580c);
  color: white !important;
  box-shadow: 0 0 15px rgba(249, 115, 22, 0.4);
}

/* ‚úÖ Cards */
.card {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 1.5rem;
  border: 1px solid var(--card-border);
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  transition: 0.3s;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 0 15px rgba(249, 115, 22, 0.4);
}

/* ‚úÖ Tables */
th,
td {
  padding: 12px;
  border-bottom: 1px solid var(--card-border);
  color: var(--text-color);
}

th {
  background: rgba(249, 115, 22, 0.1);
  color: var(--accent);
}

/* ‚úÖ Headings */
h2, h3, h4 {
  color: var(--accent);
  font-weight: 600;
}

/* ‚úÖ Utility */
.text-muted { color: var(--text-muted); }
</file>

<file path="src/main.jsx">
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import "./index.css";
import App from "./App.jsx";
import { ThemeProvider, CssBaseline } from "@mui/material";
import getTheme from "./theme.js";
import { ThemeModeProvider, useThemeMode } from "./context/ThemeContext.jsx";
import { NotificationProvider } from "./context/NotificationContext.jsx"; // ‚úÖ add this
import { AuthProvider } from "./context/AuthContext.jsx"; // ‚úÖ add this if not wrapped yet
import { ToastContainer } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";

function ThemedApp() {
  const { mode } = useThemeMode();
  return (
    <ThemeProvider theme={getTheme(mode)}>
      <CssBaseline />
      <App />
      <ToastContainer position="bottom-right" />
    </ThemeProvider>
  );
}

createRoot(document.getElementById("root")).render(
  <StrictMode>
    <AuthProvider>
      <ThemeModeProvider>
        <NotificationProvider>
          <ThemedApp />
        </NotificationProvider>
      </ThemeModeProvider>
    </AuthProvider>
  </StrictMode>
);
</file>

<file path="src/pages/Documents.jsx">
import React, { useEffect, useState } from "react";
import api from "../services/api";

import {
  Upload,
  Download,
  Trash2,
  FileText,
  Image as ImageIcon,
  File,
  Search,
} from "lucide-react";

export default function Documents() {
  const [files, setFiles] = useState([]);
  const [selectedFiles, setSelectedFiles] = useState([]);
  const [preview, setPreview] = useState(null);
  const [dragOver, setDragOver] = useState(false);
  const [progress, setProgress] = useState({});
  const [search, setSearch] = useState("");
  const [filter, setFilter] = useState("all");

  const fetchDocs = async () => {
    const res = await api.get("/documents");
    setFiles(res.data.documents || res.data);
  };

  useEffect(() => {
    fetchDocs();
  }, []);

  const handleFileSelection = (e) => {
    const list = Array.from(e.target.files);
    setSelectedFiles(list);
    setPreview(list.length === 1 ? URL.createObjectURL(list[0]) : null);
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setDragOver(false);

    const dropped = Array.from(e.dataTransfer.files);
    setSelectedFiles(dropped);
    setPreview(dropped.length === 1 ? URL.createObjectURL(dropped[0]) : null);
  };

  const upload = async () => {
    if (!selectedFiles.length) return;

    const newProgress = {};

    const uploads = selectedFiles.map(async (file) => {
      const form = new FormData();
      form.append("file", file);
      form.append("documentType", "other");

      return api.post("/documents", form, {
        headers: { "Content-Type": "multipart/form-data" },
        onUploadProgress: (p) => {
          newProgress[file.name] = Math.round((p.loaded * 100) / p.total);
          setProgress({ ...newProgress });
        },
      });
    });

    await Promise.all(uploads);

    setSelectedFiles([]);
    setPreview(null);
    setProgress({});
    fetchDocs();
  };

  const download = async (id, name) => {
    const res = await api.get(`/documents/${id}/download`, {
      responseType: "blob",
    });

    const url = window.URL.createObjectURL(new Blob([res.data]));
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    a.click();
  };

  const remove = async (id) => {
    if (!window.confirm("Delete this document?")) return;

    await api.delete(`/documents/${id}`);
    fetchDocs();
  };

  const iconFor = (name) => {
    const ext = name.split(".").pop().toLowerCase();

    if (["jpg", "jpeg", "png", "gif"].includes(ext))
      return <ImageIcon size={28} />;

    if (ext === "pdf") return <FileText size={28} />;

    return <File size={28} />;
  };

  const filtered = files.filter((f) => {
    const matchesSearch = f.documentName
      .toLowerCase()
      .includes(search.toLowerCase());

    const matchesFilter = filter === "all" || f.documentType === filter;

    return matchesSearch && matchesFilter;
  });

  return (
    <div style={{ padding: "2rem", color: "var(--text-color)" }}>
      <h1
        style={{ marginBottom: "1rem", fontSize: "1.8rem", fontWeight: 600 }}
      >
        Documents
      </h1>

      {/* Search + Filter */}
      <div style={{ display: "flex", gap: "1rem", marginBottom: "1.5rem" }}>
        <div style={{ position: "relative", flex: 1 }}>
          <Search
            size={18}
            style={{
              position: "absolute",
              top: 12,
              left: 10,
              opacity: 0.5,
            }}
          />

          <input
            placeholder="Search documents..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            style={{
              width: "100%",
              padding: "0.7rem 2.5rem",
              borderRadius: 10,
            }}
          />
        </div>

        <select
          value={filter}
          onChange={(e) => setFilter(e.target.value)}
          style={{ padding: "0.7rem", borderRadius: 10 }}
        >
          <option value="all">All</option>
          <option value="invoice">Invoices</option>
          <option value="document">Documents</option>
          <option value="other">Other</option>
        </select>
      </div>

      {/* Upload Zone */}
      <div
        onDragOver={(e) => {
          e.preventDefault();
          setDragOver(true);
        }}
        onDragLeave={() => setDragOver(false)}
        onDrop={handleDrop}
        style={{
          border: dragOver
            ? "2px dashed #f97316"
            : "2px dashed var(--card-border)",
          padding: "2rem",
          borderRadius: 15,
          textAlign: "center",
          marginBottom: "2rem",
        }}
      >
        <Upload size={40} style={{ opacity: 0.7 }} />
        <p>Drag & Drop files here or click to select</p>

        <input
          id="fileInput"
          type="file"
          multiple
          style={{ display: "none" }}
          onChange={handleFileSelection}
        />

        <button onClick={() => document.getElementById("fileInput").click()}>
          Choose Files
        </button>
      </div>

      {/* Preview + Upload */}
      {selectedFiles.length > 0 && (
        <div
          style={{
            marginBottom: "2rem",
            padding: "1rem",
            borderRadius: 10,
            background: "var(--card-bg)",
          }}
        >
          <h3>Selected Files</h3>

          {preview && (
            <img
              src={preview}
              alt="preview"
              style={{
                maxHeight: 120,
                borderRadius: 8,
                marginBottom: "1rem",
              }}
            />
          )}

          {selectedFiles.map((f) => (
            <div key={f.name} style={{ marginBottom: "0.5rem" }}>
              {f.name}

              {progress[f.name] && (
                <div
                  style={{
                    height: 6,
                    background: "#333",
                    borderRadius: 4,
                    marginTop: 4,
                  }}
                >
                  <div
                    style={{
                      width: `${progress[f.name]}%`,
                      height: "100%",
                      background: "#f97316",
                      borderRadius: 4,
                    }}
                  />
                </div>
              )}
            </div>
          ))}

          <button onClick={upload} style={{ marginTop: "1rem" }}>
            Upload All
          </button>
        </div>
      )}

      {/* Files Grid */}
      <div
        style={{
          display: "grid",
          gap: "1rem",
          gridTemplateColumns: "repeat(auto-fill, minmax(250px, 1fr))",
        }}
      >
        {filtered.map((f) => (
          <div
            key={f.id}
            style={{
              padding: "1.2rem",
              borderRadius: 12,
              background: "var(--card-bg)",
              border: "1px solid var(--card-border)",
            }}
          >
            <div style={{ marginBottom: "1rem" }}>{iconFor(f.documentName)}</div>

            <h4 style={{ marginBottom: "0.5rem" }}>{f.documentName}</h4>
            <p style={{ opacity: 0.7, fontSize: "0.85rem" }}>
              {f.documentType}
            </p>

            <div style={{ marginTop: "1rem", display: "flex", gap: "0.5rem" }}>
              <button onClick={() => download(f.id, f.documentName)}>
                <Download size={18} />
              </button>

              <button onClick={() => remove(f.id)}>
                <Trash2 size={18} />
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Login.jsx">
import React, { useState, useContext } from 'react';
import { AuthContext } from '../context/AuthContext';
import OTPVerify from './OTPVerify';

export default function Login() {
  const { login } = useContext(AuthContext);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [userId, setUserId] = useState(null);
  const [otpSent, setOtpSent] = useState(false);
  const [error, setError] = useState(null);

  const submit = async (e) => {
    e.preventDefault();
    setError(null);
    try {
      const res = await login(username, password);
      if (res?.otpSent) {
        setUserId(res.userId);
        setOtpSent(true);
      }
    } catch (err) {
      setError(err.response?.data?.error || 'Login failed');
    }
  };

  if (otpSent) return <OTPVerify userId={userId} />;

  return (
    <div style={styles.page}>
      <div style={styles.overlay}>
        <div style={styles.card}>
          <h2 style={styles.title}>LOGIN</h2>
          {error && <p style={styles.error}>{error}</p>}
          <form onSubmit={submit}>
            <input
              style={styles.input}
              placeholder="Username"
              type="text"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              required
            />
            <input
              style={styles.input}
              placeholder="Password"
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
            />
            <div style={styles.options}>
              
              
            </div>
            <button type="submit" style={styles.button}>Send OTP</button>
            
          </form>
        </div>
      </div>
    </div>
  );
}

const styles = {
  page: {
    height: '100vh',
    background: 'var(--bg-glow), var(--bg-base)',
    backgroundImage:
      'url("https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1920&q=80")',
    backgroundSize: 'cover',
    backgroundPosition: 'center',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    fontFamily: "'Poppins', sans-serif",
    color: '#f5f5f5',
  },
  overlay: {
    backdropFilter: 'blur(10px)',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    width: '100%',
    height: '100%',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
  },
  card: {
    width: 380,
    background: 'rgba(255,255,255,0.05)',
    boxShadow: '0 8px 40px rgba(0,0,0,0.6)',
    borderRadius: 16,
    padding: '2rem 2.5rem',
    textAlign: 'center',
    border: '1px solid rgba(255,255,255,0.1)',
  },
  title: {
    marginBottom: '1.5rem',
    letterSpacing: 1,
    fontWeight: 600,
    fontSize: '1.5rem',
  },
  input: {
    width: '100%',
    padding: '12px 14px',
    border: 'none',
    borderRadius: 8,
    outline: 'none',
    background: 'rgba(255,255,255,0.08)',
    color: '#fff',
    fontSize: 14,
    marginBottom: '1rem',
  },
  options: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    fontSize: 13,
    marginBottom: '1.2rem',
    color: '#bbb',
  },
  checkbox: {
    display: 'flex',
    alignItems: 'center',
    gap: 6,
  },
  button: {
    width: '100%',
    padding: '12px',
    border: 'none',
    borderRadius: 8,
    background: 'linear-gradient(135deg, #1e3c72, #2a5298)',
    color: '#fff',
    cursor: 'pointer',
    fontWeight: 500,
    transition: 'all 0.3s ease',
  },
  link: {
    color: '#7eb2f2',
    textDecoration: 'none',
    cursor: 'pointer',
  },
  registerText: {
    fontSize: 13,
    marginTop: '1rem',
    color: '#aaa',
  },
  error: {
    color: '#ff7070',
    marginBottom: '1rem',
  },
};
</file>

<file path="src/pages/orders/MyOrders.jsx">
import React, { useEffect, useState } from "react";
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  Table,
  TableBody,
  TableRow,
  TableCell,
  TableHead,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Snackbar,
  Alert,
} from "@mui/material";
import { orderAPI, materialAPI, invoiceAPI } from "../../services/api";
import { useAuth } from "../../context/AuthContext";
export default function MyOrders() {
  const [orders, setOrders] = useState([]);
  const [materials, setMaterials] = useState({});
  const [openOrder, setOpenOrder] = useState(null); // order object for modal
  const [submitting, setSubmitting] = useState(false);
  const [totalAmount, setTotalAmount] = useState("");
  const [description, setDescription] = useState("");
  const [snack, setSnack] = useState({ open: false, severity: "success", message: "" });
  const { user: currentUser } = useAuth();

  useEffect(() => {
    async function loadData() {
      try {
        // 1. Load materials
        const mres = await materialAPI.getMaterials();
        const matMap = {};
        (mres?.materials || []).forEach((m) => {
          matMap[m.id] = m;
        });
        setMaterials(matMap);

        // 2. Load orders
        const ores = await orderAPI.getMyOrders();
        setOrders(ores?.orders || []);
      } catch (err) {
        console.error(err);
      }
    }

    loadData();
  }, []);

  const statusColor = {
    Pending: "warning",
    Approved: "success",
    Rejected: "error",
  };

  const refreshOrders = async () => {
    try {
      const ores = await orderAPI.getMyOrders();
      setOrders(ores?.orders || []);
    } catch (err) {
      console.error("refreshOrders:", err);
    }
  };

  const handleOpenRaise = (order) => {
    setOpenOrder(order);
    setTotalAmount(order.totalAmount || "");
    setDescription("");
  };

  const handleCloseModal = () => {
    setOpenOrder(null);
    setSubmitting(false);
  };

  const handleSubmitInvoice = async () => {
    if (!openOrder) return;
    setSubmitting(true);
    try {
      const payload = {
        orderId: openOrder.id,
        // optional overrides ‚Äî backend will derive totalAmount if omitted
        totalAmount: totalAmount ? Number(totalAmount) : undefined,
        description: description || undefined,
      };

      // invoiceAPI.createInvoice should POST to /api/invoices and handle auth headers
      await invoiceAPI.createInvoice(payload);

      setSnack({
        open: true,
        severity: "success",
        message: "Invoice created successfully",
      });

      handleCloseModal();
      await refreshOrders();
    } catch (err) {
      console.error("create invoice error:", err);
      const errMsg =
        err?.response?.data?.error ||
        err?.message ||
        "Failed to create invoice";
      setSnack({ open: true, severity: "error", message: errMsg });
      setSubmitting(false);
    }
  };

  return (
    <Box p={4}>
      <Typography variant="h5" mb={3}>
        My Orders
      </Typography>

      <Card>
        <CardContent>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Order Number</TableCell>
                <TableCell>Materials</TableCell>
                <TableCell>Quantity</TableCell>
                <TableCell>Status</TableCell>
                <TableCell>Action</TableCell>
              </TableRow>
            </TableHead>

            <TableBody>
              {orders.map((order) => {
                // join material names for display
                const materialsText = (order.items || [])
                  .map((it) => materials[it.materialId]?.name || "Unknown")
                  .join(", ");

                const totalQty = (order.items || []).reduce(
                  (s, it) => s + Number(it.qty || 0),
                  0
                );

                const canRaiseInvoice =
                  (currentUser?.role || "").toLowerCase() === "dealer_staff" &&
                  order?.status === "Approved";

                return (
                  <TableRow key={order.id}>
                    <TableCell>{order.orderNumber}</TableCell>
                    <TableCell>{materialsText || "‚Äî"}</TableCell>
                    <TableCell>{totalQty}</TableCell>
                    <TableCell>
                      <Chip
                        label={order.status}
                        color={statusColor[order.status] || "default"}
                      />
                    </TableCell>
                    <TableCell>
                      {canRaiseInvoice ? (
                        <Button
                          variant="contained"
                          color="primary"
                          size="small"
                          onClick={() => handleOpenRaise(order)}
                        >
                          Raise Invoice
                        </Button>
                      ) : (
                        <Button
                          variant="outlined"
                          size="small"
                          disabled
                          title={
                            order.status !== "Approved"
                              ? "Order not approved"
                              : "Insufficient role"
                          }
                        >
                          Raise Invoice
                        </Button>
                      )}
                    </TableCell>
                  </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* Raise Invoice Dialog */}
      <Dialog open={!!openOrder} onClose={handleCloseModal}>
        <DialogTitle>
          {openOrder ? `Raise Invoice for ${openOrder.orderNumber}` : "Raise Invoice"}
        </DialogTitle>
        <DialogContent>
          <TextField
            label="Total Amount"
            type="number"
            value={totalAmount}
            onChange={(e) => setTotalAmount(e.target.value)}
            fullWidth
            margin="normal"
            helperText="Leave blank to use order total"
          />
          <TextField
            label="Description"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            fullWidth
            margin="normal"
            multiline
            rows={3}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseModal} disabled={submitting}>
            Cancel
          </Button>
          <Button
            onClick={handleSubmitInvoice}
            variant="contained"
            color="primary"
            disabled={submitting}
          >
            {submitting ? "Creating..." : "Create Invoice"}
          </Button>
        </DialogActions>
      </Dialog>

      <Snackbar
        open={snack.open}
        autoHideDuration={6000}
        onClose={() => setSnack((s) => ({ ...s, open: false }))}
      >
        <Alert
          onClose={() => setSnack((s) => ({ ...s, open: false }))}
          severity={snack.severity}
        >
          {snack.message}
        </Alert>
      </Snackbar>
    </Box>
  );
}
</file>

<file path="src/pages/OTPVerify.jsx">
import React, { useState, useContext } from "react";
import { AuthContext } from "../context/AuthContext";
import { useNavigate } from "react-router-dom";

export default function OTPVerify({ userId }) {
  const { verifyOTP } = useContext(AuthContext);
  const [otp, setOtp] = useState("");
  const [error, setError] = useState(null);
  const navigate = useNavigate();

  const handleVerify = async (e) => {
    e.preventDefault();
    setError(null);
    try {
      await verifyOTP(userId, otp);
      navigate("/dashboard");
    } catch (err) {
      setError(err.response?.data?.error || "OTP verification failed");
    }
  };

  return (
    <div style={styles.page}>
      <div style={styles.overlay}>
        <div style={styles.card}>
          <h2 style={styles.title}>Verify OTP</h2>
          {error && <p style={styles.error}>{error}</p>}
          <form onSubmit={handleVerify}>
            <input
              style={styles.input}
              placeholder="Enter OTP"
              value={otp}
              onChange={(e) => setOtp(e.target.value)}
              required
            />
            <button type="submit" style={styles.button}>Verify</button>
          </form>
        </div>
      </div>
    </div>
  );
}

const styles = {
  page: {
    height: '100vh',
    background: 'var(--bg-glow), var(--bg-base)',
    backgroundImage:
      'url("https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1920&q=80")',
    backgroundSize: 'cover',
    backgroundPosition: 'center',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    fontFamily: "'Poppins', sans-serif",
    color: '#f5f5f5',
  },
  overlay: {
    backdropFilter: 'blur(10px)',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    width: '100%',
    height: '100%',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
  },
  card: {
    width: 360,
    background: 'rgba(255,255,255,0.05)',
    boxShadow: '0 8px 40px rgba(0,0,0,0.6)',
    borderRadius: 16,
    padding: '2rem 2.5rem',
    textAlign: 'center',
    border: '1px solid rgba(255,255,255,0.1)',
  },
  title: {
    marginBottom: '1.5rem',
    letterSpacing: 1,
    fontWeight: 600,
    fontSize: '1.5rem',
  },
  input: {
    width: '100%',
    padding: '12px 14px',
    border: 'none',
    borderRadius: 8,
    outline: 'none',
    background: 'rgba(255,255,255,0.08)',
    color: '#fff',
    fontSize: 14,
    marginBottom: '1rem',
  },
  button: {
    width: '100%',
    padding: '12px',
    border: 'none',
    borderRadius: 8,
    background: 'linear-gradient(135deg, #1e3c72, #2a5298)',
    color: '#fff',
    cursor: 'pointer',
    fontWeight: 500,
    transition: 'all 0.3s ease',
  },
  error: {
    color: '#ff7070',
    marginBottom: '1rem',
  },
};
</file>

<file path="src/theme.js">
import { createTheme } from "@mui/material/styles";

export default function getTheme(mode = "dark") {
  const isDark = mode === "dark";

  return createTheme({
    palette: {
      mode,
      primary: {
        main: "#f97316", // glowing amber accent
      },
      secondary: {
        main: "#a78bfa", // lavender accent
      },
      background: {
        default: isDark ? "#0b0d10" : "#f9fafb",
        paper: isDark
          ? "rgba(255,255,255,0.04)"
          : "rgba(255,255,255,0.9)",
      },
      text: {
        primary: isDark ? "#f8fafc" : "#1e293b",
        secondary: isDark ? "#94a3b8" : "#475569",
      },
      divider: isDark
        ? "rgba(255,255,255,0.08)"
        : "rgba(0,0,0,0.08)",
    },

    typography: {
      fontFamily: "'Inter', 'Poppins', sans-serif",
      allVariants: {
        transition: "color 0.3s ease",
      },
      h1: { fontWeight: 700 },
      h2: { fontWeight: 700 },
      h3: { fontWeight: 600 },
      h4: { fontWeight: 600 },
      h5: { fontWeight: 600 },
      h6: { fontWeight: 500 },
      body1: { lineHeight: 1.6 },
    },

    shape: { borderRadius: 20 },

    components: {
      // üåô Cards with glass effect
      MuiCard: {
        styleOverrides: {
          root: {
            borderRadius: 20,
            background: isDark
              ? "rgba(255,255,255,0.05)"
              : "rgba(255,255,255,0.8)",
            backdropFilter: "blur(12px)",
            border: isDark
              ? "1px solid rgba(255,255,255,0.08)"
              : "1px solid rgba(0,0,0,0.08)",
            boxShadow: isDark
              ? "0 10px 30px rgba(0,0,0,0.4), inset 0 0 10px rgba(255,255,255,0.03)"
              : "0 6px 20px rgba(0,0,0,0.15)",
            transition: "all 0.3s ease",
            "&:hover": {
              transform: "translateY(-4px)",
              boxShadow: isDark
                ? "0 16px 40px rgba(249,115,22,0.4)"
                : "0 12px 24px rgba(249,115,22,0.3)",
            },
          },
        },
      },

      // ‚ú® Buttons (rounded glowing gradients)
      MuiButton: {
        styleOverrides: {
          root: {
            borderRadius: 12,
            textTransform: "none",
            fontWeight: 600,
            paddingInline: 18,
            paddingBlock: 10,
            background:
              "linear-gradient(90deg, #f97316, #ea580c)",
            color: "#fff",
            boxShadow: "0 4px 20px rgba(249,115,22,0.3)",
            "&:hover": {
              boxShadow: "0 6px 25px rgba(249,115,22,0.4)",
              transform: "translateY(-2px)",
            },
          },
        },
      },

      // üìä Table cells (subtle borders + glow headers)
      MuiTableCell: {
        styleOverrides: {
          head: {
            fontWeight: 700,
            background: isDark
              ? "rgba(249,115,22,0.1)"
              : "rgba(249,115,22,0.15)",
            color: "#fbbf24",
          },
          root: {
            borderBottom: isDark
              ? "1px solid rgba(255,255,255,0.08)"
              : "1px solid rgba(0,0,0,0.08)",
          },
        },
      },

      // üß± Paper (glass backgrounds for menus/dialogs)
      MuiPaper: {
        styleOverrides: {
          root: {
            background: isDark
              ? "rgba(30,30,32,0.9)"
              : "rgba(255,255,255,0.85)",
            backdropFilter: "blur(10px)",
            borderRadius: 20,
            border: isDark
              ? "1px solid rgba(255,255,255,0.08)"
              : "1px solid rgba(0,0,0,0.08)",
          },
        },
      },

      // üß≠ AppBar / Navbar consistency
      MuiAppBar: {
        styleOverrides: {
          root: {
            background: isDark
              ? "rgba(26, 26, 31, 0.75)"
              : "rgba(255,255,255,0.8)",
            backdropFilter: "blur(14px)",
            color: isDark ? "#f8fafc" : "#1e293b",
            boxShadow: isDark
              ? "0 4px 24px rgba(0,0,0,0.5)"
              : "0 4px 24px rgba(0,0,0,0.1)",
          },
        },
      },

      // üîò Inputs / TextFields
      MuiOutlinedInput: {
        styleOverrides: {
          root: {
            borderRadius: 12,
            background: isDark
              ? "rgba(255,255,255,0.06)"
              : "rgba(0,0,0,0.03)",
            "& fieldset": {
              borderColor: isDark
                ? "rgba(255,255,255,0.1)"
                : "rgba(0,0,0,0.1)",
            },
            "&:hover fieldset": {
              borderColor: "#f97316",
            },
          },
          input: {
            color: isDark ? "#e2e8f0" : "#1e293b",
          },
        },
      },
    },
  });
}
</file>

<file path="src/components/Layout.jsx">
import React from "react";
import Navbar from "./Navbar";
import Sidebar from "./Sidebar";
import { Outlet } from "react-router-dom";

export default function Layout() {
  return (
    <div
      style={{
        display: "flex",
        minHeight: "100vh",
        background: "var(--bg-glow), var(--bg-base)",
        color: "var(--text-color)",
      }}
    >
      {/* ‚úÖ Sidebar - now flexible height */}
      <Sidebar />

      {/* ‚úÖ Main section (Navbar + dashboard) */}
      <div
        style={{
          flex: 1,
          display: "flex",
          flexDirection: "column",
        }}
      >
        <Navbar />

        <main
          style={{
            flex: 1,
            padding: "2rem",
            overflowX: "hidden",
          }}
        >
          <div
            style={{
              background: "var(--card-bg)",
              borderRadius: "20px",
              border: "1px solid var(--card-border)",
              padding: "2rem",
              boxShadow: "0 4px 20px rgba(0,0,0,0.15)",
              backdropFilter: "blur(12px)",
              minHeight: "calc(100vh - 100px)", // subtracts navbar height
            }}
          >
            <Outlet />
          </div>
        </main>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Campaigns.jsx">
import React, { useEffect, useState, useContext } from "react";
import api from "../services/api";
import { AuthContext } from "../context/AuthContext";
import { Target, Calendar, ArrowRight } from "lucide-react";

export default function Campaigns() {
  const { user } = useContext(AuthContext);
  const [campaigns, setCampaigns] = useState([]);
  const [form, setForm] = useState({
    campaignName: "",
    campaignType: "promotion",
    description: "",
    startDate: "",
    endDate: "",
    isActive: true,
  });

  const [loading, setLoading] = useState(false);
  const isAdmin = user?.role === "admin";

  // Fetch campaigns
  const fetchCampaigns = async () => {
    try {
      setLoading(true);
      let res;

      if (isAdmin) {
        res = await api.get("/campaigns"); // admin: all campaigns
      } else {
        res = await api.get("/campaigns/active"); // dealers: only active
      }

      setCampaigns(res.data.campaigns || res.data);
    } catch (err) {
      console.error("Failed to fetch campaigns:", err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchCampaigns();
  }, [isAdmin]);

  // Create campaign (Admin only)
  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      await api.post("/campaigns", form);

      setForm({
        campaignName: "",
        campaignType: "promotion",
        description: "",
        startDate: "",
        endDate: "",
        isActive: true,
      });

      fetchCampaigns();
    } catch (err) {
      console.error("Error creating campaign:", err);
      alert(err.response?.data?.error || "Failed to create campaign");
    }
  };

  // Delete campaign (Admin only)
  const deleteCampaign = async (id) => {
    if (!window.confirm("Delete this campaign?")) return;

    try {
      await api.delete(`/campaigns/${id}`);
      fetchCampaigns();
    } catch (err) {
      console.error("Failed to delete campaign:", err);
      alert("Failed to delete campaign");
    }
  };

  return (
    <div style={styles.container}>
      <h2 style={styles.title}>
        <span style={{ display: "flex", alignItems: "center", gap: "8px" }}>
          <Target size={22} />
          Campaigns
        </span>
      </h2>

      {loading ? (
        <p>Loading campaigns...</p>
      ) : (
        <>
          {/* Admin Form */}
          {isAdmin && (
            <form onSubmit={handleSubmit} style={styles.form}>
              <h3>Create Campaign</h3>

              <input
                type="text"
                placeholder="Campaign Name"
                value={form.campaignName}
                onChange={(e) =>
                  setForm({ ...form, campaignName: e.target.value })
                }
                required
              />

              <select
                value={form.campaignType}
                onChange={(e) =>
                  setForm({ ...form, campaignType: e.target.value })
                }
              >
                <option value="promotion">Promotion</option>
                <option value="sales_scheme">Sales Scheme</option>
                <option value="seasonal_offer">Seasonal Offer</option>
              </select>

              <textarea
                placeholder="Description"
                value={form.description}
                onChange={(e) =>
                  setForm({ ...form, description: e.target.value })
                }
              />

              <div style={styles.dateRow}>
                <label>
                  Start:
                  <input
                    type="date"
                    value={form.startDate}
                    onChange={(e) =>
                      setForm({ ...form, startDate: e.target.value })
                    }
                    required
                  />
                </label>

                <label>
                  End:
                  <input
                    type="date"
                    value={form.endDate}
                    onChange={(e) =>
                      setForm({ ...form, endDate: e.target.value })
                    }
                    required
                  />
                </label>
              </div>

              <label>
                Active:
                <input
                  type="checkbox"
                  checked={form.isActive}
                  onChange={(e) =>
                    setForm({ ...form, isActive: e.target.checked })
                  }
                />
              </label>

              <button type="submit" style={styles.button}>
                Add Campaign
              </button>
            </form>
          )}

          {/* Campaign List */}
          <div style={styles.list}>
            {campaigns.length === 0 ? (
              <p>No campaigns found.</p>
            ) : (
              campaigns.map((c) => (
                <div key={c.id} style={styles.card}>
                  <h3>{c.campaignName}</h3>

                  <p>
                    <b>Type:</b> {c.campaignType}
                  </p>

                  <p>{c.description}</p>

                  {/* Icon-based dates */}
                  <p style={{ display: "flex", alignItems: "center", gap: "6px" }}>
                    <Calendar size={18} />
                    {new Date(c.startDate).toLocaleDateString()}
                    <ArrowRight size={16} />
                    {new Date(c.endDate).toLocaleDateString()}
                  </p>

                  <span
                    style={{
                      color: c.isActive ? "green" : "red",
                      fontWeight: "bold",
                    }}
                  >
                    {c.isActive ? "Active" : "Inactive"}
                  </span>

                  {isAdmin && (
                    <button
                      onClick={() => deleteCampaign(c.id)}
                      style={styles.delete}
                    >
                      Delete
                    </button>
                  )}
                </div>
              ))
            )}
          </div>
        </>
      )}
    </div>
  );
}

const styles = {
  container: { padding: "2rem", fontFamily: "Poppins, sans-serif" },
  title: { marginBottom: "1rem", fontWeight: "600", fontSize: "1.4rem" },

  form: {
    display: "grid",
    gap: "0.8rem",
    maxWidth: 500,
    marginBottom: "2rem",
    background: "#fafafa",
    padding: "1rem",
    borderRadius: "8px",
  },

  dateRow: { display: "flex", gap: "1rem", justifyContent: "space-between" },

  button: {
    background: "#1e3c72",
    color: "white",
    border: "none",
    borderRadius: "8px",
    padding: "10px",
    cursor: "pointer",
  },

  list: { display: "grid", gap: "1rem" },

  card: {
    padding: "1rem",
    border: "1px solid #ccc",
    borderRadius: "8px",
    background: "#fff",
  },

  delete: {
    marginTop: "0.5rem",
    background: "#e74c3c",
    color: "white",
    border: "none",
    borderRadius: "5px",
    padding: "6px 10px",
    cursor: "pointer",
  },
};
</file>

<file path="src/pages/Dashboard.jsx">
import React, { useContext } from "react";
import { AuthContext } from "../context/AuthContext";

import SuperAdminDashboard from "./dashboards/SuperAdminDashboard";
import AdminDashboard from "./dashboards/AdminDashboard";
import ManagerDashboard from "./dashboards/ManagerDashboard";
import DealerDashboard from "./dashboards/DealerDashboard";
import AccountsDashboard from "./dashboards/AccountsDashboard";
import InventoryDashboard from "./dashboards/InventoryDashboard";
import TechnicalAdminDashboard from "./dashboards/TechnicalAdminDashboard";
import RegionalAdminDashboard from "./dashboards/RegionalAdminDashboard";
import FinanceAdminDashboard from "./dashboards/FinanceAdminDashboard";
import RegionalManagerDashboard from "./dashboards/RegionalManagerDashboard";
import AreaManagerDashboard from "./dashboards/AreaManagerDashboard";
import TerritoryManagerDashboard from "./dashboards/TerritoryManagerDashboard";
import DealerStaffDashboard from "./dashboards/DealerStaffDashboard";

export default function Dashboard() {
  const { user } = useContext(AuthContext);

  if (!user) return <p>Loading...</p>;

  const role = user.role?.toLowerCase();

  const roleMap = {
    super_admin: <SuperAdminDashboard />,
    technical_admin: <TechnicalAdminDashboard />,
    regional_admin: <RegionalAdminDashboard />,
    finance_admin: <FinanceAdminDashboard />,
    regional_manager: <RegionalManagerDashboard />,
    area_manager: <AreaManagerDashboard />,
    territory_manager: <TerritoryManagerDashboard />,
    dealer_admin: <DealerDashboard />,
    dealer_staff: <DealerStaffDashboard />,
    inventory_user: <InventoryDashboard />,
    accounts_user: <AccountsDashboard />,
  };

  return roleMap[role] || <p>No dashboard available for role: {role}</p>;
}
</file>

<file path="src/components/Navbar.jsx">
import React, { useContext, useState } from "react";
import { AuthContext } from "../context/AuthContext";
import { useNavigate } from "react-router-dom";
import { useThemeMode } from "../context/ThemeContext";
import { useNotifications } from "../context/NotificationContext";
import SearchInput from "./SearchInput";

import {
  IconButton,
  Tooltip,
  Avatar,
  Badge,
  Menu,
  MenuItem,
  Typography,
  Divider,
} from "@mui/material";

// Lucide Icons
import {
  Sun,
  Moon,
  Bell,
  PlusCircle,
  LogOut,
} from "lucide-react";

export default function Navbar() {
  const { user, logout } = useContext(AuthContext);
  const navigate = useNavigate();
  const { mode, toggle } = useThemeMode();
  const { notifications, unread, markAllAsRead } = useNotifications();

  const [globalSearch, setGlobalSearch] = useState("");
  const [anchorEl, setAnchorEl] = useState(null);
  const open = Boolean(anchorEl);

  const handleLogout = () => {
    logout();
    navigate("/login");
  };

  const handleNotifOpen = (e) => setAnchorEl(e.currentTarget);
  const handleNotifClose = () => setAnchorEl(null);

  const isDark = mode === "dark";

  return (
    <nav
      style={{
        display: "flex",
        alignItems: "center",
        justifyContent: "space-between",
        padding: "0.75rem 1.5rem",
        backdropFilter: "blur(14px)",
        background: isDark ? "rgba(12,12,14,0.75)" : "rgba(255,255,255,0.8)",
        borderBottom: isDark
          ? "1px solid rgba(255,255,255,0.06)"
          : "1px solid rgba(0,0,0,0.08)",
        position: "sticky",
        top: 0,
        zIndex: 50,
        boxShadow: isDark
          ? "0 4px 24px rgba(0,0,0,0.4)"
          : "0 4px 20px rgba(0,0,0,0.1)",
      }}
    >
      {/* Search Bar */}
      <div style={{ flex: 1, maxWidth: 500 }}>
        <SearchInput
          placeholder="Search modules, dealers..."
          value={globalSearch}
          onChange={(e) => setGlobalSearch(e.target.value)}
        />
      </div>

      <div style={{ display: "flex", alignItems: "center", gap: "1rem" }}>
        {/* Create New */}
        <Tooltip title="Create New">
          <IconButton
            sx={{
              color: "#f97316",
              "&:hover": { transform: "scale(1.1)", color: "#fb923c" },
            }}
            onClick={() => navigate("/invoices")}
          >
            <PlusCircle size={22} />
          </IconButton>
        </Tooltip>

        {/* Notifications */}
        <Tooltip title="Notifications">
          <IconButton
            onClick={handleNotifOpen}
            sx={{
              color: isDark ? "#f8fafc" : "#1e293b",
              "&:hover": { color: "#f97316" },
            }}
          >
            <Badge badgeContent={unread} color="error">
              <Bell size={22} />
            </Badge>
          </IconButton>
        </Tooltip>

        {/* Notifications Menu */}
        <Menu
          anchorEl={anchorEl}
          open={open}
          onClose={handleNotifClose}
          PaperProps={{
            elevation: 4,
            sx: { mt: 1, minWidth: 300, borderRadius: 2, p: 0.5 },
          }}
        >
          <MenuItem
            onClick={() => {
              markAllAsRead();
              handleNotifClose();
            }}
            sx={{
              fontWeight: 500,
              color: "#f97316",
              justifyContent: "center",
              fontSize: "0.85rem",
            }}
          >
            Mark all as read
          </MenuItem>

          <Divider />

          {notifications.length > 0 ? (
            notifications.slice(0, 8).map((n, idx) => (
              <MenuItem
                key={idx}
                onClick={handleNotifClose}
                sx={{
                  flexDirection: "column",
                  alignItems: "flex-start",
                  gap: 0.3,
                  backgroundColor: n.isRead
                    ? "transparent"
                    : "rgba(249,115,22,0.08)",
                }}
              >
                <Typography
                  variant="subtitle2"
                  fontWeight={!n.isRead ? 600 : 400}
                  sx={{ color: "#f97316" }}
                >
                  {n.title}
                </Typography>
                <Typography variant="body2" color="text.secondary">
                  {n.message}
                </Typography>
              </MenuItem>
            ))
          ) : (
            <MenuItem disabled>
              <Typography variant="body2" color="text.secondary">
                No notifications yet
              </Typography>
            </MenuItem>
          )}
        </Menu>

        {/* Theme Toggle */}
        <Tooltip title="Toggle Theme">
          <IconButton
            onClick={toggle}
            sx={{
              color: isDark ? "#fbbf24" : "#0f172a",
              "&:hover": { color: "#f97316" },
            }}
          >
            {isDark ? <Sun size={22} /> : <Moon size={22} />}
          </IconButton>
        </Tooltip>

        {/* User */}
        {user && (
          <div style={{ display: "flex", alignItems: "center", gap: "0.6rem" }}>
            <Avatar sx={{ width: 36, height: 36, bgcolor: "#f97316" }}>
              {user.name ? user.name[0].toUpperCase() : "U"}
            </Avatar>
            <div style={{ fontSize: "0.9rem", color: "#cbd5e1" }}>
              <strong>{user.name || "User"}</strong>
            </div>
          </div>
        )}

        {/* Logout */}
        <Tooltip title="Logout">
          <IconButton
            onClick={handleLogout}
            sx={{ color: "#ef4444", "&:hover": { transform: "scale(1.1)" } }}
          >
            <LogOut size={22} />
          </IconButton>
        </Tooltip>
      </div>
    </nav>
  );
}
</file>

<file path="src/pages/dashboards/AccountsDashboard.jsx">
import React, { useEffect, useState, useContext } from "react";
import api from "../../services/api";
import { AuthContext } from "../../context/AuthContext";

import PageHeader from "../../components/PageHeader";
import Toolbar from "../../components/Toolbar";
import SearchInput from "../../components/SearchInput";
import IconPillButton from "../../components/IconPillButton";
import DataTable from "../../components/DataTable";

import { toast } from "react-toastify";
import {
  BarChart3,
  FileText,
  Download,
  CreditCard,
  TrendingUp,
  TrendingDown,
  Wallet,
  RefreshCcw,
  CheckCircle2,
  AlertCircle,
} from "lucide-react";

import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
  PieChart,
  Pie,
  Cell,
} from "recharts";


export default function AccountsDashboard() {
  const { user } = useContext(AuthContext);

  const [summary, setSummary] = useState({});
  const [statements, setStatements] = useState([]);
  const [invoices, setInvoices] = useState([]);
  const [reconciliation, setReconciliation] = useState([]);
  const [search, setSearch] = useState("");
  const [loading, setLoading] = useState(true);

  // Role-Based Color Themes
  const roleTheme = {
    dealer: { color: "#3b82f6", bg: "#eff6ff" },
    manager: { color: "#f59e0b", bg: "#fff7ed" },
    accounts: { color: "#22c55e", bg: "#f0fdf4" },
    admin: { color: "#8b5cf6", bg: "#f5f3ff" },
  };

  const theme = roleTheme[user?.role] || { color: "#6b7280", bg: "#f9fafb" };
  const COLORS = ["#22c55e", "#3b82f6", "#f59e0b", "#ef4444", "#8b5cf6"];


  // Fetch All Accounts Data
  const fetchData = async () => {
    try {
      setLoading(true);

      const [summaryRes, stmtRes, invRes, recRes] = await Promise.all([
        api.get("/accounts/summary"),
        api.get("/accounts/statements"),
        api.get("/accounts/invoices"),
        api.get("/accounts/reconciliation"),
      ]);

      setSummary(summaryRes.data || {});
      setStatements(stmtRes.data?.statements || []);
      setInvoices(invRes.data?.invoices || []);
      setReconciliation(recRes.data?.pending || []);
    } catch (err) {
      toast.error("Failed to load accounts data");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);


  // Filter Search (Statements)
  const filtered = statements.filter((item) =>
    item.description?.toLowerCase().includes(search.toLowerCase())
  );

  // Chart Data Processing
  const barData =
    invoices.map((inv) => ({
      month: new Date(inv.invoiceDate).toLocaleString("default", { month: "short" }),
      total: inv.totalAmount,
      paid: inv.paidAmount,
    })) || [];

  const pieData = [
    { name: "Paid", value: invoices.reduce((s, i) => s + i.paidAmount, 0) },
    {
      name: "Outstanding",
      value: invoices.reduce((s, i) => s + (i.totalAmount - i.paidAmount), 0),
    },
  ];

  // Export Account Data
  const handleExport = async (format) => {
    try {
      const response = await api.get(`/accounts/export?format=${format}`, {
        responseType: "blob",
      });

      const blob = new Blob([response.data]);
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement("a");

      link.href = url;
      link.setAttribute(
        "download",
        `accounts_${new Date().toISOString().slice(0, 10)}.${format}`
      );

      document.body.appendChild(link);
      link.click();
    } catch (err) {
      toast.error("Export failed");
    }
  };


  // Data Table Columns
  const columns = [
    { key: "date", label: "Date" },
    { key: "documentNumber", label: "Document #" },
    { key: "debitAmount", label: "Debit" },
    { key: "creditAmount", label: "Credit" },
    { key: "balance", label: "Balance" },
  ];


  return (
    <div style={{ padding: "1rem", background: theme.bg, minHeight: "100vh" }}>
      <PageHeader
        title="Accounts Dashboard"
        subtitle={`Financial insights ‚Äî role: ${user?.role?.toUpperCase()}`}
        actions={[
          user?.role !== "dealer" && (
            <IconPillButton
              key="pdf"
              label="Export PDF"
              icon={<Download size={18} />}
              onClick={() => handleExport("pdf")}
            />
          ),
          user?.role !== "dealer" && (
            <IconPillButton
              key="excel"
              label="Export Excel"
              icon={<Download size={18} />}
              tone="success"
              onClick={() => handleExport("xlsx")}
            />
          ),
        ].filter(Boolean)}
      />

      {/* Role Tag */}
      <div
        style={{
          background: theme.color,
          color: "white",
          padding: "0.5rem 1rem",
          borderRadius: "10px",
          display: "inline-block",
          marginBottom: "1rem",
        }}
      >
        Logged in as <strong>{user?.role?.toUpperCase()}</strong>
      </div>

      {/* Search Bar */}
      <Toolbar>
        <SearchInput
          placeholder="Search by description or document number..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
        />
      </Toolbar>


      {/* Summary Cards */}
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "repeat(auto-fit, minmax(180px, 1fr))",
          gap: "1rem",
          marginTop: "1.2rem",
        }}
      >
        <SummaryCard
          icon={<FileText size={20} />}
          label="Invoices"
          value={summary.totalInvoices}
        />
        <SummaryCard
          icon={<TrendingUp size={20} color="#16a34a" />}
          label="Credit Notes"
          value={`‚Çπ${summary.totalCredit || 0}`}
        />
        <SummaryCard
          icon={<TrendingDown size={20} color="#dc2626" />}
          label="Debit Notes"
          value={`‚Çπ${summary.totalDebit || 0}`}
        />
        <SummaryCard
          icon={<Wallet size={20} />}
          label="Outstanding"
          value={`‚Çπ${summary.totalOutstanding || 0}`}
        />
      </div>


      {/* Charts Section */}
      <div
        style={{
          display: "grid",
          gridTemplateColumns: "2fr 1fr",
          gap: "1.5rem",
          marginTop: "2rem",
        }}
      >
        {/* Invoice Trend Chart */}
        <ChartCard title="Monthly Invoice Trends" icon={<BarChart3 size={18} />}>
          <ResponsiveContainer width="100%" height={280}>
            <BarChart data={barData}>
              <XAxis dataKey="month" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="total" fill={theme.color} name="Total Invoices" />
              <Bar dataKey="paid" fill="#22c55e" name="Paid Amount" />
            </BarChart>
          </ResponsiveContainer>
        </ChartCard>

        {/* Pie - Payment Distribution */}
        <ChartCard title="Payment Distribution" icon={<CreditCard size={18} />}>
          <ResponsiveContainer width="100%" height={280}>
            <PieChart>
              <Pie
                data={pieData}
                dataKey="value"
                nameKey="name"
                outerRadius={100}
                label
              >
                {pieData.map((_, i) => (
                  <Cell key={i} fill={COLORS[i % COLORS.length]} />
                ))}
              </Pie>
              <Tooltip />
              <Legend />
            </PieChart>
          </ResponsiveContainer>
        </ChartCard>
      </div>


      {/* Account Statement Table */}
      <div
        style={{
          background: "white",
          borderRadius: "12px",
          boxShadow: "0 2px 6px rgba(0,0,0,0.05)",
          marginTop: "2rem",
          padding: "1rem",
        }}
      >
        <h4 style={{ color: "#111827", marginBottom: "1rem", display: "flex", alignItems: "center", gap: 8 }}>
          <FileText size={18} /> Recent Account Statements
        </h4>

        {loading ? (
          <p style={{ color: "#9ca3af" }}>Loading statements...</p>
        ) : (
          <DataTable columns={columns} rows={filtered.slice(0, 8)} />
        )}
      </div>


      {/* Reconciliation Status */}
      <div style={{ marginTop: "2rem", display: "flex", gap: "1rem", flexWrap: "wrap" }}>
        <div
          style={{
            background: reconciliation.length ? "#fee2e2" : "#dcfce7",
            padding: "1rem",
            borderRadius: "12px",
            flex: 1,
            minWidth: "220px",
          }}
        >
          <h4 style={{ display: "flex", alignItems: "center", gap: 8 }}>
            <RefreshCcw size={18} /> Reconciliation Status
          </h4>
          <p style={{ display: "flex", alignItems: "center", gap: 8 }}>
            {reconciliation.length ? (
              <AlertCircle size={18} color="#dc2626" />
            ) : (
              <CheckCircle2 size={18} color="#16a34a" />
            )}
            {reconciliation.length
              ? `${reconciliation.length} invoice(s) pending`
              : "All accounts are reconciled"}
          </p>
        </div>
      </div>
    </div>
  );
}


// Reusable Summary Card Component
function SummaryCard({ icon, label, value }) {
  return (
    <div
      style={{
        background: "white",
        padding: "1rem",
        borderRadius: "12px",
        display: "flex",
        alignItems: "center",
        gap: "0.75rem",
        boxShadow: "0 2px 6px rgba(0,0,0,0.05)",
      }}
    >
      {icon}
      <div>
        <div style={{ fontSize: "0.9rem", color: "#6b7280" }}>{label}</div>
        <div style={{ fontWeight: 700 }}>{value}</div>
      </div>
    </div>
  );
}


// Reusable Chart Container
function ChartCard({ title, icon, children }) {
  return (
    <div
      style={{
        background: "white",
        padding: "1rem",
        borderRadius: "12px",
        boxShadow: "0 2px 6px rgba(0,0,0,0.05)",
      }}
    >
      <h4 style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: "1rem" }}>
        {icon} {title}
      </h4>
      {children}
    </div>
  );
}
</file>

<file path="src/pages/Reports.jsx">
// src/pages/reports/Reports.jsx
import React, { useState, useEffect, useContext } from "react";
import { Box, Typography, Button } from "@mui/material";
import { Download } from "@mui/icons-material";
import { AuthContext } from "../context/AuthContext";
import FiltersBar from "../pages/reports/FiltersBar";
import RegionalSalesSummary from "../pages/reports/RegionalSalesSummary";
import AdminSummary from "../pages/reports/AdminSummary";
import DealerPerformance from "../pages/reports/DealerPerformance";
import TerritorySummary from "../pages/reports/TerritorySummary";
import DealerTable from "../pages/reports/DealerTable";
import ChartsBlock from "../pages/reports/ChartsBlock";
import KPISection from "../pages/reports/KPISection";
//import PendingApprovals from "../pages/reports/PendingApprovals";
//import DealerReport from "../pages/reports/DealerReport";
import AccountStatement from "../pages/reports/AccountStatementReport";
import InvoiceRegister from "../pages/reports/InvoiceRegister";
import CreditDebitNotes from "../pages/reports/CreditDebitNotes";
import OutstandingReceivables from "../pages/reports/OutstandingReceivables";
import PendingApprovals from "../pages/reports/PendingApprovals";

import api from "../services/api";

const REPORT_OPTIONS_BY_ROLE = {
  dealer: [
    { value: "dealer-performance", label: "Dealer Performance" },
    { value: "account-statement", label: "Account Statement" },
    { value: "invoice-register", label: "Invoice Register" },
    { value: "credit-debit-notes", label: "Credit / Debit Notes" },
    { value: "outstanding-receivables", label: "Outstanding Receivables" },
  ],
  tm: [
    { value: "regional-sales-summary", label: "Regional Sales Summary" },
    { value: "territory", label: "Territory / Region Summary" },
    { value: "pending-approvals", label: "Pending Approvals" },
  ],
  am: [
    { value: "regional-sales-summary", label: "Regional Sales Summary" },
    { value: "territory", label: "Area-Wise Summary" },
    { value: "pending-approvals", label: "Pending Approvals" },
  ],
  admin: [
    { value: "admin-summary", label: "Admin Summary" },
    { value: "regional-sales-summary", label: "Regional Sales Summary" },
    { value: "territory", label: "Regional Sales Summary" },
    { value: "pending-approvals", label: "Pending Approvals" },
    { value: "dealer-performance", label: "Dealer Performance" }
  ],
};

export default function Reports() {
  const { user } = useContext(AuthContext);
  const role = user?.role || "dealer";

  const [reportType, setReportType] = useState("");
  const [filters, setFilters] = useState({
    region: "",
    territory: "",
    dealerId: "",
    startDate: "",
    endDate: "",
  });

  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [exporting, setExporting] = useState(false);
  const [error, setError] = useState("");

  // choose sensible default
  useEffect(() => {
    if (role === "dealer") setReportType("dealer-performance");
    else if (role === "admin") setReportType("admin-summary");
    else setReportType("regional-sales-summary");
  }, [role]);

  const handleFiltersChange = (next) => setFilters((p) => ({ ...p, ...next }));

  const fetchReport = async (opts = {}) => {
    if (!reportType) return;
    setError("");
    setLoading(true);
    try {
      const params = new URLSearchParams({ ...filters, ...opts }).toString();
      const res = await api.get(`/reports/${reportType}${params ? `?${params}` : ""}`);
      setData(res.data);
    } catch (err) {
      console.error("fetchReport:", err);
      setError("Failed to fetch report. See console.");
      setData(null);
    } finally {
      setLoading(false);
    }
  };

  const exportReport = async (format = "pdf") => {
    if (!reportType) return;
    setExporting(true);
    try {
      const params = new URLSearchParams({ ...filters, format }).toString();
      const res = await api.get(`/reports/${reportType}?${params}`, { responseType: "blob" });
      const blob = new Blob([res.data], { type: format === "pdf" ? "application/pdf" : "application/vnd.ms-excel" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${reportType}.${format}`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    } catch (err) {
      console.error("exportReport:", err);
      setError("Export failed. See console.");
    } finally {
      setExporting(false);
    }
  };

 const renderCurrentReport = () => {
  const commonProps = { data, loading, error, fetchReport, filters, role };

  switch (reportType) {
    /** ============================
     *  DEALER REPORTS
     * ============================*/
    case "dealer-performance":
      return <DealerPerformance {...commonProps} />;

    case "account-statement":
      return <AccountStatement {...commonProps} />;

    case "invoice-register":
      return <InvoiceRegister {...commonProps} />;

    case "credit-debit-notes":
      return <CreditDebitNotes {...commonProps} />;

    case "outstanding-receivables":
      return <OutstandingReceivables {...commonProps} />;

    /** ============================
     *  MANAGER / TM / AM REPORTS
     * ============================*/
    case "regional-sales-summary":
      return <RegionalSalesSummary {...commonProps} />;

    case "territory":
      return <TerritorySummary {...commonProps} />;

    case "pending-approvals":
  return <PendingApprovals {...commonProps} />;


    /** ============================
     *  ADMIN REPORTS
     * ============================*/
    case "admin-summary":
      return <AdminSummary {...commonProps} />;

    /** ============================
     *  FALLBACK
     * ============================*/
    default:
      return (
        <div style={{ marginTop: 24 }}>
          Select a report and click Generate.
        </div>
      );
  }
};

  return (
    <Box sx={{ p: 3 }}>
      <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 2, mb: 2 }}>
        <Box>
          <Typography variant="h5" sx={{ fontWeight: 700 }}>
            Reports Dashboard
          </Typography>
          <Typography variant="body2" color="text.secondary">
            Role: {role?.toUpperCase()} ‚Äî choose a report and apply filters
          </Typography>
        </Box>

        <Box sx={{ display: "flex", gap: 1, alignItems: "center" }}>
          <FiltersBar
            reportOptions={REPORT_OPTIONS_BY_ROLE[role] || REPORT_OPTIONS_BY_ROLE["admin"]}
            reportType={reportType}
            setReportType={setReportType}
            filters={filters}
            onFiltersChange={handleFiltersChange}
            onGenerate={() => fetchReport()}
            loading={loading}
          />

          <Button variant="outlined" startIcon={<Download />} onClick={() => exportReport("pdf")} disabled={exporting}>
            PDF
          </Button>
          <Button variant="outlined" startIcon={<Download />} onClick={() => exportReport("excel")} disabled={exporting}>
            Excel
          </Button>
        </Box>
      </Box>

      {renderCurrentReport()}
    </Box>
  );
}
</file>

<file path="src/pages/dashboards/AdminDashboard.jsx">
// src/pages/dashboard/AdminDashboard.jsx
import React, { useEffect, useState, useContext } from "react";
import api from "../../services/api";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";

import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import Toolbar from "../../components/Toolbar";
import SearchInput from "../../components/SearchInput";
import IconPillButton from "../../components/IconPillButton";

import { AuthContext } from "../../context/AuthContext";

// Lucide Icons
import {
  Plus,
  Puzzle,
  Users,
  Clock,
  Ban,
  Megaphone,
  Wallet,
  TrendingUp,
  Check,
  X,
} from "lucide-react";

import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from "recharts";

import "./DashboardLayout.css";

export default function AdminDashboard() {
  const navigate = useNavigate();
  const { user } = useContext(AuthContext);

  const [summary, setSummary] = useState({});
  const [approvals, setApprovals] = useState([]);
  const [campaigns, setCampaigns] = useState([]);
  const [dealerActivity, setDealerActivity] = useState([]);
  const [pricing, setPricing] = useState({ approved: 0, pending: 0, rejected: 0 });
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");

  // üåà Same visual identity as Accounts Dashboard
  const roleTheme = {
    admin: { color: "#8b5cf6", bg: "#f5f3ff" },
    accounts: { color: "#22c55e", bg: "#f0fdf4" },
    manager: { color: "#f59e0b", bg: "#fff7ed" },
    dealer: { color: "#3b82f6", bg: "#eff6ff" },
  };
  const theme = roleTheme[user?.role] || { color: "#6b7280", bg: "#f9fafb" };

  useEffect(() => {
    const load = async () => {
      try {
        setLoading(true);

        // Performance Data
        const perfRes = await api.get("/reports/dealer-performance");
        let perfData = Array.isArray(perfRes.data)
          ? perfRes.data
          : perfRes.data?.dealers || [];

        const dealersCount = perfData.length;
        const totalSales = perfData.reduce((sum, d) => sum + (d.totalSales || 0), 0);

        // Campaigns
        const campRes = await api.get("/campaigns");
        const allCampaigns = campRes.data.campaigns || campRes.data || [];

        // Pending Documents
        const docsRes = await api.get("/documents");
        const pendingDocs = docsRes.data.documents || [];

        // Pricing summary
        let pricingRes;
        try {
          pricingRes = await api.get("/pricing/summary");
        } catch {
          pricingRes = { data: { approved: 0, pending: 0, rejected: 0 } };
        }

        setPricing(pricingRes.data);

        // Dealer Activity ‚Äî Last 6 Months
        const monthly = {};
        perfData.forEach((dealer) => {
          const date = dealer.updatedAt || dealer.createdAt || new Date();
          const month = new Date(date).toLocaleString("default", { month: "short" });

          if (!monthly[month]) {
            monthly[month] = { month, dealersOnboarded: 0, blocked: 0, totalSales: 0 };
          }
          monthly[month].dealersOnboarded += 1;
          monthly[month].totalSales += dealer.totalSales || 0;
          if (dealer.status === "blocked") monthly[month].blocked += 1;
        });

        const now = new Date();
        const last6 = [];
        for (let i = 5; i >= 0; i--) {
          const d = new Date(now);
          d.setMonth(now.getMonth() - i);
          const m = d.toLocaleString("default", { month: "short" });
          last6.push({
            month: m,
            dealersOnboarded: monthly[m]?.dealersOnboarded || 0,
            blocked: monthly[m]?.blocked || 0,
            totalSales: monthly[m]?.totalSales || 0,
          });
        }

        setDealerActivity(last6);
        setApprovals(pendingDocs);
        setCampaigns(allCampaigns);

        const avgMonthlySales =
          last6.reduce((s, m) => s + m.totalSales, 0) / last6.length || 0;

        setSummary({
          dealers: dealersCount,
          totalSales,
          avgMonthlySales: Math.round(avgMonthlySales),
          pendingApprovals: pendingDocs.length,
          activeCampaigns: allCampaigns.length,
          blockedDealers: last6.reduce((s, m) => s + m.blocked, 0),
        });
      } catch (err) {
        console.error(err);
        toast.error("Failed to load admin dashboard");
      } finally {
        setLoading(false);
      }
    };

    load();
  }, []);

  if (loading)
    return (
      <div className="center text-center" style={{ height: "70vh" }}>
        Loading Admin Dashboard‚Ä¶
      </div>
    );

  return (
    <div style={{ padding: "1rem", background: theme.bg }}>
      <PageHeader
        title="Admin Dashboard"
        subtitle="Full insight into dealer performance, approvals, and campaigns"
      />

      {/* FILTER + ACTIONS BAR */}
      <Toolbar
        left={[
          <SearchInput
            key="search"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search dealers or campaigns..."
          />,
        ]}
        right={[
          <IconPillButton
            key="camp"
            icon={<Plus size={18} />}
            label="Campaigns"
            onClick={() => navigate("/campaigns")}
          />,
          <IconPillButton
            key="manage"
            icon={<Puzzle size={18} />}
            tone="warning"
            label="Manage Dealers"
            onClick={() => navigate("/admin")}
          />,
        ]}
      />

      {/* KPI CARDS */}
      <div className="stat-grid">
        <StatCard title="Total Dealers" value={summary.dealers} icon={<Users />} />
        <StatCard
          title="Pending Approvals"
          value={summary.pendingApprovals}
          icon={<Clock />}
        />
        <StatCard
          title="Blocked Dealers"
          value={summary.blockedDealers}
          icon={<Ban />}
        />
        <StatCard
          title="Active Campaigns"
          value={summary.activeCampaigns}
          icon={<Megaphone />}
        />
        <StatCard
          title="Avg Monthly Sales"
          value={`‚Çπ${summary.avgMonthlySales?.toLocaleString()}`}
          icon={<TrendingUp />}
        />
      </div>

      {/* MAIN GRID */}
      <div className="dashboard-grid">
        {/* LEFT COLUMN */}
        <div className="column">
          <Card title="Dealer Activity (Last 6 Months)">
            <ResponsiveContainer width="100%" height={320}>
              <BarChart data={dealerActivity}>
                <CartesianGrid strokeDasharray="3 3" stroke="#ddd" />
                <XAxis dataKey="month" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="dealersOnboarded" fill={theme.color} name="Onboarded" />
                <Bar dataKey="blocked" fill="#ef4444" name="Blocked" />
                <Bar dataKey="totalSales" fill="#f59e0b" name="Sales" />
              </BarChart>
            </ResponsiveContainer>
          </Card>

          <div className="stat-grid">
            <Card title="Market Demand" compact>
              <h2>{summary.activeCampaigns}</h2>
              <p className="text-muted small">Active campaigns</p>
            </Card>

            <Card title="New Dealers" compact>
              <h2>{summary.dealers}</h2>
              <p className="text-muted small">Recently onboarded</p>
            </Card>
          </div>
        </div>

        {/* RIGHT COLUMN */}
        <div className="column">
          <Card title="Pricing Distribution">
            <ResponsiveContainer width="100%" height={200}>
              <BarChart
                data={[
                  { name: "Approved", value: pricing.approved },
                  { name: "Pending", value: pricing.pending },
                  { name: "Rejected", value: pricing.rejected },
                ]}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#ddd" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="value" fill={theme.color} radius={[4, 4, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>

            <button
              className="btn-primary"
              style={{ marginTop: "1rem" }}
              onClick={() => navigate("/pricing-approvals")}
            >
              View Pricing Requests
            </button>
          </Card>

          <Card title="Pending Approvals">
            {approvals.slice(0, 4).length ? (
              approvals.slice(0, 4).map((a) => (
                <div
                  key={a.id}
                  className="approval-item"
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    borderBottom: "1px solid #eee",
                    padding: "0.6rem 0",
                  }}
                >
                  <div>
                    <strong>{a.dealerName}</strong>
                    <div className="text-muted small">{a.documentType}</div>
                  </div>

                  <div style={{ display: "flex", gap: 8 }}>
                    <button className="btn-success">
                      <Check size={16} />
                    </button>
                    <button className="btn-danger">
                      <X size={16} />
                    </button>
                  </div>
                </div>
              ))
            ) : (
              <p className="text-muted">No pending approvals</p>
            )}
          </Card>

          <Card title="Active Campaigns">
            {campaigns.slice(0, 4).map((c) => (
              <div
                key={c.id}
                style={{
                  cursor: "pointer",
                  borderBottom: "1px solid #eee",
                  padding: "0.6rem 0",
                }}
                onClick={() => navigate(`/campaigns/${c.id}`)}
              >
                <strong style={{ color: theme.color }}>
                  {c.title || c.campaignName}
                </strong>
                <p className="text-muted small">{c.description}</p>
              </div>
            ))}
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/InventoryDashboard.jsx">
import React, { useEffect, useState, useContext } from "react";
import api from "../../services/api";
import { AuthContext } from "../../context/AuthContext";

import PageHeader from "../../components/PageHeader";
import Toolbar from "../../components/Toolbar";
import SearchInput from "../../components/SearchInput";
import IconPillButton from "../../components/IconPillButton";
import DataTable from "../../components/DataTable";
import { toast } from "react-toastify";

import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  PieChart,
  Pie,
  Cell,
  ResponsiveContainer,
  Legend,
} from "recharts";

import {
  FileDown,
  FileSpreadsheet,
  Plus,
  Package,
  Factory,
  AlertTriangle,
  ListChecks,
} from "lucide-react";

export default function InventoryDashboard() {
  const { user } = useContext(AuthContext);

  const [inventory, setInventory] = useState([]);
  const [summary, setSummary] = useState({});
  const [search, setSearch] = useState("");
  const [loading, setLoading] = useState(true);

  // Themes per role
  const roleTheme = {
    dealer: { color: "#3b82f6", bg: "#eff6ff" },
    manager: { color: "#f59e0b", bg: "#fff7ed" },
    inventory: { color: "#22c55e", bg: "#f0fdf4" },
    admin: { color: "#8b5cf6", bg: "#f5f3ff" },
  };

  const theme = roleTheme[user?.role] || { color: "#6b7280", bg: "#f9fafb" };

  const COLORS = ["#22c55e", "#3b82f6", "#f59e0b", "#ef4444", "#8b5cf6"];

  // FETCH inventory
  const fetchInventory = async () => {
    try {
      setLoading(true);
      const res = await api.get("/inventory/summary");
      setInventory(res.data.inventory || []);
      setSummary(res.data.summary || {});
    } catch (err) {
      toast.error("Failed to load inventory data");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchInventory();
  }, []);

  // Export
  const handleExport = async (format) => {
    try {
      const response = await api.get(`/inventory/export?format=${format}`, {
        responseType: "blob",
      });

      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute(
        "download",
        `inventory_${new Date().toISOString().slice(0, 10)}.${
          format === "pdf" ? "pdf" : "xlsx"
        }`
      );
      document.body.appendChild(link);
      link.click();
    } catch (err) {
      toast.error("Export failed");
    }
  };

  // Add item
  const handleAddMockItem = async () => {
    try {
      const mock = {
        product: "New Product",
        available: Math.floor(Math.random() * 100),
        plant: "Chennai",
        reorderLevel: 10,
      };

      const res = await api.post("/inventory", mock);
      toast.success("Item added");
      setInventory((prev) => [...prev, res.data.item]);
    } catch (err) {
      toast.error("Failed to add item");
    }
  };

  // Delete item
  const handleDelete = async (id) => {
    try {
      await api.delete(`/inventory/${id}`);
      toast.success("Item deleted");
      setInventory((prev) => prev.filter((i) => i.id !== id));
    } catch (err) {
      toast.error("Failed to delete item");
    }
  };

  // Filter
  const filtered = inventory.filter((item) =>
    item.product.toLowerCase().includes(search.toLowerCase())
  );

  // Table Columns
  const columns = [
    { key: "product", label: "Product" },
    { key: "available", label: "Available" },

    (["manager", "inventory", "admin"].includes(user?.role)) && {
      key: "plant",
      label: "Plant",
    },

    (["inventory", "admin"].includes(user?.role)) && {
      key: "reorderLevel",
      label: "Reorder Level",
    },

    (["inventory", "admin"].includes(user?.role)) && {
      key: "updatedAt",
      label: "Last Updated",
    },

    (["inventory", "admin"].includes(user?.role)) && {
      key: "actions",
      label: "Actions",
      render: (_, row) => (
        <button
          onClick={() => handleDelete(row.id)}
          style={{
            border: "none",
            padding: "6px 10px",
            background: "#ef4444",
            color: "white",
            borderRadius: 6,
            cursor: "pointer",
          }}
        >
          Delete
        </button>
      ),
    },
  ].filter(Boolean);

  // Derived Data
  const lowStockCount = inventory.filter(
    (i) => i.reorderLevel && i.available < i.reorderLevel
  ).length;

  const plantWiseData = Object.values(
    inventory.reduce((acc, cur) => {
      if (!cur.plant) return acc;
      acc[cur.plant] = acc[cur.plant] || { name: cur.plant, total: 0 };
      acc[cur.plant].total += cur.available;
      return acc;
    }, {})
  );

  return (
    <div style={{ padding: "1rem", background: theme.bg, minHeight: "100vh" }}>
      <PageHeader
        title="Inventory Dashboard"
        subtitle={`Live stock monitoring ‚Äî role: ${user?.role?.toUpperCase()}`}
        actions={[
          (user?.role !== "dealer") && (
            <IconPillButton
              key="pdf"
              label="Export PDF"
              icon={<FileDown size={16} />}
              onClick={() => handleExport("pdf")}
            />
          ),
          (user?.role !== "dealer") && (
            <IconPillButton
              key="excel"
              label="Export Excel"
              icon={<FileSpreadsheet size={16} />}
              tone="success"
              onClick={() => handleExport("excel")}
            />
          ),
          (["inventory", "admin"].includes(user?.role)) && (
            <IconPillButton
              key="add"
              label="Add Item"
              icon={<Plus size={16} />}
              tone="warning"
              onClick={handleAddMockItem}
            />
          ),
        ].filter(Boolean)}
      />

      <div
        style={{
          background: theme.color,
          color: "white",
          padding: "0.6rem 1rem",
          borderRadius: 10,
          display: "inline-block",
          marginBottom: "1rem",
        }}
      >
        Logged in as <strong>{user?.role?.toUpperCase()}</strong>
      </div>

      <Toolbar>
        <SearchInput
          placeholder="Search product..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
        />
      </Toolbar>

      {/* Charts Section */}
      {!loading && inventory.length > 0 && (
        <div
          style={{
            display: "grid",
            gridTemplateColumns: "2fr 1fr",
            gap: "1.5rem",
            marginTop: "2rem",
          }}
        >
          {/* Product Stock Levels */}
          <div
            style={{
              background: "white",
              padding: "1rem",
              borderRadius: "12px",
              boxShadow: "0 2px 8px rgba(0,0,0,0.05)",
            }}
          >
            <h4 style={{ marginBottom: "1rem", color: "#111827" }}>
              <Package size={18} style={{ marginRight: 6 }} />
              Stock Levels by Product
            </h4>

            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={inventory}>
                <XAxis dataKey="product" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Bar dataKey="available" fill={theme.color} name="Available" />
                {(["inventory", "admin"].includes(user?.role)) && (
                  <Bar dataKey="reorderLevel" fill="#f97316" name="Reorder Level" />
                )}
              </BarChart>
            </ResponsiveContainer>
          </div>

          {/* Plant Distribution */}
          {user?.role !== "dealer" && (
            <div
              style={{
                background: "white",
                padding: "1rem",
                borderRadius: "12px",
                boxShadow: "0 2px 8px rgba(0,0,0,0.05)",
              }}
            >
              <h4 style={{ marginBottom: "1rem", color: "#111827" }}>
                <Factory size={18} style={{ marginRight: 6 }} />
                Stock by Plant
              </h4>

              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={plantWiseData}
                    dataKey="total"
                    nameKey="name"
                    outerRadius={100}
                    label
                  >
                    {plantWiseData.map((_, i) => (
                      <Cell key={i} fill={COLORS[i % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </div>
          )}
        </div>
      )}

      {/* Table */}
      <div style={{ marginTop: "2rem" }}>
        {loading ? (
          <p style={{ color: "#9ca3af" }}>Loading inventory...</p>
        ) : (
          <DataTable columns={columns} rows={filtered} />
        )}
      </div>

      {/* Summary Cards */}
      <div
        style={{
          marginTop: "2rem",
          display: "flex",
          flexWrap: "wrap",
          gap: "1rem",
        }}
      >
        <div
          style={{
            background: "white",
            padding: "1rem",
            borderRadius: "12px",
            flex: 1,
            minWidth: "220px",
          }}
        >
          <h4 style={{ color: theme.color, display: "flex", alignItems: "center", gap: 8 }}>
            <ListChecks size={18} /> Summary
          </h4>
          <p>Total Dealers: {summary.totalDealers}</p>
          <p>Active Campaigns: {summary.activeCampaigns}</p>
          <p>Total Invoices: {summary.totalInvoices}</p>
        </div>

        <div
          style={{
            background: lowStockCount > 0 ? "#fee2e2" : "#dcfce7",
            padding: "1rem",
            borderRadius: "12px",
            flex: 1,
            minWidth: "220px",
          }}
        >
          <h4 style={{ display: "flex", alignItems: "center", gap: 8 }}>
            <AlertTriangle size={18} /> Low Stock Items
          </h4>
          <p>
            {lowStockCount > 0
              ? `${lowStockCount} product(s) below reorder level`
              : "All stocks are healthy"}
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/dashboards/ManagerDashboard.jsx">
// src/pages/dashboards/ManagerDashboard.jsx
import React, { useEffect, useState, useCallback } from "react";
import api from "../../services/api";
import socket from "../../services/socket";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";

import PageHeader from "../../components/PageHeader";
import StatCard from "../../components/StatCard";
import Card from "../../components/Card";
import DataTable from "../../components/DataTable";
import Toolbar from "../../components/Toolbar";
import SearchInput from "../../components/SearchInput";
import IconPillButton from "../../components/IconPillButton";

import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  PieChart,
  Pie,
  Cell,
} from "recharts";

import {
  Users,
  Clock,
  FileText,
  BarChart2,
  Activity,
  Megaphone,
  MessageSquare,
  CheckCircle,
  XCircle,
  ArrowRightCircle,
} from "lucide-react";

import "./ManagerDashboard.css";

/**
 * ManagerDashboard
 * - Clean, defensive, and visually improved manager dashboard
 * - Uses lucide-react icons instead of emojis
 * - Handles realtime socket updates and cleans them up
 * - Avoids rendering objects directly (formats table cells)
 */

const COLORS = ["#3b82f6", "#60a5fa", "#2563eb", "#1d4ed8", "#93c5fd"];
const ACCENT = "#3b82f6";

export default function ManagerDashboard() {
  const navigate = useNavigate();

  const [summary, setSummary] = useState({});
  const [dealerPerformance, setDealerPerformance] = useState([]);
  const [pendingApprovals, setPendingApprovals] = useState([]);
  const [messages, setMessages] = useState([]);
  const [campaigns, setCampaigns] = useState([]);
  const [inventory, setInventory] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");

  // Safely extract numbers
  const safeNum = (v) => (typeof v === "number" ? v : Number(v) || 0);

  // Fetch initial data
  const loadData = useCallback(async () => {
    setLoading(true);
    try {
      const [
        summaryRes,
        dealersRes,
        pricingRes,
        msgRes,
        campRes,
        invRes,
      ] = await Promise.all([
        api.get("/managers/summary").catch(() => ({ data: {} })),
        api.get("/managers/dealers").catch(() => ({ data: { dealers: [] } })),
        api.get("/managers/pricing?status=pending").catch(() => ({ data: { updates: [] } })),
        api.get("/messages").catch(() => ({ data: { messages: [] } })),
        api.get("/campaigns").catch(() => ({ data: { campaigns: [] } })),
        api.get("/inventory/summary").catch(() => ({ data: { inventory: [] } })),
      ]);

      setSummary(summaryRes.data || {});
      setDealerPerformance(dealersRes.data.dealers || []);
      setPendingApprovals(pricingRes.data.updates || []);
      setMessages(msgRes.data.messages || msgRes.data || []);
      setCampaigns(campRes.data.campaigns || campRes.data || []);
      setInventory(invRes.data.inventory || invRes.data || []);
    } catch (err) {
      console.error("Manager dashboard load error:", err);
      toast.error("Failed to load dashboard data");
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadData();
  }, [loadData]);

  // Socket realtime updates
  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) socket.auth = { token };
    socket.connect();

    const onDocumentNew = (data) => {
      toast.info(`New document uploaded by dealer ${data.dealerId || ""}`);
      setPendingApprovals((prev) => [
        {
          id: data.id || Date.now(),
          dealer: data.dealerName || `Dealer ${data.dealerId}`,
          documentType: data.documentType || "Document",
          createdAt: data.createdAt || new Date().toISOString(),
          status: data.status || "pending",
        },
        ...prev,
      ]);
    };

    const onMessageNew = (msg) => {
      toast.success("New message received");
      setMessages((prev) => [msg, ...prev]);
    };

    const onCampaignNew = (campaign) => {
      toast.info(`New campaign: ${campaign.title || "Untitled"}`);
      setCampaigns((prev) => [campaign, ...prev]);
    };

    socket.on("document:new", onDocumentNew);
    socket.on("message:new", onMessageNew);
    socket.on("campaign:new", onCampaignNew);

    return () => {
      socket.off("document:new", onDocumentNew);
      socket.off("message:new", onMessageNew);
      socket.off("campaign:new", onCampaignNew);
      try {
        socket.disconnect();
      } catch (e) {
        /* ignore */
      }
    };
  }, []);

  // Simple derived metrics
  const lowStock = inventory.filter((i) => safeNum(i.available) < 20);
  const mediumStock = inventory.filter((i) => {
    const a = safeNum(i.available);
    return a >= 20 && a < 100;
  });
  const highStock = inventory.filter((i) => safeNum(i.available) >= 100);

  // Pricing action (approve/reject/forward)
  const handlePricingAction = async (id, action) => {
    try {
      const remarks = window.prompt(`Remarks for ${action.toUpperCase()} (optional):`) || "";
      await api.patch(`/managers/pricing/${id}/forward`, { action, remarks });
      toast.success(`Pricing ${action}ed`);
      setPendingApprovals((prev) => prev.filter((p) => p.id !== id));
      const s = await api.get("/managers/summary").catch(() => ({ data: {} }));
      setSummary(s.data || {});
    } catch (err) {
      console.error("Pricing action failed:", err);
      toast.error("Failed to process pricing action");
    }
  };

  // Table safe render helpers
  const fmtCurrency = (v) => `‚Çπ ${safeNum(v).toLocaleString()}`;
  const fmtDate = (iso) => {
    if (!iso) return "‚Äî";
    try {
      return new Date(iso).toLocaleString("en-IN", { day: "2-digit", month: "short", year: "numeric" });
    } catch {
      return iso;
    }
  };

  // Prepare pending pricing table rows (defensive)
  const pendingPricingRows = (pendingApprovals || [])
    .filter(Boolean)
    .filter((p) => {
      const q = search.trim().toLowerCase();
      if (!q) return true;
      const hay = `${p.dealer?.businessName || p.dealer || ""} ${p.product?.name || p.productId || ""} ${p.requestedBy || ""}`.toLowerCase();
      return hay.includes(q);
    })
    .slice(0, 12)
    .map((a) => ({
      id: a.id,
      dealer: a.dealer?.businessName || a.dealer || "‚Äî",
      product: a.product?.name || a.productId || "‚Äî",
      newPrice: fmtCurrency(a.newPrice),
      requestedBy: a.requestedBy || "‚Äî",
      requestedAt: fmtDate(a.createdAt),
      status: (a.status || "pending").toString(),
      actions: (
        <div style={{ display: "flex", gap: 8 }}>
          <button
            onClick={() => handlePricingAction(a.id, "approve")}
            className="btn btn-success"
            title="Approve"
          >
            <CheckCircle size={16} />
          </button>
          <button
            onClick={() => handlePricingAction(a.id, "reject")}
            className="btn btn-danger"
            title="Reject"
          >
            <XCircle size={16} />
          </button>
          <button
            onClick={() => handlePricingAction(a.id, "forward")}
            className="btn btn-primary"
            title="Forward to Admin"
          >
            <ArrowRightCircle size={16} />
          </button>
        </div>
      ),
    }));

  if (loading) {
    return (
      <div className="loading-screen">
        <div className="loading-text">Loading Manager Dashboard...</div>
      </div>
    );
  }

  return (
    <div className="manager-dashboard" style={{ color: "var(--text-color)" }}>
      <PageHeader
        title="Regional Manager Dashboard"
        subtitle="Monitor dealers, campaigns and inventory in one place"
        actions={[
          <IconPillButton
            key="reports"
            icon={<BarChart2 size={16} />}
            label="Reports"
            onClick={() => navigate("/reports")}
          />,
          <IconPillButton
            key="campaigns"
            icon={<Megaphone size={16} />}
            label="Campaigns"
            tone="warning"
            onClick={() => navigate("/campaigns")}
          />,
          <IconPillButton
            key="chat"
            icon={<MessageSquare size={16} />}
            label="Messages"
            tone="info"
            onClick={() => navigate("/manager/chat")}
          />,
        ]}
      />

      <Toolbar
        left={[
          <SearchInput
            key="search"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search dealers, products, requests..."
          />,
        ]}
        right={[
          <div key="quick" style={{ display: "flex", gap: 8 }}>
            <IconPillButton icon={<Users size={16} />} label="My Dealers" onClick={() => navigate("/manager/dealers")} />
          </div>,
        ]}
      />

      <div className="dashboard-grid">
        <div className="left-col">
          <div className="kpi-row">
            <StatCard title="Total Dealers" value={summary.totalDealers || 0} icon={<Users size={20} />} />
            <StatCard title="Pending Pricing" value={summary.pendingPricing || 0} icon={<Activity size={20} />} />
            <StatCard title="Pending Documents" value={summary.pendingDocuments || 0} icon={<FileText size={20} />} />
            <StatCard title="Recent Sales" value={fmtCurrency(summary.recentSales || 0)} icon={<BarChart2 size={20} />} />
          </div>

          {lowStock.length > 0 && (
            <div className="alert-banner" style={{ background: "#fee2e2", color: "#b91c1c" }}>
              <Clock size={16} style={{ marginRight: 8 }} />
              {lowStock.length} products are critically low on stock
            </div>
          )}

          <Card title="Stock Health Overview" style={{ marginBottom: 16 }}>
            {inventory.length ? (
              <div style={{ display: "flex", justifyContent: "space-around", textAlign: "center" }}>
                <div>
                  <h3 style={{ color: "#ef4444" }}>{lowStock.length}</h3>
                  <p className="text-muted">Low</p>
                </div>
                <div>
                  <h3 style={{ color: "#facc15" }}>{mediumStock.length}</h3>
                  <p className="text-muted">Moderate</p>
                </div>
                <div>
                  <h3 style={{ color: "#10b981" }}>{highStock.length}</h3>
                  <p className="text-muted">Healthy</p>
                </div>
              </div>
            ) : (
              <p className="text-muted">No inventory data available</p>
            )}
          </Card>

          <Card title="Top 5 Dealers (Sales)">
            <ResponsiveContainer width="100%" height={340}>
              <BarChart
                data={(dealerPerformance || []).slice(0, 5).map((d) => ({
                  businessName: d.businessName || d.dealerName || "Unknown",
                  totalSales: safeNum(d.totalSales),
                }))}
                margin={{ top: 10, right: 20, left: 0, bottom: 20 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis dataKey="businessName" stroke="#6b7280" />
                <YAxis stroke="#6b7280" />
                <Tooltip formatter={(v) => fmtCurrency(v)} />
                <Legend />
                <Bar dataKey="totalSales" fill={ACCENT} radius={[8, 8, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </Card>

          <Card title="Pending Pricing Approvals" style={{ marginTop: 16 }}>
            <DataTable
              columns={[
                { key: "dealer", label: "Dealer" },
                { key: "product", label: "Product" },
                { key: "newPrice", label: "Requested Price" },
                { key: "requestedBy", label: "Requested By" },
                { key: "requestedAt", label: "Requested At" },
                { key: "status", label: "Status" },
                { key: "actions", label: "Actions" },
              ]}
              rows={pendingPricingRows}
              emptyMessage="No pending pricing requests"
            />
          </Card>
        </div>

        <aside className="right-col">
          <div className="side-kpis">
            <div className="mini-kpi">
              <div className="mini-kpi-title">Total Outstanding</div>
              <div className="mini-kpi-value">{fmtCurrency(summary.totalOutstanding || 0)}</div>
            </div>
            <div className="mini-kpi">
              <div className="mini-kpi-title">Dealers Managed</div>
              <div className="mini-kpi-value">{summary.totalDealers || 0}</div>
            </div>
            <div className="mini-kpi">
              <div className="mini-kpi-title">Pending Docs</div>
              <div className="mini-kpi-value">{summary.pendingDocuments || 0}</div>
            </div>
            <div className="mini-kpi">
              <div className="mini-kpi-title">Pending Pricing</div>
              <div className="mini-kpi-value">{summary.pendingPricing || 0}</div>
            </div>
          </div>

          <Card title="Active Campaigns" className="side-card" style={{ marginTop: 12 }}>
            <div style={{ maxHeight: 220, overflowY: "auto" }}>
              {campaigns.length ? (
                campaigns.slice(0, 6).map((c) => (
                  <div
                    key={c.id || `${c.title}-${Math.random()}`}
                    className="campaign-preview"
                    onClick={() => navigate(`/campaigns/${c.id}`)}
                    role="button"
                    tabIndex={0}
                  >
                    <div style={{ fontWeight: 700, color: ACCENT }}>{c.title || c.campaignName}</div>
                    <div className="text-muted" style={{ fontSize: 13 }}>{c.description}</div>
                  </div>
                ))
              ) : (
                <p className="text-muted">No campaigns running</p>
              )}
            </div>
          </Card>

          <Card title="Recent Messages" className="side-card" style={{ marginTop: 12 }}>
            <div style={{ maxHeight: 220, overflowY: "auto" }}>
              {messages.length ? (
                messages.slice(0, 6).map((m) => (
                  <div key={m.id || Math.random()} style={{ padding: 8, borderBottom: "1px solid #eee" }}>
                    <div style={{ fontWeight: 600 }}>{m.fromName || m.username || "Dealer"}</div>
                    <div className="text-muted small">{(m.content || m.text || "").slice(0, 80)}</div>
                    <div className="text-muted small">{fmtDate(m.createdAt || m.timestamp)}</div>
                  </div>
                ))
              ) : (
                <p className="text-muted">No recent messages</p>
              )}
            </div>
          </Card>

          <Card title="Stock Distribution" className="side-card" style={{ marginTop: 12 }}>
            {inventory.length ? (
              <ResponsiveContainer width="100%" height={180}>
                <PieChart>
                  <Pie
                    data={inventory.slice(0, 6).map((it) => ({ name: it.product || it.sku || "Item", value: safeNum(it.available) }))}
                    dataKey="value"
                    nameKey="name"
                    outerRadius={70}
                    innerRadius={30}
                    label
                  >
                    {inventory.slice(0, 6).map((_, i) => (
                      <Cell key={i} fill={COLORS[i % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip formatter={(v) => `${v} units`} />
                </PieChart>
              </ResponsiveContainer>
            ) : (
              <p className="text-muted">No inventory to show</p>
            )}
          </Card>
        </aside>
      </div>
    </div>
  );
}
</file>

<file path="src/services/api.js">
import axios from "axios";

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL || "http://localhost:3000/api",
  withCredentials: true,
});

// ====== INTERCEPTORS (keep as is) ======
api.interceptors.request.use((config) => {
  const noAuthNeeded = [
    "/auth/login",
    "/auth/verify-otp",
    "/auth/reset-password",
    "/auth/reset-password-confirm",
  ];

  if (!noAuthNeeded.some((path) => config.url.includes(path))) {
    const token = localStorage.getItem("token");
    if (token) config.headers.Authorization = `Bearer ${token}`;
  }

  return config;
});

api.interceptors.response.use(
  (res) => res,
  (err) => {
    const originalUrl = err.config?.url || "";

    const safeRoutes = ["/auth/login", "/auth/verify-otp"];
    const isSafe = safeRoutes.some((path) => originalUrl.includes(path));

    if (err.response?.status === 401 && !isSafe) {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.history.pushState({}, "", "/login");
    }

    return Promise.reject(err);
  }
);

// =======================================================================
// ======================= MATERIAL MASTER APIs ===========================
// =======================================================================

export const materialAPI = {
  getMaterials: () => api.get("/materials").then((r) => r.data),
  getMaterialGroups: () => api.get("/material-groups").then((r) => r.data),

  createMaterial: (payload) =>
    api.post("/materials", payload).then((r) => r.data),

  updateMaterial: (id, payload) =>
    api.patch(`/materials/${id}`, payload).then((r) => r.data),

  deleteMaterial: (id) =>
    api.delete(`/materials/${id}`).then((r) => r.data),
  


};

// =======================================================================
// ======================== ORDER FLOW APIs (FIXED) =======================
// =======================================================================

export const orderAPI = {
  // Dealer creates order
  createOrder: (payload) =>
    api.post("/orders", payload).then((r) => r.data),

  // Dealer views own orders
  getMyOrders: () =>
    api.get("/orders/my", { params: { mine: true } }).then((r) => r.data),

  // Admin/Manager view all orders
  getAllOrders: (params) =>
    api.get("/orders", { params }).then((r) => r.data),

  // Admin/Manager update status
  updateOrderStatus: (id, status) =>
    api.patch(`/orders/${id}/status`, { status }).then((r) => r.data),

  // Admin approves order
  approveOrder: (id) =>
    api.patch(`/orders/${id}/approve`).then((r) => r.data),

  // Admin rejects order
  rejectOrder: (id, reason) =>
    api.patch(`/orders/${id}/reject`, { reason }).then((r) => r.data),
};



// =======================================================================
// ======================= NOTIFICATIONS APIs =============================
// =======================================================================

export const notificationAPI = {
  getNotifications: () =>
    api.get("/notifications").then((r) => r.data),

  markNotificationRead: (id) =>
    api.patch(`/notifications/${id}/read`).then((r) => r.data),
};
/* =======================================================================
   INVOICE / PAYMENT APIs
   ======================================================================= */

export const invoiceAPI = {
  // Create invoice (dealer_staff may call with { orderId } ‚Äî backend derives other fields)
  createInvoice: (payload) => api.post('/invoices', payload).then((r) => r.data),

  // Get invoices (list) - supports query params
  getInvoices: (params) => api.get('/invoices', { params }).then((r) => r.data),

  // Get single invoice by id
  getInvoiceById: (id) => api.get(`/invoices/${id}`).then((r) => r.data),

  // Update invoice (admin / key_user)
  updateInvoice: (id, payload) => api.put(`/invoices/${id}`, payload).then((r) => r.data),

  // Download invoice PDF ‚Äî returns ArrayBuffer blob
  downloadInvoicePDF: (id) =>
    api
      .get(`/invoices/${id}/pdf`, { responseType: 'arraybuffer' })
      .then((r) => r.data),
};
// Default export for compatibility
export default api;

// ======================= CHAT APIs (resilient mark-read) =================
export const chatAPI = {
  // Try several endpoint variants to mark a conversation as read.
  // Some backends expose different paths or use POST instead of PATCH.
  // We attempt likely candidates and ignore 404s.
  markRead: async (partnerId) => {
    const candidates = [
      // Prefer the backend's declared route: PATCH /api/chat/:partnerId/read
      { method: "patch", url: `/chat/${partnerId}/read` },

      // original chat endpoints (fallbacks)
      { method: "patch", url: `/chat/mark-read/${partnerId}` },
      { method: "post", url: `/chat/mark-read/${partnerId}` },
      { method: "post", url: `/chat/${partnerId}/read` },
      { method: "patch", url: `/chat/read/${partnerId}` },
      { method: "post", url: `/chat/read/${partnerId}` },

      // messages-based endpoints (used elsewhere in repo)
      { method: "patch", url: `/messages/mark-read/${partnerId}` },
      { method: "post", url: `/messages/mark-read/${partnerId}` },
      { method: "patch", url: `/messages/${partnerId}/read` },
      { method: "post", url: `/messages/${partnerId}/read` },
      { method: "patch", url: `/messages/read/${partnerId}` },
      { method: "post", url: `/messages/read/${partnerId}` },

      // conversation-based endpoints
      { method: "patch", url: `/conversations/${partnerId}/read` },
      { method: "post", url: `/conversations/${partnerId}/read` },
      { method: "patch", url: `/conversations/mark-read/${partnerId}` },
      { method: "post", url: `/conversations/mark-read/${partnerId}` },

      // query param variants
      { method: "patch", url: `/chat/mark-read?partnerId=${partnerId}` },
      { method: "post", url: `/chat/mark-read?partnerId=${partnerId}` },

      // snake_case variants
      { method: "patch", url: `/chat/mark_as_read/${partnerId}` },
      { method: "post", url: `/chat/mark_as_read/${partnerId}` },
    ];

    let lastErr = null;
    for (const c of candidates) {
      try {
        const res = await api[c.method](c.url);
        // helpful debug: which candidate succeeded
        console.debug(`[chatAPI.markRead] succeeded: ${c.method.toUpperCase()} ${c.url}`);
        return res.data;
      } catch (err) {
        lastErr = err;
        if (err.response && err.response.status === 404) continue;
      }
    }

    return Promise.reject(lastErr || new Error("Failed to mark chat read"));
  },
};
</file>

<file path="package.json">
{
  "name": "dealer-portal-react",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@emotion/react": "^11.14.0",
    "@emotion/styled": "^11.14.1",
    "@hugeicons/react": "^1.1.1",
    "@mui/icons-material": "^7.3.5",
    "@mui/material": "^7.3.4",
    "axios": "^1.13.2",
    "framer-motion": "^12.23.24",
    "leaflet": "^1.9.4",
    "leaflet.heat": "^0.2.0",
    "lucide-react": "^0.552.0",
    "react": "^19.1.1",
    "react-apexcharts": "^1.8.0",
    "react-countup": "^6.5.3",
    "react-dom": "^19.1.1",
    "react-hook-form": "^7.65.0",
    "react-icons": "^5.5.0",
    "react-leaflet": "^5.0.0",
    "react-router-dom": "^7.9.5",
    "react-toastify": "^11.0.5",
    "recharts": "^3.3.0",
    "socket.io-client": "^4.8.1"
  },
  "devDependencies": {
    "@eslint/js": "^9.36.0",
    "@types/react": "^19.1.16",
    "@types/react-dom": "^19.1.9",
    "@vitejs/plugin-react": "^5.0.4",
    "autoprefixer": "^10.4.21",
    "babel-plugin-react-compiler": "^19.1.0-rc.3",
    "eslint": "^9.36.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.22",
    "globals": "^16.4.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.16",
    "vite": "^7.1.7"
  }
}
</file>

<file path="src/pages/dashboards/DealerDashboard.jsx">
// src/pages/dashboard/DealerDashboard.jsx
import React, { useEffect, useState } from "react";
import api from "../../services/api";
import socket from "../../services/socket";
import { toast } from "react-toastify";
import Card from "../../components/Card";
import StatCard from "../../components/StatCard";
import Toolbar from "../../components/Toolbar";
import SearchInput from "../../components/SearchInput";
import IconPillButton from "../../components/IconPillButton";
import PricingRequestModal from "../../components/PricingRequestModal";
import { useNavigate } from "react-router-dom";

import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
  PieChart,
  Pie,
  Cell,
} from "recharts";
import {
  MessageSquare,
  UploadCloud,
  Gift,
  DollarSign,
  FileText,
  AlertCircle,
  Box,
  Tag,
  Phone,
} from "lucide-react";

import "./DashboardLayout.css";

export default function DealerDashboard() {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [summary, setSummary] = useState({});
  const [invoices, setInvoices] = useState([]);
  const [promotions, setPromotions] = useState([]);
  const [documents, setDocuments] = useState([]);
  const [docFilter, setDocFilter] = useState("all");
  const [trend, setTrend] = useState([]);
  const [inventory, setInventory] = useState([]);
  const [pricingStats, setPricingStats] = useState([]);
  const [showPriceModal, setShowPriceModal] = useState(false);

  const COLORS = ["#3b82f6", "#60a5fa", "#2563eb", "#1d4ed8", "#93c5fd"];
  const accent = "#3b82f6";

  // ================= FETCH INITIAL DATA =================
  useEffect(() => {
    let mounted = true;
    const fetchData = async () => {
      try {
        setLoading(true);
        const [
          summaryRes,
          invoiceRes,
          promoRes,
          docRes,
          trendRes,
          inventoryRes,
        ] = await Promise.all([
          api.get("/reports/dealer-performance"),
          api.get("/invoices"),
          api.get("/campaigns/active"),
          api.get("/documents"),
          api.get("/reports/dealer-performance?trend=true"),
          api.get("/inventory/summary"),
        ]);

        if (!mounted) return;

        setSummary(summaryRes.data || {});
        setInvoices(invoiceRes.data?.invoices || []);
        setPromotions(promoRes.data || []);
        setDocuments(docRes.data?.documents || []);
        setTrend(trendRes.data?.trend || []);
        setInventory(inventoryRes.data?.inventory || []);

        // Extract pricing distribution from summary (defensive)
        const pb = summaryRes.data?.pricingBreakdown;
        if (pb) {
          setPricingStats([
            { name: "Approved", value: Number(pb.approved || 0) },
            { name: "Pending", value: Number(pb.pending || 0) },
            { name: "Rejected", value: Number(pb.rejected || 0) },
          ]);
        } else {
          setPricingStats([]);
        }
      } catch (err) {
        console.error("Dealer dashboard error:", err);
        toast.error("Failed to load dealer dashboard (see console).");
      } finally {
        if (mounted) setLoading(false);
      }
    };

    fetchData();
    return () => {
      mounted = false;
    };
  }, []);

  // ================= SOCKET REAL-TIME UPDATES =================
  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) socket.auth = { token };
    socket.connect();

    socket.on("promotion:new", (promo) => {
      toast.success(`New promotion: ${promo.title}`);
      setPromotions((prev) => [promo, ...prev]);
    });

    socket.on("document:update", (doc) => {
      toast.info(`Document "${doc.fileName}" ${doc.status}`);
      setDocuments((prev) => {
        const exists = prev.find((d) => d.id === doc.id);
        if (exists) {
          return prev.map((d) => (d.id === doc.id ? { ...d, status: doc.status } : d));
        } else {
          return [doc, ...prev];
        }
      });
    });

    return () => {
      socket.off("promotion:new");
      socket.off("document:update");
      socket.disconnect();
    };
  }, []);

  if (loading)
    return (
      <div className="center text-center" style={{ height: "80vh" }}>
        Loading Dealer Dashboard...
      </div>
    );

  // ================= FILTERED DOCUMENTS =================
  const filteredDocs = (documents || []).filter((d) =>
    docFilter === "all" ? true : (d.status || "").toLowerCase() === docFilter.toLowerCase()
  );

  return (
    <div className="dashboard-container" style={{ background: "#f9fafb" }}>
      {/* HEADER */}
      <header className="dashboard-header">
        <h1>Dealer Dashboard</h1>
        <p>
          Welcome back,{" "}
          <span style={{ color: accent, fontWeight: 600 }}>
            {summary.dealerName || "Dealer"}
          </span>
        </p>
      </header>

      {/* TOOLBAR */}
      <Toolbar
        left={[
          <SearchInput
            key="search"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search invoices or documents..."
          />,
        ]}
        right={[
          <IconPillButton
            key="chat"
            icon={<MessageSquare size={16} />}
            label="Chat with Manager"
            tone="info"
            onClick={() => navigate("/dealer/chat")}
          />,
          <IconPillButton
            key="upload"
            icon={<UploadCloud size={16} />}
            label="Upload"
            onClick={() => navigate("/documents/upload")}
          />,
          <IconPillButton
            key="promo"
            icon={<Gift size={16} />}
            label="Promotions"
            tone="warning"
            onClick={() => navigate("/promotions")}
          />,
          <IconPillButton
            key="pricing"
            icon={<DollarSign size={16} />}
            label="Request Price Change"
            onClick={() => setShowPriceModal(true)}
          />,
        ]}
      />

      {/* KPI SUMMARY */}
      <div className="stat-grid">
        <StatCard
          title="Total Sales"
          value={`‚Çπ${Number(summary.totalSales || 0).toLocaleString()}`}
          icon={<DollarSign />}
        />
        <StatCard
          title="Invoices"
          value={Number(summary.totalInvoices || 0)}
          icon={<FileText />}
        />
        <StatCard
          title="Outstanding"
          value={`‚Çπ${Number(summary.outstanding || 0).toLocaleString()}`}
          icon={<AlertCircle />}
        />
        <StatCard
          title="Promotions"
          value={promotions?.length || 0}
          icon={<Tag />}
        />
      </div>

      {/* MAIN GRID */}
      <div className="dashboard-grid">
        {/* LEFT COLUMN */}
        <div className="column">
          {/* Sales Trend */}
          <Card title="Sales vs Outstanding (Last 6 Months)" className="chart-card">
            <div style={{ width: "100%", height: 340 }}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={trend || []}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                  <XAxis dataKey="month" stroke="#6b7280" />
                  <YAxis stroke="#6b7280" />
                  <Tooltip
                    contentStyle={{
                      background: "#fff",
                      border: "1px solid #e5e7eb",
                      color: "#111827",
                    }}
                    formatter={(value, name) =>
                      name === "sales"
                        ? [`‚Çπ${Number(value || 0).toLocaleString()}`, "Sales"]
                        : [`‚Çπ${Number(value || 0).toLocaleString()}`, "Outstanding"]
                    }
                  />
                  <Legend />
                  <Bar dataKey="sales" fill={accent} barSize={12} radius={[4, 4, 0, 0]} />
                  <Bar dataKey="outstanding" fill="#93c5fd" barSize={12} radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </Card>

          {/* Inventory */}
          <Card title="Stock Availability">
            {Array.isArray(inventory) && inventory.length > 0 ? (
              <div style={{ width: "100%", height: 250 }}>
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={inventory}
                      dataKey="available"
                      nameKey="product"
                      outerRadius={90}
                      label
                    >
                      {inventory.map((_, i) => (
                        <Cell key={i} fill={COLORS[i % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip
                      formatter={(v, name) => [v, name]}
                    />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            ) : (
              <p className="text-muted">No inventory data available</p>
            )}
          </Card>

          {/* Invoices */}
          <Card title="Recent Invoices">
            {Array.isArray(invoices) && invoices.length ? (
              <table className="custom-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>‚Çπ</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {invoices.slice(0, 6).map((i) => (
                    <tr key={i.id}>
                      <td>{i.invoiceNumber}</td>
                      <td>{i.invoiceDate ? new Date(i.invoiceDate).toLocaleDateString() : "-"}</td>
                      <td>{Number(i.totalAmount || 0).toLocaleString()}</td>
                      <td className={i.status === "Paid" ? "status-approved" : "status-pending"}>
                        {i.status || "Unknown"}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            ) : (
              <p className="text-muted">No invoices found</p>
            )}
          </Card>

          {/* Documents */}
          <Card title="Documents">
            <div style={{ display: "flex", gap: "0.5rem", marginBottom: "0.8rem" }}>
              {["all", "pending", "approved", "rejected"].map((status) => (
                <button
                  key={status}
                  onClick={() => setDocFilter(status)}
                  style={{
                    padding: "0.35rem 0.9rem",
                    borderRadius: "6px",
                    border: docFilter === status ? `2px solid ${accent}` : "1px solid #ccc",
                    background: docFilter === status ? "#bfdbfe" : "#fff",
                    cursor: "pointer",
                    fontWeight: docFilter === status ? 600 : 500,
                  }}
                >
                  {status.charAt(0).toUpperCase() + status.slice(1)}
                </button>
              ))}
            </div>

            {filteredDocs.length ? (
              <table className="custom-table">
                <thead>
                  <tr>
                    <th>File</th>
                    <th>Status</th>
                    <th>Uploaded At</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredDocs.map((d) => (
                    <tr key={d.id}>
                      <td>{d.fileName}</td>
                      <td className={`status-${(d.status || "pending").toLowerCase()}`}>
                        {d.status || "pending"}
                      </td>
                      <td>{d.createdAt ? new Date(d.createdAt).toLocaleDateString() : "-"}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            ) : (
              <p className="text-muted">No documents found.</p>
            )}
          </Card>
        </div>

        {/* RIGHT COLUMN */}
        <div className="column">
          {/* Pricing Distribution */}
          <Card title="Pricing Request Distribution">
            {Array.isArray(pricingStats) && pricingStats.length ? (
              <div style={{ width: "100%", height: 250 }}>
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie data={pricingStats} dataKey="value" nameKey="name" outerRadius={90} label>
                      {pricingStats.map((_, i) => (
                        <Cell key={i} fill={COLORS[i % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip formatter={(v) => [v, "count"]} />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            ) : (
              <p className="text-muted">No pricing data available.</p>
            )}
          </Card>

          {/* Active Promotions */}
          <Card title="Active Promotions">
            {Array.isArray(promotions) && promotions.length ? (
              promotions.slice(0, 5).map((promo) => (
                <div
                  key={promo.id}
                  style={{
                    padding: "0.45rem 0",
                    borderBottom: "1px solid #e5e7eb",
                  }}
                >
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <strong style={{ color: accent }}>{promo.title}</strong>
                    <small className="text-muted">
                      {promo.validTill ? new Date(promo.validTill).toLocaleDateString() : ""}
                    </small>
                  </div>
                  <p className="text-muted" style={{ margin: "4px 0 0" }}>
                    {promo.description}
                  </p>
                </div>
              ))
            ) : (
              <p className="text-muted">No active promotions</p>
            )}
          </Card>

          <div style={{ display: "flex", gap: 8, marginTop: 8, flexWrap: "wrap" }}>
            <IconPillButton icon={<UploadCloud />} label="Upload" />
            <IconPillButton icon={<FileText />} label="Statements" />
            <IconPillButton icon={<Phone />} label="Contact" tone="success" onClick={() => navigate("/support")} />
          </div>
        </div>
      </div>

      <PricingRequestModal open={showPriceModal} onClose={() => setShowPriceModal(false)} />
    </div>
  );
}
</file>

<file path="src/App.jsx">
import React from "react";
import { BrowserRouter, Routes, Route } from "react-router-dom";
import { AuthProvider } from "./context/AuthContext";

// üîê Auth
import ProtectedRoute from "./components/ProtectedRoute";
import Layout from "./components/Layout";

// üîë Public
import Login from "./pages/Login";

// üß≠ Dashboards
import Dashboard from "./pages/Dashboard";
import InventoryDashboard from "./pages/dashboards/InventoryDashboard";
import AccountsDashboard from "./pages/dashboards/AccountsDashboard";

// üìÑ Common Pages
import Invoices from "./pages/Invoices";
import Documents from "./pages/Documents";
import Campaigns from "./pages/Campaigns";
import Reports from "./pages/Reports";
import CreatePaymentRequest from "./pages/payments/CreatePaymentRequest";

import DealerAdminPayments from "./pages/payments/DealerAdminPayments";
import FinancePendingPayments from "./pages/payments/FinancePendingPayments";


// üõ† Admin & Config
import Admin from "./pages/Admin";
import AdminDocuments from "./pages/AdminDocuments";
import PricingApprovals from "./pages/PricingApprovals";

// üíº Accounts subpages
import AccountsInvoices from "./pages/accounts/AccountsInvoices";
import AccountsNotes from "./pages/accounts/AccountsNotes";
import AccountsReports from "./pages/accounts/AccountsReports";

// üí¨ Chat
import ManagerChat from "./pages/ManagerChat";
import DealerChat from "./pages/DealerChat";

// üÜï Super Admin CRUD pages (you will build these)
import Users from "./pages/superadmin/Users";
import Roles from "./pages/superadmin/Roles";
import TechnicalAdmin from "./pages/technicaladmin/TechnicalAdmin";
import AdminOrders from "./pages/orders/AdminOrders";
import CreateOrder from "./pages/orders/CreateOrders";
import MyOrders from "./pages/orders/MyOrders";
import Materials from "./pages/Materials";
import ChatUI from "./pages/ChatUI";
import MaterialImport from "./pages/Materials/MaterialImport";
import MaterialAnalytics from "./pages/Materials/MaterialAnalytics";
import MaterialAlerts from "./pages/Alerts/MaterialAlerts";

import RegionMap from "./pages/maps/RegionMaps";


export default function App() {
  return (
    <AuthProvider>
      <BrowserRouter>
        <Routes>

          {/* ================= PUBLIC ROUTES ================= */}
          <Route path="/login" element={<Login />} />
          <Route
  path="chat"
  element={
    <ProtectedRoute allowed={[
      "super_admin",
      "dealer_admin",
      "dealer_staff",
      "regional_manager",
      "area_manager",
      "territory_manager",
      "technical_admin",
      "finance_admin",
      "inventory_user",
      "accounts_user",
      "regional_admin"
    ]}>
      <ChatUI />
    </ProtectedRoute>
  }
/>



          {/* ================= PROTECTED LAYOUT (Navbar + Sidebar) ================= */}
          <Route
            path="/"
            element={
              <ProtectedRoute>
                <Layout />
              </ProtectedRoute>
            }
          >

            {/* ================= DEFAULT ================= */}
            <Route index element={<Dashboard />} />
            <Route path="dashboard" element={<Dashboard />} />

             {/* ============================================================
   REGION & TERRITORY MAP VIEW
============================================================ */}
<Route
  path="map-view"
  element={
    <ProtectedRoute
      allowed={[
        "super_admin",
        "regional_manager",
        "area_manager",
        "territory_manager",
        "dealer_admin",
        "technical_admin",
        "regional_admin"
      ]}
    >
      <RegionMap />
    </ProtectedRoute>
  }
/>

            {/* ============================================================
               SUPER ADMIN ONLY
            ============================================================ */}
            <Route
              path="users"
              element={
                <ProtectedRoute allowed={["super_admin"]}>
                  <Users />
                </ProtectedRoute>
              }
            />

            <Route
              path="roles"
              element={
                <ProtectedRoute allowed={["super_admin"]}>
                  <Roles />
                </ProtectedRoute>
              }
            />

            <Route
              path="documents"
              element={
                <ProtectedRoute allowed={["super_admin"]}>
                  <Documents />
                </ProtectedRoute>
              }
            />

            <Route
              path="pricing"
              element={
                <ProtectedRoute allowed={["super_admin"]}>
                  <PricingApprovals />
                </ProtectedRoute>
              }
            />

            <Route
              path="inventory"
              element={
                <ProtectedRoute allowed={["super_admin"]}>
                  <InventoryDashboard />
                </ProtectedRoute>
              }
            />

            <Route
              path="accounts"
              element={
                <ProtectedRoute allowed={["super_admin"]}>
                  <AccountsDashboard />
                </ProtectedRoute>
              }
            />


            {/* ============================================================
               TECHNICAL ADMIN
            ============================================================ */}
            <Route
              path="technical-admin"
              element={
                <ProtectedRoute allowed={["technical_admin"]}>
                  <TechnicalAdmin />
                </ProtectedRoute>
              }
            />
            <Route
  path="materials"
  element={
    <ProtectedRoute allowed={["technical_admin", "super_admin"]}>
      <Materials />
    </ProtectedRoute>
  }
/>

            <Route
              path="materials/import"
              element={
                <ProtectedRoute allowed={["technical_admin", "super_admin"]}>
                  <MaterialImport />
                </ProtectedRoute>
              }
            />

            <Route
              path="materials/analytics"
              element={
                <ProtectedRoute allowed={["technical_admin", "super_admin"]}>
                  <MaterialAnalytics />
                </ProtectedRoute>
              }
            />

            <Route
              path="alerts/materials"
              element={
                <ProtectedRoute allowed={["technical_admin", "super_admin", "inventory_user"]}>
                  <MaterialAlerts />
                </ProtectedRoute>
              }
            />


            {/* ============================================================
               REGIONAL ADMIN
            ============================================================ */}
            <Route
              path="dealers"
              element={
                <ProtectedRoute allowed={["regional_admin"]}>
                  <Admin />
                </ProtectedRoute>
              }
            />

            <Route
              path="regions"
              element={
                <ProtectedRoute allowed={["regional_admin"]}>
                  <AdminDocuments />
                </ProtectedRoute>
              }
            />


            {/* ============================================================
               FINANCE ADMIN
            ============================================================ */}
            <Route
              path="invoices"
              element={
                <ProtectedRoute allowed={["finance_admin"]}>
                  <Invoices />
                </ProtectedRoute>
              }
            />

            <Route
              path="accounts"
              element={
                <ProtectedRoute allowed={["finance_admin"]}>
                  <AccountsDashboard />
                </ProtectedRoute>
              }
            />
<Route
  path="payments/finance/pending"
  element={
    <ProtectedRoute allowed={["finance_admin"]}>
      <FinancePendingPayments />
    </ProtectedRoute>
  }
/>


            {/* ============================================================
               REGIONAL MANAGER
            ============================================================ */}
            <Route
              path="approvals"
              element={
                <ProtectedRoute allowed={["regional_manager"]}>
                  <PricingApprovals />
                </ProtectedRoute>
              }
            />

            <Route
              path="dealers"
              element={
                <ProtectedRoute allowed={["regional_manager"]}>
                  <Admin />
                </ProtectedRoute>
              }
            />


            {/* ============================================================
               AREA MANAGER
            ============================================================ */}
            <Route
              path="dealers"
              element={
                <ProtectedRoute allowed={["area_manager"]}>
                  <Admin />
                </ProtectedRoute>
              }
            />


            {/* ============================================================
               TERRITORY MANAGER
            ============================================================ */}
            <Route
              path="dealers"
              element={
                <ProtectedRoute allowed={["territory_manager"]}>
                  <Admin />
                </ProtectedRoute>
              }
            />


            {/* ============================================================
               DEALER ADMIN
            ============================================================ */}
            <Route
              path="documents"
              element={
                <ProtectedRoute allowed={["dealer_admin"]}>
                  <Documents />
                </ProtectedRoute>
              }
            />

            <Route
              path="campaigns"
              element={
                <ProtectedRoute allowed={["dealer_admin"]}>
                  <Campaigns />
                </ProtectedRoute>
              }
            />

            <Route
              path="invoices"
              element={
                <ProtectedRoute allowed={["dealer_admin"]}>
                  <Invoices />
                </ProtectedRoute>
              }
            />

            <Route
              path="chat"
              element={
                <ProtectedRoute allowed={["dealer_admin"]}>
                  <DealerChat />
                </ProtectedRoute>
              }
            />
            <Route
  path="orders/approvals"
  element={
    <ProtectedRoute allowed={["dealer_admin"]}>
      <AdminOrders />
    </ProtectedRoute>
  }
/>
<Route
  path="payments/dealer/pending"
  element={
    <ProtectedRoute allowed={["dealer_admin"]}>
      <DealerAdminPayments />
    </ProtectedRoute>
  }
/>


            {/* ============================================================
               DEALER STAFF
            ============================================================ */}
            <Route
              path="documents"
              element={
                <ProtectedRoute allowed={["dealer_staff"]}>
                  <Documents />
                </ProtectedRoute>
              }
            />
            <Route
  path="orders/create"
  element={
    <ProtectedRoute allowed={["dealer_staff"]}>
      <CreateOrder />
    </ProtectedRoute>
  }
/>

<Route
  path="orders/my"
  element={
    <ProtectedRoute allowed={["dealer_staff"]}>
      <MyOrders />
    </ProtectedRoute>
  }
/>
<Route
  path="payments/create/:invoiceId"
  element={
    <ProtectedRoute allowed={["dealer_staff"]}>
      <CreatePaymentRequest />
    </ProtectedRoute>
  }
/>




            {/* ============================================================
               INVENTORY USER
            ============================================================ */}
            <Route
              path="inventory"
              element={
                <ProtectedRoute allowed={["inventory_user"]}>
                  <InventoryDashboard />
                </ProtectedRoute>
              }
            />

            <Route
              path="pricing"
              element={
                <ProtectedRoute allowed={["inventory_user"]}>
                  <PricingApprovals />
                </ProtectedRoute>
              }
            />


            {/* ============================================================
               ACCOUNTS USER
            ============================================================ */}
            <Route
              path="accounts"
              element={
                <ProtectedRoute allowed={["accounts_user"]}>
                  <AccountsDashboard />
                </ProtectedRoute>
              }
            />

            <Route
              path="accounts/invoices"
              element={
                <ProtectedRoute allowed={["accounts_user"]}>
                  <AccountsInvoices />
                </ProtectedRoute>
              }
            />

            <Route
              path="accounts/notes"
              element={
                <ProtectedRoute allowed={["accounts_user"]}>
                  <AccountsNotes />
                </ProtectedRoute>
              }
            />

            <Route
              path="accounts/reports"
              element={
                <ProtectedRoute allowed={["accounts_user"]}>
                  <AccountsReports />
                </ProtectedRoute>
              }
            />


            {/* ============================================================
               CHAT ROUTES
            ============================================================ */}
            <Route
              path="manager/chat"
              element={
                <ProtectedRoute
                  allowed={[
                    "regional_manager",
                    "area_manager",
                    "territory_manager",
                  ]}
                >
                  <ManagerChat />
                </ProtectedRoute>
              }
            />

            <Route
              path="dealer/chat"
              element={
                <ProtectedRoute allowed={["dealer_admin", "dealer_staff"]}>
                  <DealerChat />
                </ProtectedRoute>
              }
            />

          </Route>
        </Routes>
      </BrowserRouter>
    </AuthProvider>
  );
}
</file>

<file path="src/components/Sidebar.jsx">
import React, { useContext, useState, useEffect } from "react";
import { AuthContext } from "../context/AuthContext";
import { Link, useLocation } from "react-router-dom";
import api from "../services/api";
import socket from "../services/socket";

import {
  FaHome,
  FaFileInvoice,
  FaFileAlt,
  FaChartBar,
  FaCogs,
  FaUsers,
  FaWarehouse,
  FaBars,
  FaBell,
  FaUpload,
} from "react-icons/fa";
import { FaMoneyCheckAlt } from "react-icons/fa";
import { FaMapMarkedAlt } from "react-icons/fa";

export default function Sidebar() {
  const { user } = useContext(AuthContext);
  const { pathname } = useLocation();

  const [collapsed, setCollapsed] = useState(false);
  const [unread, setUnread] = useState(0);

  const role = user?.role?.toLowerCase() || "user";

  // -------------------------
  // BASE MENU LINKS
  // -------------------------
  const baseLinks = [
    { path: "/dashboard", label: "Dashboard", icon: <FaHome /> },
    { path: "/chat", label: "Chat", icon: <FaUsers /> },
  ];

  // -------------------------
  // ROLE-BASED NAVIGATION
  // -------------------------
  const roleLinks = {
    super_admin: [
      { label: "Users", path: "/users", icon: <FaUsers /> },
      { label: "Roles & Permissions", path: "/roles", icon: <FaCogs /> },
      { label: "Documents", path: "/documents", icon: <FaFileAlt /> },
      { label: "Pricing", path: "/pricing", icon: <FaChartBar /> },
      { label: "Inventory", path: "/inventory", icon: <FaWarehouse /> },
      { label: "Accounts", path: "/accounts", icon: <FaFileInvoice /> },
      { label: "Materials", path: "/materials", icon: <FaWarehouse /> },
      { label: "Material Analytics", path: "/materials/analytics", icon: <FaChartBar /> },
      { label: "Material Import", path: "/materials/import", icon: <FaUpload /> },
      { label: "Material Alerts", path: "/alerts/materials", icon: <FaBell /> },

      // ‚≠ê NEW MAP VIEW
      { label: "Region Map", path: "/map-view", icon: <FaMapMarkedAlt /> },
    ],

    technical_admin: [
      { label: "Permissions", path: "/technical-admin", icon: <FaCogs /> },
      { label: "Material Master", path: "/materials", icon: <FaCogs /> },
      { label: "Material Import", path: "/materials/import", icon: <FaUpload /> },
      { label: "Material Analytics", path: "/materials/analytics", icon: <FaChartBar /> },

      // ‚≠ê NEW MAP VIEW
      { label: "Region Map", path: "/map-view", icon: <FaMapMarkedAlt /> },
    ],

    regional_admin: [
      { label: "Dealers", path: "/dealers", icon: <FaUsers /> },
      { label: "Regions", path: "/regions", icon: <FaChartBar /> },

      // ‚≠ê NEW MAP VIEW
      { label: "Map View", path: "/map-view", icon: <FaMapMarkedAlt /> },
    ],

    finance_admin: [
      { label: "Invoices", path: "/invoices", icon: <FaFileInvoice /> },
      {
        label: "Payment Approvals",
        path: "/payments/finance/pending",
        icon: <FaMoneyCheckAlt />,
      },
      { label: "Accounts", path: "/accounts", icon: <FaUsers /> },
    ],

    regional_manager: [
      { label: "Dealers", path: "/dealers", icon: <FaUsers /> },
      { label: "Approvals", path: "/approvals", icon: <FaChartBar /> },

      // ‚≠ê NEW MAP VIEW
      { label: "Map View", path: "/map-view", icon: <FaMapMarkedAlt /> },
    ],

    area_manager: [
      { label: "Dealers", path: "/dealers", icon: <FaUsers /> },

      // ‚≠ê NEW MAP VIEW
      { label: "Map View", path: "/map-view", icon: <FaMapMarkedAlt /> },
    ],

    territory_manager: [
      { label: "Dealers", path: "/dealers", icon: <FaUsers /> },

      // ‚≠ê NEW MAP VIEW
      { label: "Map View", path: "/map-view", icon: <FaMapMarkedAlt /> },
    ],

    dealer_admin: [
      { label: "My Documents", path: "/documents", icon: <FaFileAlt /> },
      { label: "Campaigns", path: "/campaigns", icon: <FaChartBar /> },
      { label: "Invoices", path: "/invoices", icon: <FaFileInvoice /> },
      {
        label: "Order Approvals",
        path: "/orders/approvals",
        icon: <FaChartBar />,
      },
      {
        label: "Payment Approvals",
        path: "/payments/dealer/pending",
        icon: <FaMoneyCheckAlt />,
      },

      // ‚≠ê NEW MAP VIEW
      { label: "Region Map", path: "/map-view", icon: <FaMapMarkedAlt /> },
    ],

    dealer_staff: [
      { label: "My Documents", path: "/documents", icon: <FaFileAlt /> },
      { label: "Create Order", path: "/orders/create", icon: <FaChartBar /> },
      { label: "My Orders", path: "/orders/my", icon: <FaChartBar /> },
      { label: "Make Payment", path: "/payments/create", icon: <FaMoneyCheckAlt /> },
    ],

    inventory_user: [
      { label: "Inventory", path: "/inventory", icon: <FaWarehouse /> },
      { label: "Pricing Updates", path: "/pricing", icon: <FaChartBar /> },
      { label: "Material Alerts", path: "/alerts/materials", icon: <FaBell /> },

      // ‚≠ê NEW MAP VIEW (optional)
      { label: "Region Map", path: "/map-view", icon: <FaMapMarkedAlt /> },
    ],

    accounts_user: [
      { label: "Invoices", path: "/invoices", icon: <FaFileInvoice /> },
      { label: "Statements", path: "/statements", icon: <FaFileAlt /> },
    ],
  };

  const links = [...baseLinks, ...(roleLinks[role] || [])];

  // -------------------------
  // UNREAD BADGE LOGIC
  // -------------------------
  useEffect(() => {
    let mounted = true;

    const loadUnread = async () => {
      try {
        const res = await api.get("/chat/unread-count");
        const count = res.data.count || res.data.unread || 0;

        if (mounted) setUnread(count);
      } catch (err) {
        console.log("Unread fetch error:", err);
      }
    };

    loadUnread();

    socket.on("message:new", () => {
      if (pathname !== "/chat") {
        setUnread((v) => v + 1);
      }
    });

    socket.on("chat:read", () => {
      if (mounted) setUnread(0);
    });

    return () => {
      mounted = false;
      socket.off("message:new");
      socket.off("chat:read");
    };
  }, [pathname]);

  return (
    <aside
      style={{
        width: collapsed ? "70px" : "240px",
        background: "var(--sidebar-bg)",
        backdropFilter: "blur(14px)",
        borderRight: "1px solid var(--card-border)",
        padding: "1rem",
        display: "flex",
        flexDirection: "column",
        transition: "width 0.3s ease",
        overflowY: "auto",
        overflowX: "hidden",
      }}
    >
      {/* HEADER */}
      <div
        style={{
          display: "flex",
          justifyContent: collapsed ? "center" : "space-between",
          alignItems: "center",
          marginBottom: "2rem",
          paddingBottom: "1rem",
          borderBottom: "1px solid var(--card-border)",
        }}
      >
        {!collapsed && (
          <h3 style={{ color: "#f97316", fontWeight: "700" }}>
            {role.toUpperCase()}
          </h3>
        )}

        <button
          onClick={() => setCollapsed(!collapsed)}
          style={{
            background: "var(--card-bg)",
            border: "1px solid var(--card-border)",
            borderRadius: "8px",
            padding: "0.5rem",
            cursor: "pointer",
            color: "var(--text-color)",
          }}
        >
          <FaBars />
        </button>
      </div>

      {/* NAV LINKS */}
      <div style={{ display: "flex", flexDirection: "column", gap: "0.5rem" }}>
        {links.map((l) => {
          const active = pathname === l.path;

          return (
            <div style={{ position: "relative" }} key={l.path}>
              <Link
                to={l.path}
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: collapsed ? "0" : "0.75rem",
                  padding: "0.75rem 1rem",
                  borderRadius: "10px",
                  color: active ? "#f97316" : "var(--text-color)",
                  textDecoration: "none",
                  background: active
                    ? "linear-gradient(90deg, rgba(249,115,22,0.25), rgba(249,115,22,0.1))"
                    : "transparent",
                  fontWeight: active ? "600" : "400",
                  transition: "0.25s ease",
                }}
              >
                <span style={{ fontSize: "1.3rem" }}>{l.icon}</span>

                {!collapsed && (
                  <span style={{ display: "flex", alignItems: "center", gap: "8px" }}>
                    <span>{l.label}</span>

                    {l.path === "/chat" && unread > 0 && (
                      <span
                        style={{
                          background: "#ef4444",
                          color: "white",
                          padding: "2px 8px",
                          borderRadius: 999,
                          fontSize: "12px",
                          fontWeight: 700,
                        }}
                      >
                        {unread > 99 ? "99+" : unread}
                      </span>
                    )}
                  </span>
                )}
              </Link>
            </div>
          );
        })}
      </div>
    </aside>
  );
}
</file>

</files>
